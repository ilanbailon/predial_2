<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Geoportal Predial</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --brand:#0f172a; --accent:#0ea5e9; --accent-dark:#0369a1;
      --panel-bg:#f8fafc; --card:#ffffff; --line:#e2e8f0;
      --predio:#0ea5e9; --comunidad:#22c55e; --otros:#a855f7; --highlight:#e11d48;
      --text:#0f172a;
      --resp-col-width:220px; --type-col-width:130px;

      --sat:#e0f2ff;
      --sun:#fee2e2;
      --comment-bg:#fef9c3;
      --comment-ring:#facc15;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;overflow:hidden;}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:10px 16px;background:var(--brand);color:#fff;position:relative;z-index:5000;
      box-shadow:0 2px 10px rgba(0,0,0,.25);
    }
    header .title{font-weight:700;letter-spacing:.3px}
    #centerControls{flex:1;display:flex;justify-content:center;position:relative}
    #searchWrap{position:relative;width:min(520px,90%)}
    #searchBox{
      width:100%;padding:10px 14px;border-radius:24px;border:none;outline:none;
      font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,.15) inset, 0 1px 0 rgba(255,255,255,.1);
      color:var(--text);
    }
    #suggestions{
      position:absolute;left:0;right:0;top:44px;background:#fff;
      border:1px solid var(--line);border-radius:10px;z-index:6000;
      max-height:240px;overflow:auto;display:none;color:var(--text);
    }
    #suggestions.active{display:block}
    #suggestions div{padding:8px 10px;cursor:pointer;color:var(--text)}
    #suggestions div:hover{background:#f1f5f9}

    #rightControls{display:flex;align-items:center;gap:8px}
    select,button{padding:8px 10px;border-radius:8px;border:1px solid transparent;font-size:14px}
    select{background:#fff;border-color:var(--line);color:var(--text)}
    .btn{background:var(--accent);color:#fff;cursor:pointer}
    .btn:hover{background:var(--accent-dark)}
    .ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.35)}
    .ghost:hover{border-color:#fff}

    #split{display:flex;height:calc(100% - 60px);min-height:300px}
    #leftPane{flex-basis:60%;position:relative;background:#000}
    #rightPane{flex:1;background:var(--panel-bg);border-left:1px solid var(--line);overflow:auto}
    #gutter{width:6px;cursor:col-resize;background:linear-gradient(90deg,transparent,rgba(0,0,0,.08),transparent)}
    #map{position:absolute;inset:0}

    .panel{padding:16px}
    h3{margin:8px 0 12px;color:var(--accent-dark)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .block{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .label{font-weight:700;margin-bottom:4px}
    .textblock{white-space:pre-line;background:#fff;border:1px solid var(--line);border-radius:8px;padding:8px;color:var(--text)}
    .area-card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:10px;margin:10px 0; transition: box-shadow .2s, background .2s}
    .area-card h4{margin:0 0 6px;color:#0ea5e9}
    .area-actions{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .pill:hover{border-color:var(--accent)}
    .muted{color:#64748b;font-size:12px}
    .badge{background:#eef2ff;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;color:#0f172a}
    input,textarea{width:100%;padding:6px;border:1px solid var(--line);border-radius:8px;color:#0f172a}
    .btn-small{padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn-small:hover{border-color:#0ea5e9}
    td.clickable{cursor:pointer;text-decoration:underline}

    /* ===== Drawer Reporte ===== */
    .drawer{
      position:fixed; top:60px; right:0;
      width:min(1100px,92vw); height:calc(100% - 60px);
      background:#fff; border-left:1px solid #e5e7eb; box-shadow:-12px 0 30px rgba(0,0,0,.15);
      transform:translateX(100%); transition:transform .25s ease; z-index:6000; overflow:auto;
    }
    .drawer.open{ transform:translateX(0); }
    .drawer-head{display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;padding:12px 16px;z-index:1}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px 16px}

    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #e2e8f0;border-radius:999px;background:#fff;cursor:pointer;margin-right:6px;margin-bottom:6px}
    .chip input{transform:scale(1.1)}
    .chip.active{background:#eef7ff;border-color:#bfdbfe}
    #rp_kpiHeader,#lr_kpiHeader{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin:8px 16px 16px}
    .kpi-card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:12px}
    .kpi-card h4{margin:0;font-size:14px;color:#1e293b;font-weight:700}
    .kpi-metrics{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .kpi-metric{background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:4px}
    .kpi-metric .m-label{font-size:12px;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
    .kpi-metric .m-val{font-size:24px;font-weight:800;color:#0f172a}
    .kpi-metric small{color:#64748b;font-size:11px}
    .kpi-leader-list{display:flex;flex-direction:column;gap:10px}

    .leader-item{display:flex;flex-direction:column;gap:6px;padding:10px;border:1px solid #e2e8f0;border-radius:10px;background:#f8fafc}
    .leader-head{display:flex;justify-content:space-between;align-items:center;font-size:14px;color:#0f172a;font-weight:600}
    .leader-head span:last-child{font-weight:700}
    .leader-meta{display:flex;flex-wrap:wrap;gap:8px;font-size:12px;color:#475569;align-items:center}
    .leader-meta .badge{background:#e0f2fe;border:1px solid #bae6fd;border-radius:999px;padding:2px 10px;font-size:12px;color:#0c4a6e}
    .leader-progress{width:100%;height:8px;background:#e2e8f0;border-radius:999px;overflow:hidden}
    .leader-progress span{display:block;height:100%;background:#0ea5e9;border-radius:999px 0 0 999px}

    table.report{border-collapse:collapse;width:auto;min-width:100%;margin:0}
    table.report th, table.report td{border:1px solid #e5e7eb;padding:6px 8px;text-align:center;vertical-align:top;background:#fff;position:relative}
    th.sticky{position:sticky;z-index:3;background:#f6f6f6}
    td.sticky{position:sticky;z-index:2;background:#fff}
    th.sticky.l1, td.sticky.l1 {
      left:0; min-width:var(--resp-col-width); width:var(--resp-col-width);
      text-align:left; background:#fff; z-index:5; box-shadow:2px 0 0 rgba(15,23,42,.05);
    }
    th.sticky.l2, td.sticky.l2 {
      left:var(--resp-col-width); min-width:var(--type-col-width); width:var(--type-col-width);
      text-align:left; background:#fff; z-index:4; box-shadow:1px 0 0 rgba(15,23,42,.04);
    }
    .type-cell{font-weight:600;color:#475569}
    .resp-cell{font-weight:700;font-size:15px;text-transform:capitalize;padding:0 12px}
    .ovr-input{width:62px;padding:4px 6px;border:1px solid #cbd5e1;border-radius:8px;text-align:center}
    #rp_tableWrap,#lr_tableWrap{overflow:auto;border:1px solid #eee;border-radius:10px;margin:0 16px 12px;background:#fff;positi
on:relative}

    .col-sat{ background:var(--sat) !important; }
    .col-sun{ background:var(--sun) !important; }
    .plan-zero{ background:transparent !important; }

    .comment-cell{background:var(--comment-bg) !important; box-shadow:inset 0 0 0 1px rgba(250,204,21,.5);}
    .comment-cell.comment-linked{box-shadow:inset 0 0 0 1px rgba(250,204,21,.35);}
    .comment-bajada{background:#e5e7eb !important; box-shadow:inset 0 0 0 1px rgba(148,163,184,.6);}
    .plan-cell{position:relative;display:flex;align-items:center;justify-content:center;gap:6px;padding-right:18px}
    .plan-cell.readonly{justify-content:flex-start}
    .plan-cell.readonly span{font-weight:600}
    .plan-cell.readonly .value{min-width:24px;text-align:center}
    .comment-pin{
      position:absolute;top:4px;right:4px;width:18px;height:18px;border-radius:999px;border:1px solid transparent;
      background:rgba(148,163,184,.12);color:#475569;font-size:11px;line-height:1;display:flex;align-items:center;justify-content:center;
      cursor:pointer;transition:transform .15s,background .15s,border-color .15s,color .15s;padding:0;
    }
    .comment-pin::before{content:"💬";transform:scale(.84);}
    .comment-pin:hover{transform:scale(1.08);}
    .comment-pin.empty{background:transparent;color:#94a3b8;}
    .comment-pin.has-comment{background:rgba(250,204,21,.24);border-color:rgba(250,204,21,.7);color:#92400e;}
    .comment-pin.bajada{background:#d1d5db;border-color:#94a3b8;color:#334155;}

    :root{ --today-bg:#f5f3ff; --today-ring:rgba(99,102,241,.45); --today-wash:rgba(99,102,241,.18); }
    .today-col{ position:relative; background:var(--today-bg) !important; box-shadow:inset 0 0 0 9999px var(--today-wash); }
    .today-col::after{ content:""; position:absolute; inset:-2px; border:2px solid var(--today-ring); border-radius:8px; pointer-events:none; }

    .comment-preview{
      margin:8px 0 10px;
      padding:8px 10px;
      background:var(--comment-bg);
      border:1px solid rgba(250,204,21,.5);
      border-radius:8px;
      color:#713f12;
      font-size:13px;
      line-height:1.45;
      box-shadow:0 4px 14px rgba(113,63,18,.08);
      white-space:pre-wrap;
    }
    .comment-preview .comment-title{display:block;font-size:12px;color:#92400e;font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px}
    .comment-preview.bajada{background:#e5e7eb;border-color:rgba(148,163,184,.7);color:#1f2937;box-shadow:0 4px 14px rgba(30,41,59,.08)}
    .comment-preview.bajada .comment-title{color:#1f2937}

    @media print{
      header,#split,#globalLoader,#commentPopover{display:none !important;}
      body{overflow:visible !important;-webkit-print-color-adjust:exact;print-color-adjust:exact;color-adjust:exact;}
      table.report th,table.report td{-webkit-print-color-adjust:exact;print-color-adjust:exact;color-adjust:exact;}
      .drawer{position:static !important;transform:none !important;width:auto !important;height:auto !important;box-shadow:none !important;border:none !important;}
      .drawer-head{position:static !important;}
      .print-hidden{display:none !important;}
    }

    /* ===== Global loader ===== */
    #globalLoader{
      position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:12px;background:rgba(15,23,42,.85);color:#fff;z-index:9000;font-size:16px;letter-spacing:.3px;
      transition:opacity .25s ease, visibility .25s ease;opacity:1;visibility:visible;
    }
    #globalLoader.hidden{opacity:0;visibility:hidden;}
    .loader-spinner{
      width:54px;height:54px;border-radius:50%;border:4px solid rgba(255,255,255,.25);
      border-top-color:#0ea5e9;animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg);}}
    .comment-popover{position:absolute;min-width:240px;max-width:280px;background:#fff;border:1px solid #cbd5e1;border-radius:12px;box-shadow:0 18px 40px rgba(15,23,42,.2);padding:12px;z-index:9000;display:none}
    .comment-popover.open{display:block}
    .comment-popover h5{margin:0 0 6px;font-size:13px;color:#334155;font-weight:700}
    .comment-popover textarea{width:100%;min-height:96px;border:1px solid #cbd5e1;border-radius:8px;padding:6px;font-family:inherit;resize:vertical;color:#0f172a}
    .comment-popover textarea:focus{outline:2px solid rgba(14,165,233,.35)}
    .comment-popover .comment-text{font-size:13px;color:#1f2937;white-space:pre-wrap;max-height:160px;overflow:auto}
    .comment-popover .actions{margin-top:10px;display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}
    .comment-popover .actions button{padding:6px 10px;border-radius:8px;border:1px solid #cbd5e1;background:#f8fafc;color:#1f2937;font-size:12px;cursor:pointer}
    .comment-popover .actions button.primary{background:#0ea5e9;border-color:#0284c7;color:#fff}
    .comment-popover .actions button.danger{background:#fee2e2;border-color:#fca5a5;color:#b91c1c}

    #chartWrap,#lr_chartWrap{margin:12px 16px 16px;border:1px solid #eee;border-radius:10px;padding:10px;background:#fff}
    #rp_detail,#lr_detail{margin:0 16px 16px;border:1px dashed #e5e7eb;border-radius:10px;padding:10px;background:#fafafa}
    #rp_detail .detail-sections,#lr_detail .detail-sections{display:flex;flex-direction:column;gap:12px}
    .detail-section{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:10px}
    .detail-section.active{border-color:rgba(14,165,233,.6);box-shadow:0 0 0 2px rgba(14,165,233,.08)}
    .detail-section h4{margin:0 0 8px;font-size:13px;color:#0f172a}
    .detail-section table{width:100%}
    .detail-section .muted{text-align:center}
    #rp_todaySummary,#lr_todaySummary{margin:0 16px 16px;border:1px solid #e5e7eb;border-radius:10px;padding:12px;background:#fff}
    #rp_todaySummary .today-sections,#lr_todaySummary .today-sections{display:flex;flex-direction:column;gap:12px}
    #rp_todaySummary .today-section h4,#lr_todaySummary .today-section h4{margin:0 0 8px;color:#0f172a}

    /* Modal base */
    .modal-back{ position:fixed; inset:60px 0 0 0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.25); z-index:7000; }
    .modal{ width:min(820px,92vw); background:#fff; border-radius:12px; padding:12px; box-shadow:0 20px 40px rgba(0,0,0,.25); }

    /* Modal EXPEDIENTES específico */
    #expModal .modal{ width:min(1100px,95vw); }
    #exp_table_wrap{ margin-top:8px; border:1px solid #eee; border-radius:10px; background:#fff; max-height:62vh; overflow:auto; }
    #exp_table th.sortable{ cursor:pointer; user-select:none; background:#f8fafc; }
    #exp_table th.sortable:hover{ background:#f1f5f9; }
    #exp_table td{ text-align:left; }
    #exp_table .cod-badges{ display:flex; flex-wrap:wrap; gap:6px; justify-content:flex-start; }
    #exp_table .cod-badges .badge{ display:inline-flex; align-items:center; justify-content:center; padding:4px 8px; border-radius:999px; border:1px solid #cbd5e1; background:#eef2ff; font-size:12px; color:#1e293b; white-space:nowrap; }
    #exp_counter{ margin-left:auto; font-size:12px; color:#475569; }

    /* Animación flash */
    @keyframes flash { 0%{box-shadow:0 0 0 rgba(14,165,233,0);background:#fff} 20%{box-shadow:0 0 0 6px rgba(14,165,233,.15);background:#e0f2fe} 100%{box-shadow:0 0 0 rgba(14,165,233,0);background:#fff} }
    .flash { animation: flash 1s ease-out 1; }

    /* ===== Fix columnas fijas reporte ===== */
    #rp_tableWrap,#lr_tableWrap{ position:relative; overflow:auto; }
    table.report{ border-collapse:separate; border-spacing:0; table-layout:fixed; }
    table.report th, table.report td{ position:static; }
    th.sticky.l1, td.sticky.l1{ position:sticky; left:0; width:var(--resp-col-width); min-width:var(--resp-col-width); max-width:var(--resp-col-width); z-index:6; background:#fff; box-shadow:2px 0 0 rgba(15,23,42,.06); }
    th.sticky.l2, td.sticky.l2{ position:sticky; left:calc(var(--resp-col-width) + 1px); width:var(--type-col-width); min-width:var(--type-col-width); max-width:var(--type-col-width); z-index:5; background:#fff; box-shadow:1px 0 0 rgba(15,23,42,.05); }
    .resp-cell{ overflow:hidden; text-overflow:ellipsis; }

    /* KPI compacto + 2 col */
    #rp_kpiHeader.compact{ grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:8px; margin:6px 10px 10px; }
    #rp_kpiHeader.compact .kpi-card{ padding:8px; border-radius:10px; }
    #rp_kpiHeader.compact .kpi-card h4{ margin:0 0 6px; font-size:12px; color:#334155; }
    #rp_kpiHeader.compact .kpi-metrics{ gap:8px; }
    #rp_kpiHeader.compact .kpi-metric{ padding:6px; border-radius:8px; }
    #rp_kpiHeader.compact .kpi-metric .m-label{ font-size:10px; letter-spacing:.3px; }
    #rp_kpiHeader.compact .kpi-metric .m-val{ font-size:18px; font-weight:800; }
    #rp_kpiHeader.compact .kpi-metric small{ font-size:10px; }
    #kpiLeaderList.compact{ gap:6px; }
    #kpiLeaderList.compact .leader-row{ padding:6px 8px; display:flex; align-items:center; justify-content:space-between; background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; }
    #kpiLeaderList.compact .leader-name, #kpiLeaderList.compact .leader-pct{ font-size:13px; font-weight:700; color:#0f172a; }
    #kpiLeaderList.compact .badge{ background:#e0f2fe; border:1px solid #bae6fd; border-radius:999px; padding:2px 8px; font-size:12px; color:#0c4a6e; }
    #kpiLeaderList.compact.twocol{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px; }
    #kpiLeaderList.compact.twocol .leader-row{ width:100%; }
    @media (max-width:700px){ #kpiLeaderList.compact.twocol{ grid-template-columns:1fr; } }
    #kpiLeaderList.compact .leader-main,#lkpiLeaderList.compact .leader-main{display:flex;align-items:center;gap:8px}

    #lr_kpiHeader.compact{ grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:8px; margin:6px 10px 10px; }
    #lr_kpiHeader.compact .kpi-card{ padding:8px; border-radius:10px; }
    #lr_kpiHeader.compact .kpi-card h4{ margin:0 0 6px; font-size:12px; color:#334155; }
    #lr_kpiHeader.compact .kpi-metrics{ gap:8px; }
    #lr_kpiHeader.compact .kpi-metric{ padding:6px; border-radius:8px; }
    #lr_kpiHeader.compact .kpi-metric .m-label{ font-size:10px; letter-spacing:.3px; }
    #lr_kpiHeader.compact .kpi-metric .m-val{ font-size:18px; font-weight:800; }
    #lr_kpiHeader.compact .kpi-metric small{ font-size:10px; }
    #lkpiLeaderList.compact{ gap:6px; }
    #lkpiLeaderList.compact .leader-row{ padding:6px 8px; display:flex; align-items:center; justify-content:space-between; background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; }
    #lkpiLeaderList.compact .leader-name, #lkpiLeaderList.compact .leader-pct{ font-size:13px; font-weight:700; color:#0f172a; }
    #lkpiLeaderList.compact .badge{ background:#e0f2fe; border:1px solid #bae6fd; border-radius:999px; padding:2px 8px; font-size:12px; color:#0c4a6e; }
    #lkpiLeaderList.compact.twocol{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px; }
    #lkpiLeaderList.compact.twocol .leader-row{ width:100%; }
    @media (max-width:700px){ #lkpiLeaderList.compact.twocol{ grid-template-columns:1fr; } }

    /* Hoy anclado correctamente */
    table.report th.today-col, table.report td.today-col{ position:relative!important; }

    /* Ocultar chips de responsables */
    #rp_chips,#lr_chips{ display:none!important; }

    /* Centrado real del número (lectura) + pin más chico en edición */
    .plan-cell{ padding-right:0 }
    .plan-cell.has-pin{ padding-right:18px }
    .plan-cell.readonly{ justify-content:center!important; }
    .plan-cell.readonly .value{ display:inline-block; min-width:24px; text-align:center; margin:0 auto; }
    .comment-pin{ transform:scale(.85); }
  </style>
</head>
<body>
  <div id="globalLoader" role="status" aria-live="polite">
    <div class="loader-spinner" aria-hidden="true"></div>
    <div>Cargando capas…</div>
  </div>
  <header>
    <div class="title">Geoportal Predial</div>

    <div id="centerControls">
      <div id="searchWrap">
        <input id="searchBox" type="text" placeholder="🔍 Buscar cod_prel o cod_mtc…" autocomplete="off" />
        <div id="suggestions"></div>
      </div>
    </div>

    <div id="rightControls">
      <button class="ghost" id="btnReport">📊 Reporte</button>
      <button class="ghost" id="btnLegalReport">⚖️ Rep. Legal</button>
      <button class="btn" id="btnExpedientes">📑 Expedientes</button>
      <select id="filterComunidad"><option value="">Comunidad (todas)</option></select>
      <select id="filterGrupo">
        <option value="">Grupo (todos)</option>
        <option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option>
        <option value="1er_entregable">1er_entregable</option>
      </select>
      <button class="btn" id="btnFiltrar">Filtrar</button>
      <button class="ghost" id="btnReset">Reset</button>
    </div>
  </header>

  <div id="split">
    <section id="leftPane"><div id="map"></div></section>
    <div id="gutter" title="Arrastra para redimensionar"></div>
    <section id="rightPane">
      <div class="panel">
        <h3>Detalle del predio</h3>

        <!-- Datos comunes -->
        <div id="commonBlock" class="block" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <div style="display:flex;align-items:center;gap:8px;">
              <div class="label">Datos:</div>
              <span id="unionCount" class="badge"></span>
            </div>
            <div><button id="btnEditCommon" class="btn-small">✏️ Editar datos</button></div>
          </div>

          <!-- Lectura -->
          <div id="commonView">
            <div class="grid-2">
              <div><div class="label">Código MTC</div><div id="cm_mtc" class="textblock"></div></div>
              <div><div class="label">Comunidad</div><div id="cm_comunidad" class="textblock"></div></div>
              <div style="grid-column:1/-1"><div class="label">Titular</div><div id="cm_titular" class="textblock"></div></div>
              <div style="grid-column:1/-1"><div class="label">DNI / RUC</div><div id="cm_dni" class="textblock"></div></div>
              <div style="grid-column:1/-1"><div class="label">Contacto</div><div id="cm_contacto" class="textblock"></div></div>
              <div><div class="label">Condición</div><div id="cm_condicion" class="textblock"></div></div>
              <div><div class="label">Tipo</div><div id="cm_tipo" class="textblock"></div></div>
              <div><div class="label">Responsable</div><div id="cm_responsable" class="textblock"></div></div>
              <div><div class="label">Responsable legal</div><div id="cm_resp_legal" class="textblock"></div></div>
              <div><div class="label">Grupo</div><div id="cm_grupo" class="textblock"></div></div>
              <div><div class="label">Fecha elaboración</div><div id="cm_fecha" class="textblock"></div></div>
              <div><div class="label">Avance legal</div><div id="cm_avance_legal" class="textblock"></div></div>
            </div>
          </div>

          <!-- Edición -->
          <div id="commonEdit" style="display:none">
            <div class="grid-2">
              <div><div class="label">Código MTC</div><input id="ed_mtc" type="text"></div>
              <div><div class="label">Comunidad</div><input id="ed_comunidad" type="text"></div>
              <div style="grid-column:1/-1"><div class="label">Titular</div><textarea id="ed_titular" rows="3" style="white-space:pre-line"></textarea></div>
              <div style="grid-column:1/-1"><div class="label">DNI / RUC</div><textarea id="ed_dni" rows="2" style="white-space:pre-line"></textarea></div>
              <div style="grid-column:1/-1"><div class="label">Contacto</div><textarea id="ed_contacto" rows="2" style="white-space:pre-line"></textarea></div>
              <div><div class="label">Condición</div><input id="ed_condicion" type="text"></div>
              <div>
                <div class="label">Tipo</div>
                <select id="ed_tipo">
                  <option value="predios">predios</option>
                  <option value="comunidad">comunidad</option>
                </select>
              </div>
              <div>
                <div class="label">Responsable</div>
                <select id="ed_responsable"></select>
              </div>
              <div>
                <div class="label">Responsable legal</div>
                <select id="ed_resp_legal"></select>
              </div>
              <div>
                <div class="label">Grupo</div>
                <select id="ed_grupo">
                  <option value="">—</option>
                  <option value="1">1</option><option value="2">2</option>
                  <option value="3">3</option><option value="4">4</option>
                  <option value="1er_entregable">1er_entregable</option>
                </select>
              </div>
              <div><div class="label">Fecha elaboración</div><input id="ed_fecha" type="date"></div>
              <div><div class="label">Avance legal</div><input id="ed_avance_legal" type="date"></div>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
              <button id="btnCancelCommon" class="btn-small">Cancelar</button>
              <button id="btnSaveCommon" class="btn">Guardar</button>
            </div>
          </div>
        </div>

        <!-- Áreas afectadas -->
        <div id="areasWrap" class="block" style="display:none">
          <div class="label">Áreas afectadas</div>
          <div id="areasList"></div>
        </div>

        <div id="emptyHint" class="muted">Selecciona un polígono o busca por código.</div>
      </div>
    </section>
  </div>

  <!-- Modal Detalle de Área -->
  <div id="modalAreaBack" class="modal-back" style="display:none">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3>Detalles del Área Afectada</h3>
        <button class="btn-small" onclick="closeAreaModal()">✕</button>
      </div>
      <div class="grid-2">
        <div><div class="label">cod_prel</div><input id="a_cod_prel" type="text" disabled></div>
        <div><div class="label">Área</div><input id="a_area" type="text"></div>
        <div><div class="label">Perímetro</div><input id="a_perimetro" type="text"></div>
        <div><div class="label">Prog. Ini</div><input id="a_prog_ini" type="text"></div>
        <div><div class="label">Prog. Fin</div><input id="a_prog_fin" type="text"></div>
        <div><div class="label">Lado</div><input id="a_lado" type="text"></div>
        <div style="grid-column:1/-1"><div class="label">Obra complementaria</div><textarea id="a_obra" rows="3" style="white-space:pre-line"></textarea></div>
        <div style="grid-column:1/-1"><div class="label">Plantaciones</div><textarea id="a_plantaciones" rows="3" style="white-space:pre-line"></textarea></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn-small" onclick="closeAreaModal()">Cancelar</button>
        <button class="btn" onclick="saveArea()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal EXPEDIENTES -->
  <div id="expModal" class="modal-back" style="display:none">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <h3 style="margin:0">Reporte de expedientes</h3>
        <button class="btn-small" id="exp_close">✕</button>
      </div>
      <div class="row" style="padding-top:0">
        <label>Desde: <input type="date" id="exp_start"></label>
        <label>Hasta: <input type="date" id="exp_end"></label>
        <label>Grupo:
          <select id="exp_grupo">
            <option value="">Todos</option>
            <option value="1">1</option><option value="2">2</option>
            <option value="3">3</option><option value="4">4</option>
            <option value="1er_entregable">1er_entregable</option>
          </select>
        </label>
        <label>Responsable:
          <select id="exp_resp"><option value="">Todos</option></select>
        </label>
        <button class="btn" id="exp_run">Filtrar</button>
        <button class="ghost" id="exp_export">⬇️ Exportar Excel</button>
        <span id="exp_counter"></span>
      </div>
      <div id="exp_table_wrap">
        <table id="exp_table" class="report" style="width:100%"></table>
      </div>
    </div>
  </div>

  <!-- Drawer Reporte -->
  <aside id="reportDrawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <h3 style="margin:0">Reporte — Avance Técnico</h3>
      <button class="btn-small print-hidden" id="rp_close">✕</button>
    </div>

    <div class="row">
      <label>Desde: <input id="rp_start" type="date"></label>
      <label>Hasta: <input id="rp_end" type="date"></label>
      <button class="btn print-hidden" id="rp_run">Generar</button>
      <button class="ghost print-hidden" id="rp_todayBtn">📅 Hoy</button>
      <button class="ghost print-hidden" id="rp_toggleEdit">✏️ Editar Planificado</button>
      <button class="ghost print-hidden" id="rp_print">🖨️ Imprimir</button>
      <span id="rp_status" class="muted"></span>
    </div>

    <div id="rp_chips" class="row" style="margin-top:-8px"></div>

    <div id="rp_kpiHeader">
      <div class="kpi-card">
        <h4>Resumen general</h4>
        <div class="kpi-metrics">
          <div class="kpi-metric">
            <div class="m-label">Planificado</div>
            <div class="m-val" id="kpiGeneralPlan">—</div>
            <small id="kpiGeneralPlanRange">—</small>
          </div>
          <div class="kpi-metric">
            <div class="m-label">Elaborado</div>
            <div class="m-val" id="kpiGeneralDone">—</div>
            <small id="kpiGeneralDoneRange">—</small>
          </div>
          <div class="kpi-metric">
            <div class="m-label">Avance</div>
            <div class="m-val" id="kpiGeneralPct">—</div>
            <small>Elaborado / Planificado</small>
          </div>
        </div>
      </div>
      <div class="kpi-card">
        <h4>Resumen acumulado hasta hoy</h4>
        <div class="kpi-metrics">
          <div class="kpi-metric">
            <div class="m-label">Planificado acum.</div>
            <div class="m-val" id="kpiTodayPlan">—</div>
            <small id="kpiTodayRange">—</small>
          </div>
          <div class="kpi-metric">
            <div class="m-label">Elaborado acum.</div>
            <div class="m-val" id="kpiTodayDone">—</div>
            <small>Hasta hoy</small>
          </div>
          <div class="kpi-metric">
            <div class="m-label">Avance</div>
            <div class="m-val" id="kpiTodayPct">—</div>
            <small>Elaborado / Planificado</small>
          </div>
        </div>
      </div>
      <div class="kpi-card">
        <h4>Avance por responsable (hasta hoy)</h4>
        <div class="kpi-leader-list" id="kpiLeaderList"></div>
      </div>
    </div>

    <div id="rp_tableWrap">
      <table id="rp_table" class="report"></table>
    </div>

    <div id="chartWrap" style="display:none">
      <canvas id="rp_chart" height="336"></canvas>
    </div>

    <div id="rp_detail" class="block" style="display:none"></div>

    <div id="rp_todaySummary" class="block" style="display:none"></div>
  </aside>

  <!-- Drawer Reporte Legal -->
  <aside id="legalReportDrawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <h3 style="margin:0">Reporte — Avance Legal</h3>
      <button class="btn-small print-hidden" id="lr_close">✕</button>
    </div>

    <div class="row">
      <label>Desde: <input id="lr_start" type="date"></label>
      <label>Hasta: <input id="lr_end" type="date"></label>
      <button class="btn print-hidden" id="lr_run">Generar</button>
      <button class="ghost print-hidden" id="lr_toggleEdit">✏️ Editar Planificado</button>
      <button class="ghost print-hidden" id="lr_print">🖨️ Imprimir</button>
      <span id="lr_status" class="muted"></span>
    </div>

    <div id="lr_chips" class="row" style="margin-top:-8px"></div>

    <div id="lr_kpiHeader">
      <div class="kpi-card">
        <h4>Resumen general</h4>
        <div class="kpi-metrics">
          <div class="kpi-metric">
            <div class="m-label">Planificado</div>
            <div class="m-val" id="lkpiGeneralPlan">—</div>
            <small id="lkpiGeneralPlanRange">—</small>
          </div>
          <div class="kpi-metric">
            <div class="m-label">Avance</div>
            <div class="m-val" id="lkpiGeneralDone">—</div>
            <small id="lkpiGeneralDoneRange">—</small>
          </div>
          <div class="kpi-metric">
            <div class="m-label">Cumplimiento</div>
            <div class="m-val" id="lkpiGeneralPct">—</div>
            <small>vs plan</small>
          </div>
        </div>
      </div>
      <div class="kpi-card">
        <h4>Acumulado al corte</h4>
        <div class="kpi-metrics">
          <div class="kpi-metric">
            <div class="m-label">Plan</div>
            <div class="m-val" id="lkpiTodayPlan">—</div>
            <small id="lkpiTodayRange">—</small>
          </div>
          <div class="kpi-metric">
            <div class="m-label">Avance</div>
            <div class="m-val" id="lkpiTodayDone">—</div>
            <small>Corte seleccionado</small>
          </div>
          <div class="kpi-metric">
            <div class="m-label">Avance</div>
            <div class="m-val" id="lkpiTodayPct">—</div>
            <small>vs plan</small>
          </div>
        </div>
      </div>
      <div class="kpi-card">
        <h4>Líderes</h4>
        <div id="lkpiLeaderList" class="kpi-leader-list"></div>
      </div>
    </div>

    <div id="lr_tableWrap">
      <table id="lr_table" class="report"></table>
    </div>

    <div id="lr_detail" class="block" style="display:none"></div>

    <div id="lr_chartWrap" style="display:none">
      <canvas id="lr_chart" height="336"></canvas>
    </div>

    <div id="lr_todaySummary" class="block" style="display:none"></div>
  </aside>

  <div id="commentPopover" class="comment-popover" role="dialog" aria-modal="false"></div>

<script>
/** ====== CONFIG ====== **/
const SUPABASE_URL = "https://wbzxbfqowlfmmkwqeyam.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndienhiZnFvd2xmbW1rd3FleWFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODUwMDQsImV4cCI6MjA3MjU2MTAwNH0.mJJ7yID73tUerWE_aiNw3ZE4o-Q9YrT39YN-iS2CksA";
const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const numberFormatter = new Intl.NumberFormat('es-PE');
let globalLoaderEl = document.getElementById('globalLoader');
function hideGlobalLoader(){
  if(!globalLoaderEl) return;
  globalLoaderEl.classList.add('hidden');
  setTimeout(()=>{ globalLoaderEl?.remove?.(); globalLoaderEl = null; }, 350);
}

/** ====== Helpers fecha ====== **/
function parseYmd(ymd){ const [y,m,d] = ymd.split("-").map(Number); return new Date(y, (m||1)-1, d||1); }
function ymdFromDateLocal(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
function dateKey(d){ return ymdFromDateLocal(d); }
function buildDays(from, to){ const a=[]; const cur=new Date(from.getFullYear(), from.getMonth(), from.getDate()); const end=new Date(to.getFullYear(), to.getMonth(), to.getDate()); while(cur<=end){ a.push(new Date(cur)); cur.setDate(cur.getDate()+1); } return a; }

/** ====== MAP ====== **/
const map = L.map('map', { zoomControl:true, attributionControl:false }).setView([-15.5, -70.1], 17);
L.control.attribution({ prefix:false }).addTo(map);
L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom:21, attribution:'© Google' }).addTo(map);

const normalStyle   = { color:"var(--predio)",    weight:2, fillOpacity:0.2 };
const commStyle     = { color:"var(--comunidad)", weight:2, fillOpacity:0.2 };
const otherStyle    = { color:"#a855f7",          weight:2, fillOpacity:0.2 };
const highlightStyle= { color:"var(--highlight)", weight:3, fillOpacity:0.4 };

let selectedCodPrel = null;
let currentUnirId = null;

const capaPredio    = L.geoJSON(null, { style: normalStyle }).addTo(map);
const capaComunidad = L.geoJSON(null, { style: commStyle   }).addTo(map);
const capaOtros     = L.geoJSON(null, { style: otherStyle  }).addTo(map);

L.control.layers(null, { "Predios":capaPredio, "Comunidades":capaComunidad, "Otros":capaOtros }).addTo(map);

function isPredios(v){ return (v||"").toLowerCase() === "predios" || (v||"").toLowerCase() === "predio"; }
function isComunidad(v){ return (v||"").toLowerCase() === "comunidad"; }
function styleByTipo(t){ return isComunidad(t) ? commStyle : isPredios(t) ? normalStyle : otherStyle; }

/** ====== DATA LOAD ====== **/
async function loadAllPredios(){
  try{
    const { data, error } = await client
      .from("cod_pred")
      .select("cod_prel,unir,comunidad,condicion,grupo,codigo_mtc,titular,tipo,geom");
    if(error){ console.error(error); return; }

    capaPredio.clearLayers(); capaComunidad.clearLayers(); capaOtros.clearLayers();

    (data||[]).forEach(p=>{
      if(!p.geom) return;
      const f = { type:"Feature", geometry:p.geom, properties:p };
      const layer = L.geoJSON(f, { style: styleByTipo(p.tipo) });
      layer.on("click", () => { selectedCodPrel = p.cod_prel; showGroup(p.unir); });
      if(isComunidad(p.tipo)) layer.addTo(capaComunidad);
      else if(isPredios(p.tipo)) layer.addTo(capaPredio);
      else layer.addTo(capaOtros);
    });

    const bounds = capaPredio.getLayers().length ? capaPredio.getBounds()
                 : capaComunidad.getLayers().length ? capaComunidad.getBounds()
                 : capaOtros.getLayers().length ? capaOtros.getBounds() : null;
    if(bounds) map.fitBounds(bounds);
  }finally{
    hideGlobalLoader();
  }
}

/** ====== DESTACAR GRUPO ====== **/
function highlightGroup(unirId, zoomTo=true){
  let groupBounds = null;
  const restyle = (grp)=>{
    grp.eachLayer(l=>{
      const props = l.feature?.properties;
      const setLayer = (ly, pr)=>{
        const match = pr.unir === unirId;
        ly.setStyle(match ? highlightStyle : styleByTipo(pr.tipo));
        if(match){ ly.bringToFront(); if(ly.getBounds){ groupBounds = groupBounds ? groupBounds.extend(ly.getBounds()) : ly.getBounds(); } }
      };
      if(props) setLayer(l, props);
      l.eachLayer?.((sub)=>{ if(sub.feature?.properties) setLayer(sub, sub.feature.properties); });
    });
  };
  [capaPredio, capaComunidad, capaOtros].forEach(restyle);
  if(groupBounds && zoomTo) map.fitBounds(groupBounds, { padding:[40,40], maxZoom:20 });
}

/** ====== UI PANEL ====== **/
const blockCommon  = document.getElementById("commonBlock");
const wrapAreas    = document.getElementById("areasWrap");
const listAreas    = document.getElementById("areasList");
const emptyHint    = document.getElementById("emptyHint");
const unionCount   = document.getElementById("unionCount");

const commonView   = document.getElementById("commonView");
const commonEdit   = document.getElementById("commonEdit");
const btnEditCommon= document.getElementById("btnEditCommon");
const btnSaveCommon= document.getElementById("btnSaveCommon");
const btnCancelCommon= document.getElementById("btnCancelCommon");

let currentCommon = null;

async function showGroup(unirId){
  const { data, error } = await client.from("cod_pred").select("*").eq("unir", unirId);
  if(error || !data?.length){ return; }

  currentUnirId = unirId;
  highlightGroup(unirId, true);
  unionCount.textContent = `Se unen: ${data.length} ${data.length===1?'código':'códigos'}`;

  const c = data[0];
  currentCommon = {
    codigo_mtc: c.codigo_mtc || "",
    titular:    c.titular    || "",
    dni_ruc:    c.dni_ruc    || "",
    contacto:   c.contacto   || "",
    comunidad:  c.comunidad  || "",
    condicion:  c.condicion  || "",
    tipo:       normTipo(c.tipo),
    responsable:c.responsable || "",
    resp_legal: c.resp_legal  || "",
    grupo:      c.grupo       || "",
    fecha:      c.fecha_elab  || "",
    avance_legal: c.avance_legal || ""
  };

  blockCommon.style.display = "";
  wrapAreas.style.display = "";
  emptyHint.style.display = "none";

  setText("cm_mtc", currentCommon.codigo_mtc);
  setText("cm_titular", currentCommon.titular);
  setText("cm_dni", currentCommon.dni_ruc);
  setText("cm_contacto", currentCommon.contacto);
  setText("cm_comunidad", currentCommon.comunidad);
  setText("cm_condicion", currentCommon.condicion);
  setText("cm_tipo", currentCommon.tipo || "predios");
  setText("cm_responsable", cap(currentCommon.responsable));
  setText("cm_resp_legal", cap(currentCommon.resp_legal));
  setText("cm_grupo", currentCommon.grupo);
  setText("cm_fecha", currentCommon.fecha ? String(currentCommon.fecha).slice(0,10) : "");
  setText("cm_avance_legal", currentCommon.avance_legal ? String(currentCommon.avance_legal).slice(0,10) : "");

  setVal("ed_mtc", currentCommon.codigo_mtc);
  setVal("ed_titular", currentCommon.titular);
  setVal("ed_dni", currentCommon.dni_ruc);
  setVal("ed_contacto", currentCommon.contacto);
  setVal("ed_comunidad", currentCommon.comunidad);
  setVal("ed_condicion", currentCommon.condicion);
  setVal("ed_tipo", currentCommon.tipo || "predios");
  populateResponsableSelect(currentCommon.responsable);
  populateRespLegalSelect(currentCommon.resp_legal);
  setVal("ed_grupo", currentCommon.grupo);
  document.getElementById("ed_fecha").value = currentCommon.fecha ? String(currentCommon.fecha).slice(0,10) : "";
  document.getElementById("ed_avance_legal").value = currentCommon.avance_legal ? String(currentCommon.avance_legal).slice(0,10) : "";

  listAreas.innerHTML = "";
  (data||[]).forEach(p=>{
    const card = document.createElement("div");
    card.className = "area-card";
    card.setAttribute("data-cod", p.cod_prel);
    card.innerHTML = `
      <h4>${p.cod_prel}</h4>
      <div><b>Área:</b> ${p.area ?? ""}</div>
      <div><b>Prog:</b> ${p.prog_ini ?? ""} - ${p.prog_fin ?? ""} &nbsp; <b>Lado:</b> ${p.lado ?? ""}</div>
      <div class="area-actions">
        <button class="pill" data-cod="${p.cod_prel}" data-action="focus">Enfocar</button>
        <button class="pill" data-cod="${p.cod_prel}" data-action="detalles">Ver detalles</button>
      </div>
    `;
    listAreas.appendChild(card);
  });
  listAreas.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      const cod = e.currentTarget.dataset.cod;
      const action = e.currentTarget.dataset.action;
      if(action==="focus"){ selectedCodPrel = cod; focusByCodPrel(cod); highlightGroup(currentUnirId, false); }
      if(action==="detalles"){ selectedCodPrel = cod; focusByCodPrel(cod); highlightGroup(currentUnirId, false); openAreaModal(cod); }
    });
  });

  setCommonMode(false);
}
function setText(id, val){ document.getElementById(id).textContent = val ?? ""; }
function setVal(id, val){ document.getElementById(id).value = val ?? ""; }
function normTipo(v){ const s=(v||"").toLowerCase(); if(s==="comunidad") return "comunidad"; return "predios"; }
function setCommonMode(edit){
  commonView.style.display = edit ? "none" : "";
  commonEdit.style.display = edit ? "" : "none";
  btnEditCommon.style.display = edit ? "none" : "";
}
btnEditCommon.addEventListener("click", ()=> {
  populateResponsableSelect(currentCommon?.responsable||"");
  populateRespLegalSelect(currentCommon?.resp_legal||"");
  setCommonMode(true);
});
btnCancelCommon.addEventListener("click", ()=> {
  if(currentCommon){
    setVal("ed_mtc", currentCommon.codigo_mtc);
    setVal("ed_titular", currentCommon.titular);
    setVal("ed_dni", currentCommon.dni_ruc);
    setVal("ed_contacto", currentCommon.contacto);
    setVal("ed_comunidad", currentCommon.comunidad);
    setVal("ed_condicion", currentCommon.condicion);
    setVal("ed_tipo", currentCommon.tipo || "predios");
    populateResponsableSelect(currentCommon.responsable);
    populateRespLegalSelect(currentCommon.resp_legal);
    setVal("ed_grupo", currentCommon.grupo);
    document.getElementById("ed_fecha").value = currentCommon.fecha ? String(currentCommon.fecha).slice(0,10) : "";
    document.getElementById("ed_avance_legal").value = currentCommon.avance_legal ? String(currentCommon.avance_legal).slice(0,10) : "";
  }
  setCommonMode(false);
});
btnSaveCommon.addEventListener("click", async ()=>{
  const payload = {
    codigo_mtc:  valOrNull("ed_mtc"),
    titular:     valOrNull("ed_titular"),
    dni_ruc:     valOrNull("ed_dni"),
    contacto:    valOrNull("ed_contacto"),
    comunidad:   valOrNull("ed_comunidad"),
    condicion:   valOrNull("ed_condicion"),
    tipo:        normTipo(document.getElementById("ed_tipo").value),
    responsable: valOrNull("ed_responsable"),
    resp_legal:  valOrNull("ed_resp_legal"),
    grupo:       valOrNull("ed_grupo"),
    fecha_elab:  (document.getElementById("ed_fecha").value || null),
    avance_legal:(document.getElementById("ed_avance_legal").value || null)
  };
  const { error } = await client.from("cod_pred").update(payload).eq("unir", currentUnirId);
  if(error){ alert("❌ Error al guardar comunes: "+error.message); return; }
  alert("✅ Datos comunes actualizados");
  await loadAllPredios();
  await showGroup(currentUnirId);
});
function valOrNull(id){ const v = document.getElementById(id).value; return v==="" ? null : v; }

function focusByCodPrel(cod){
  let found = null;
  [capaPredio, capaComunidad, capaOtros].forEach(group=>{
    group.eachLayer(l=>{
      if(l.feature?.properties?.cod_prel === cod) found = l;
      l.eachLayer?.((sub)=>{ if(sub.feature?.properties?.cod_prel === cod) found = sub; });
    });
  });
  if(found){
    const b = found.getBounds?.();
    if(b) map.fitBounds(b, { maxZoom: 20, padding:[40,40] });
  }
}

/** ====== SEARCH ====== **/
const searchBox = document.getElementById("searchBox");
const suggestions = document.getElementById("suggestions");
let debounceTimer = null;
searchBox.addEventListener("input", (e)=>{
  const q = e.target.value.trim();
  clearTimeout(debounceTimer);
  if(q.length < 2){ suggestions.classList.remove("active"); suggestions.innerHTML=""; return; }
  debounceTimer = setTimeout(()=> runSuggest(q), 250);
});
searchBox.addEventListener("blur", ()=> setTimeout(()=>{ suggestions.classList.remove("active"); }, 150));
async function runSuggest(q){
  const { data, error } = await client.from("cod_pred")
    .select("cod_prel,codigo_mtc,unir")
    .or(`cod_prel.ilike.%${q}%,codigo_mtc.ilike.%${q}%`).limit(12);
  if(error){ console.error(error); return; }
  suggestions.innerHTML = "";
  (data||[]).forEach(r=>{
    const row = document.createElement("div");
    row.textContent = `${r.cod_prel} (${r.codigo_mtc ?? "—"})`;
    row.onclick = ()=>{ suggestions.classList.remove("active"); showGroup(r.unir); };
    suggestions.appendChild(row);
  });
  suggestions.classList.add("active");
}

/** ====== FILTROS MAPA ====== **/
const selCom = document.getElementById("filterComunidad");
const selGrupo = document.getElementById("filterGrupo");
document.getElementById("btnFiltrar").addEventListener("click", applyFilters);
document.getElementById("btnReset").addEventListener("click", async ()=>{
  selCom.value=""; selGrupo.value=""; searchBox.value="";
  await loadAllPredios();
  blockCommon.style.display="none"; wrapAreas.style.display="none"; emptyHint.style.display="";
});
async function hydrateFilterOptions(){
  const { data, error } = await client.from("cod_pred").select("comunidad").not("geom","is",null);
  if(error) return;
  const comunidades = [...new Set((data||[]).map(d=>d.comunidad).filter(Boolean))].sort();
  comunidades.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; selCom.appendChild(o); });
}
async function applyFilters(){
  let q = client.from("cod_pred").select("cod_prel,unir,tipo,geom,comunidad,grupo,condicion");
  if(selCom.value) q = q.eq("comunidad", selCom.value);
  if(selGrupo.value) q = q.eq("grupo", selGrupo.value);

  const { data, error } = await q;
  if(error){ console.error(error); return; }

  capaPredio.clearLayers(); capaComunidad.clearLayers(); capaOtros.clearLayers();
  (data||[]).forEach(p=>{
    if(!p.geom) return;
    const f = { type:"Feature", geometry:p.geom, properties:p };
    const layer = L.geoJSON(f, { style: styleByTipo(p.tipo) });
    layer.on("click", () => { selectedCodPrel = p.cod_prel; showGroup(p.unir); });
    if(isComunidad(p.tipo)) layer.addTo(capaComunidad);
    else if(isPredios(p.tipo)) layer.addTo(capaPredio);
    else layer.addTo(capaOtros);
  });

  const bounds = capaPredio.getLayers().length ? capaPredio.getBounds()
               : capaComunidad.getLayers().length ? capaComunidad.getBounds()
               : capaOtros.getLayers().length ? capaOtros.getBounds() : null;
  if(bounds) map.fitBounds(bounds);
}

/** ====== RESPONSABLES ====== **/
let RESPONSABLES = { tecnico: [], legal: [] };
async function fetchResponsables(){
  const { data, error } = await client.from("cod_pred").select("responsable,resp_legal").not("geom","is",null);
  if(error){ console.warn(error.message); RESPONSABLES = { tecnico: [], legal: [] }; return; }
  const techSet = new Set();
  const legalSet = new Set();
  (data||[]).forEach(r=>{
    const tech = (r.responsable||"").toString().trim().toLowerCase();
    const legal = (r.resp_legal||"").toString().trim().toLowerCase();
    if(tech) techSet.add(tech);
    if(legal) legalSet.add(legal);
  });
  RESPONSABLES = {
    tecnico: [...techSet].sort(),
    legal: [...legalSet].sort()
  };
}
function populateResponsableSelect(selected){
  const sel = document.getElementById("ed_responsable");
  if(!sel) return;
  const normalized = (selected||"").toString().trim().toLowerCase();
  const options = RESPONSABLES.tecnico.slice();
  if(normalized && !options.includes(normalized)) options.unshift(normalized);
  sel.innerHTML = '<option value="">—</option>' + options.map(n=>`<option value="${n}">${cap(n)}</option>`).join("");
  sel.value = normalized;
}
function populateRespLegalSelect(selected){
  const sel = document.getElementById("ed_resp_legal");
  if(!sel) return;
  const normalized = (selected||"").toString().trim().toLowerCase();
  const options = RESPONSABLES.legal.slice();
  if(normalized && !options.includes(normalized)) options.unshift(normalized);
  sel.innerHTML = '<option value="">—</option>' + options.map(n=>`<option value="${n}">${cap(n)}</option>`).join("");
  sel.value = normalized;
}

/** ====== MODAL ÁREA ====== **/
const modalAreaBack = document.getElementById("modalAreaBack");
function openAreaModal(cod){
  modalAreaBack.style.display = "flex";
  client.from("cod_pred").select("*").eq("cod_prel",cod).single().then(({data})=>{
    if(!data) return;
    setVal("a_cod_prel", data.cod_prel ?? "");
    setVal("a_area", data.area ?? "");
    setVal("a_perimetro", data.perimetro_suma ?? "");
    setVal("a_prog_ini", data.prog_ini ?? "");
    setVal("a_prog_fin", data.prog_fin ?? "");
    setVal("a_lado", data.lado ?? "");
    document.getElementById("a_obra").value = data.obra_complementaria ?? "";
    document.getElementById("a_plantaciones").value = data.plantaciones ?? "";
  });
}
function closeAreaModal(){ modalAreaBack.style.display = "none"; }
async function saveArea(){
  const cod = document.getElementById("a_cod_prel").value;
  const update = {
    area: valOrNull("a_area"),
    perimetro_suma: valOrNull("a_perimetro"),
    prog_ini: valOrNull("a_prog_ini"),
    prog_fin: valOrNull("a_prog_fin"),
    lado: valOrNull("a_lado"),
    obra_complementaria: (document.getElementById("a_obra").value || null),
    plantaciones: (document.getElementById("a_plantaciones").value || null)
  };
  const { error } = await client.from("cod_pred").update(update).eq("cod_prel", cod);
  if(error){ alert("❌ Error al guardar: "+error.message); return; }
  alert("✅ Área actualizada");
  closeAreaModal();
  await loadAllPredios();
  if(currentUnirId) highlightGroup(currentUnirId, false);
}

/** ====== MODAL EXPEDIENTES ====== **/
const btnExpedientes = document.getElementById('btnExpedientes');
const expModalBack   = document.getElementById('expModal');
const expCloseBtn    = document.getElementById('exp_close');
const expStart       = document.getElementById('exp_start');
const expEnd         = document.getElementById('exp_end');
const expGrupo       = document.getElementById('exp_grupo');
const expResp        = document.getElementById('exp_resp');
const expRun         = document.getElementById('exp_run');
const expExport      = document.getElementById('exp_export');
const expTable       = document.getElementById('exp_table');
const expCounter     = document.getElementById('exp_counter');

let expItems = [];
let expSort  = { column: 'comunidad', direction: 'asc' };

btnExpedientes.addEventListener('click', openExpModal);
expCloseBtn.addEventListener('click', closeExpModal);
expRun.addEventListener('click', runExpedientes);
expExport.addEventListener('click', exportExpedientes);

function openExpModal(){
  defaultExpDates();
  hydrateExpSelects();
  runExpedientes();
  expModalBack.style.display = 'flex';
}
function closeExpModal(){ expModalBack.style.display = 'none'; }

function defaultExpDates(){
  const today = new Date();
  let year = today.getFullYear();
  const start = new Date(year, 8, 1);
  let end = new Date(year, 9, 25);
  if(today < start){
    year -= 1;
    start.setFullYear(year);
    end = new Date(year, 9, 25);
  }
  expStart.value = ymdFromDateLocal(start);
  expEnd.value   = ymdFromDateLocal(end);
}
function hydrateExpSelects(){
  // Responsables
  expResp.innerHTML = '<option value="">Todos</option>' + RESPONSABLES.tecnico.map(n=>`<option value="${n}">${cap(n)}</option>`).join('');
}

async function runExpedientes(){
  const start = expStart.value, end = expEnd.value;
  if(!start || !end){ alert("Selecciona fechas"); return; }

  let q = client.from("cod_pred")
    .select("unir,cod_prel,codigo_mtc,titular,comunidad,responsable,grupo,fecha_elab")
    .not("fecha_elab","is",null)
    .gte("fecha_elab", start)
    .lte("fecha_elab", end);

  const g = (expGrupo.value || '').trim();
  const r = (expResp.value || '').trim();

  if (g) q = q.eq("grupo", g);          // Grupo está bien con eq
  if (r) q = q.ilike("responsable", r); // <- clave: insensible a mayúsculas

  const { data, error } = await q.order('fecha_elab', { ascending:true });
  if(error){ console.error(error.message); alert('Error consultando expedientes'); return; }

  // Agrupar por Código MTC (o cod_prel cuando no exista)
  const map = new Map();
  (data||[]).forEach(row=>{
    const mtc = (row.codigo_mtc || "").trim();
    const cod = row.cod_prel || "";
    const key = mtc !== "" ? `mtc:${mtc}` : (row.unir != null ? `unir:${row.unir}` : `prel:${cod}`);
    if(!map.has(key)){
      map.set(key, {
        unir: row.unir,
        comunidad: row.comunidad || "",
        mtc,
        titular: row.titular || "",
        cods: [],
        primaryCod: cod
      });
    }
    const bucket = map.get(key);
    if(row.unir != null && bucket.unir == null) bucket.unir = row.unir;
    if(row.comunidad && !bucket.comunidad) bucket.comunidad = row.comunidad;
    if(row.titular && !bucket.titular) bucket.titular = row.titular;
    if(cod && !bucket.cods.includes(cod)) bucket.cods.push(cod);
    if(!bucket.primaryCod && cod) bucket.primaryCod = cod;
  });

  const items = [...map.values()].map(item=>({
    ...item,
    cods: item.cods.sort((a,b)=> a.localeCompare(b))
  }));

  expItems = items;
  expCounter.textContent = `${items.length} ${items.length===1?'expediente':'expedientes'}`;
  renderExpTable();
}

function renderExpTable(){
  const sortedItems = sortExpItems(expItems.slice());

  let html = `
    <thead>
      <tr>
        <th class="sortable" data-sort="comunidad">Comunidad${getExpSortIndicator('comunidad')}</th>
        <th class="sortable" data-sort="mtc">Código MTC${getExpSortIndicator('mtc')}</th>
        <th class="sortable" data-sort="cods">cod_prel${getExpSortIndicator('cods')}</th>
        <th class="sortable" data-sort="titular">Titular${getExpSortIndicator('titular')}</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody>
  `;

  html += sortedItems.map(it=>{
    const codList = it.cods.length ? it.cods.map(c=>`<span class="badge">${esc(c)}</span>`).join('') : '<span class="muted">—</span>';
    const firstCod = it.primaryCod || it.cods[0] || "";
    return `
      <tr>
        <td>${esc(it.comunidad||"")}</td>
        <td>${esc(it.mtc||"")}</td>
        <td><div class="cod-badges">${codList}</div></td>
        <td>${esc(it.titular||"")}</td>
        <td><button class="btn-small btn-focus-exp" data-unir="${it.unir??''}" data-cod="${firstCod}">Enfocar</button></td>
      </tr>
    `;
  }).join('');

  if(sortedItems.length === 0){
    html += `<tr><td colspan="5" class="muted" style="text-align:center;padding:20px 0">Sin expedientes</td></tr>`;
  }
  html += `</tbody>`;
  expTable.innerHTML = html;

  expTable.querySelectorAll('th[data-sort]').forEach(th=>{
    th.addEventListener('click', ()=>{
      const column = th.getAttribute('data-sort');
      if(expSort.column === column){
        expSort.direction = expSort.direction === 'asc' ? 'desc' : 'asc';
      }else{
        expSort.column = column;
        expSort.direction = 'asc';
      }
      renderExpTable();
    });
  });

  // Enfocar desde el reporte
  expTable.querySelectorAll('.btn-focus-exp').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const unir = btn.getAttribute('data-unir');
      const cod  = btn.getAttribute('data-cod');
      await focusExpediente(unir, cod);
    });
  });
}

function sortExpItems(items){
  const column = expSort.column;
  const dir = expSort.direction === 'asc' ? 1 : -1;
  const getKey = (item)=>{
    switch(column){
      case 'mtc': return item.mtc || '';
      case 'cods': return item.cods[0] || '';
      case 'titular': return item.titular || '';
      case 'comunidad':
      default:
        return item.comunidad || '';
    }
  };
  return items.sort((a,b)=>{
    const ka = getKey(a);
    const kb = getKey(b);
    const cmp = ka.localeCompare(kb, undefined, { sensitivity:'base', numeric:true });
    if(cmp !== 0) return cmp * dir;
    // fallback to comunidad then mtc for stability
    const fallback = (a.comunidad||'').localeCompare(b.comunidad||'', undefined, { sensitivity:'base', numeric:true });
    if(fallback !== 0) return fallback;
    return (a.mtc||'').localeCompare(b.mtc||'', undefined, { sensitivity:'base', numeric:true });
  });
}

function getExpSortIndicator(column){
  if(expSort.column !== column) return '';
  return expSort.direction === 'asc' ? ' ▲' : ' ▼';
}

function exportExpedientes(){
  if(!expItems.length){ alert('No hay datos para exportar'); return; }
  const sortedItems = sortExpItems(expItems.slice());
  const maxCods = Math.max(1, sortedItems.reduce((max,item)=>Math.max(max,item.cods?.length||0),0));
  const codHeaders = Array.from({length:maxCods},(_,i)=>`cod_prel ${i+1}`);
  const headers = ['Comunidad','Código MTC', ...codHeaders, 'Titular'];
  const tableRows = sortedItems.map(item=>{
    const codCells = Array.from({length:maxCods},(_,i)=>htmlEscape(item.cods?.[i] || ''));
    return `    <tr><td>${htmlEscape(item.comunidad||'')}</td><td>${htmlEscape(item.mtc||'')}</td>${codCells.map(c=>`<td>${c}</td>`).join('')}<td>${htmlEscape(item.titular||'')}</td></tr>`;
  });
  const tableHtml = `<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"></head><body><table border="1"><thead><tr>${headers.map(h=>`<th>${htmlEscape(h)}</th>`).join('')}</tr></thead><tbody>\n${tableRows.join('\n')}\n  </tbody></table></body></html>`;
  const bom = '\uFEFF';
  const blob = new Blob([bom + tableHtml], { type:'application/vnd.ms-excel;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  const start = expStart.value || 'inicio';
  const end = expEnd.value || 'fin';
  link.download = `reporte_expedientes_${start}_${end}.xls`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

function htmlEscape(value){
  return (value ?? '').toString()
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

// Enfocar helper
async function focusExpediente(unir, cod){
  if(unir && unir !== 'null' && unir !== ''){
    await selectFromReport(Number(unir), cod);
  }else{
    // buscar UNIR por si acaso
    try{
      const { data } = await client.from('cod_pred').select('unir').eq('cod_prel', cod).single();
      if(data?.unir!=null){
        await selectFromReport(Number(data.unir), cod);
      }else{
        selectedCodPrel = cod;
        focusByCodPrel(cod);
      }
    }catch(e){
      selectedCodPrel = cod;
      focusByCodPrel(cod);
    }
  }
}

/** ====== REPORTES ====== **/
const REPORT_MODULES = {};
let activeCommentModule = null;
const commentPopoverEl = document.getElementById("commentPopover");
let commentPopoverState = null;

class ReportModule {
  constructor(config){
    this.config = config;
    this.drawer = document.getElementById(config.drawerId);
    this.openBtn = document.getElementById(config.openBtnId);
    this.closeBtn = document.getElementById(config.closeBtnId);
    this.startInput = document.getElementById(config.startInputId);
    this.endInput = document.getElementById(config.endInputId);
    this.runBtn = document.getElementById(config.runBtnId);
    this.todayBtn = config.todayButtonId ? document.getElementById(config.todayButtonId) : null;
    this.toggleBtn = config.toggleBtnId ? document.getElementById(config.toggleBtnId) : null;
    this.printBtn = config.printBtnId ? document.getElementById(config.printBtnId) : null;
    this.statusEl = config.statusId ? document.getElementById(config.statusId) : null;
    this.chipsContainer = config.chipsContainerId ? document.getElementById(config.chipsContainerId) : null;
    this.table = document.getElementById(config.tableId);
    this.tableWrap = document.getElementById(config.tableWrapId);
    this.detailEl = config.detailId ? document.getElementById(config.detailId) : null;
    this.todaySummaryEl = config.todaySummaryId ? document.getElementById(config.todaySummaryId) : null;
    this.chartWrap = config.chartWrapId ? document.getElementById(config.chartWrapId) : null;
    this.chartCanvas = config.chartCanvasId ? document.getElementById(config.chartCanvasId) : null;
    this.kpi = {
      header: config.kpi?.headerId ? document.getElementById(config.kpi.headerId) : null,
      generalPlan: config.kpi?.generalPlanId ? document.getElementById(config.kpi.generalPlanId) : null,
      generalPlanRange: config.kpi?.generalPlanRangeId ? document.getElementById(config.kpi.generalPlanRangeId) : null,
      generalDone: config.kpi?.generalDoneId ? document.getElementById(config.kpi.generalDoneId) : null,
      generalDoneRange: config.kpi?.generalDoneRangeId ? document.getElementById(config.kpi.generalDoneRangeId) : null,
      generalPct: config.kpi?.generalPctId ? document.getElementById(config.kpi.generalPctId) : null,
      todayPlan: config.kpi?.todayPlanId ? document.getElementById(config.kpi.todayPlanId) : null,
      todayDone: config.kpi?.todayDoneId ? document.getElementById(config.kpi.todayDoneId) : null,
      todayPct: config.kpi?.todayPctId ? document.getElementById(config.kpi.todayPctId) : null,
      todayRange: config.kpi?.todayRangeId ? document.getElementById(config.kpi.todayRangeId) : null,
      leadersList: config.kpi?.leadersListId ? document.getElementById(config.kpi.leadersListId) : null
    };

    this.chart = null;
    this.editMode = false;
    this.printTitle = config.printTitle || `${document.title || 'Geoportal'} — ${config.key}`;
    this.planCounts = {};
    this.planComments = {};
    this.cellMapDone = new Map();
    this.resps = [];
    this.dMeta = [];
    this.dateKeys = [];
    this.activeDetailDay = null;
    this.currentTodayIdx = -1;

    this.openBtn?.addEventListener('click', ()=>this.open());
    this.closeBtn?.addEventListener('click', ()=>this.close());
    this.runBtn?.addEventListener('click', ()=>this.run());
    this.todayBtn?.addEventListener('click', ()=>this.runToday());
    this.toggleBtn?.addEventListener('click', ()=>this.toggleEdit());
    this.printBtn?.addEventListener('click', ()=>this.print());

    if(this.detailEl){
      this.detailEl.addEventListener('click', async (e)=>{
        const btn = e.target.closest('.code-link');
        if(!btn) return;
        await selectFromReport(btn.dataset.unir, btn.dataset.code);
      });
    }
    if(this.todaySummaryEl){
      this.todaySummaryEl.addEventListener('click', async (e)=>{
        const btn = e.target.closest('.code-link');
        if(!btn) return;
        await selectFromReport(btn.dataset.unir, btn.dataset.code);
      });
    }

    REPORT_MODULES[config.key] = this;
  }

  defaultDates(){
    if(typeof this.config.defaultRange === 'function'){
      const range = this.config.defaultRange();
      if(range?.start) this.startInput.value = range.start;
      if(range?.end) this.endInput.value = range.end;
      return;
    }
    const Y = new Date().getFullYear();
    this.startInput.value = `${Y}-09-02`;
    this.endInput.value = `${Y}-10-25`;
  }

  setStatus(msg){ if(this.statusEl) this.statusEl.textContent = msg || ''; }

  open(){
    this.defaultDates();
    this.run();
    if(this.drawer){
      this.drawer.classList.add('open');
      this.drawer.setAttribute('aria-hidden','false');
    }
  }

  close(){
    if(this.drawer){
      this.drawer.classList.remove('open');
      this.drawer.setAttribute('aria-hidden','true');
    }
    if(activeCommentModule === this) closeCommentPopover();
  }

  print(){
    if(!this.drawer) return;
    const printWindow = window.open('', '_blank', 'width=1200,height=900');
    if(!printWindow){
      alert('No se pudo abrir la ventana de impresión. Permite las ventanas emergentes para continuar.');
      return;
    }
    const clone = this.drawer.cloneNode(true);
    clone.classList.add('open');
    clone.setAttribute('aria-hidden','false');
    const styles = Array.from(document.querySelectorAll('style, link[rel="stylesheet"]'))
      .map(node => node.outerHTML)
      .join('');
    const safeTitle = (this.printTitle || document.title || 'Reporte')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');
    printWindow.document.open();
    printWindow.document.write(`<!DOCTYPE html><html lang="es"><head><meta charset="utf-8"><title>${safeTitle}</title>${styles}<style>body{margin:0;padding:24px;background:#fff;color:#0f172a;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,\"Helvetica Neue\",Arial,sans-serif;} .drawer{position:static!important;transform:none!important;width:auto!important;height:auto!important;box-shadow:none!important;border:none!important;} .drawer-head{position:static!important;} .drawer .print-hidden{display:none!important;} .drawer .row{padding-left:0;padding-right:0;} @media print{body{padding:0;}}</style></head><body>${clone.outerHTML}</body></html>`);
    printWindow.document.close();
    printWindow.focus();
    if('onafterprint' in printWindow){
      printWindow.onafterprint = ()=>{ try{ printWindow.close(); }catch(e){} };
    }
    setTimeout(()=>{ try{ printWindow.print(); }catch(e){} }, 500);
  }

  runToday(){
    const today = ymdFromDateLocal(new Date());
    if(this.startInput) this.startInput.value = today;
    if(this.endInput) this.endInput.value = today;
    this.run();
  }

  selectedResp(){
    const set = new Set();
    if(!this.chipsContainer) return set;
    this.chipsContainer.querySelectorAll('.rp-resp:checked').forEach(cb=> set.add(cb.value));
    return set;
  }

  async fetchPlan(start, end){
    if(!this.config.planTable || !this.config.planRespField) return [];
    const { data, error } = await client
      .from(this.config.planTable)
      .select(`${this.config.planRespField},fecha,valor,coment`)
      .gte('fecha', start)
      .lte('fecha', end);
    if(error){
      console.warn(`${this.config.planTable}:`, error.message);
      return [];
    }
    return data||[];
  }

  async savePlanEntry(resp, fecha, patch = {}){
    if(!this.config.planTable || !this.config.planRespField) return;
    const normalizedResp = normResp(resp);
    if(!normalizedResp || !fecha) return;
    const dow = parseYmd(fecha).getDay();
    const hasValor = Object.prototype.hasOwnProperty.call(patch, 'valor');
    if(hasValor && (dow===0 || dow===6)) return;
    const payload = { [this.config.planRespField]: normalizedResp, fecha, ...patch };
    if(!hasValor){
      const current = this.planCounts?.[normalizedResp]?.[fecha];
      payload.valor = typeof current === 'number' ? Number(current) || 0 : 0;
    }else{
      payload.valor = Number(payload.valor)||0;
    }
    const { error } = await client
      .from(this.config.planTable)
      .upsert(payload, { onConflict: this.config.planOnConflict || `${this.config.planRespField},fecha` });
    if(error) throw error;
  }

  async run(){
    const start = this.startInput?.value;
    const end = this.endInput?.value;
    if(!start || !end){ alert('Selecciona fechas'); return; }
    const allowed = this.selectedResp();

    this.setStatus('Cargando…');
    if(activeCommentModule === this) closeCommentPopover();
    if(this.detailEl){ this.detailEl.style.display='none'; this.detailEl.innerHTML=''; }
    if(this.todaySummaryEl){ this.todaySummaryEl.style.display='none'; this.todaySummaryEl.innerHTML=''; }

    const year = parseYmd(start).getFullYear();
    const generalStart = `${year}-09-01`;
    const generalEnd = `${year}-10-25`;

    const selectFields = `unir,cod_prel,codigo_mtc,comunidad,${this.config.respField},${this.config.dateField}`;

    const rangeQuery = client
      .from('cod_pred')
      .select(selectFields)
      .not(this.config.dateField,'is',null)
      .gte(this.config.dateField, start)
      .lte(this.config.dateField, end);

    const generalQuery = client
      .from('cod_pred')
      .select(selectFields)
      .not(this.config.dateField,'is',null)
      .gte(this.config.dateField, generalStart)
      .lte(this.config.dateField, generalEnd);

    const [rangeResp, generalResp, planRows, planRowsGeneral] = await Promise.all([
      rangeQuery,
      generalQuery,
      this.fetchPlan(start, end),
      this.fetchPlan(generalStart, generalEnd)
    ]);

    if(rangeResp.error){ this.setStatus(`Error: ${rangeResp.error.message}`); return; }
    if(generalResp.error){ this.setStatus(`Error: ${generalResp.error.message}`); return; }

    const groups = buildGroupsMap(rangeResp.data||[], allowed, this.config.respField, this.config.dateField);
    const generalGroups = buildGroupsMap(generalResp.data||[], allowed, this.config.respField, this.config.dateField);

    const dFrom = parseYmd(start), dTo = parseYmd(end);
    const days = buildDays(dFrom, dTo);
    const dMeta = days.map(d => ({ key: ymdFromDateLocal(d), dow: d.getDay() }));
    const dKeys = dMeta.map(d => d.key);

    const resps = [...new Set([...groups.values()].map(g=>g.responsable))].filter(Boolean).sort();

    const doneCounts = {};
    const planCounts = {};
    const planComments = {};
    resps.forEach(r=>{
      doneCounts[r] = Object.fromEntries(dKeys.map(k=>[k,0]));
      planCounts[r] = Object.fromEntries(dKeys.map(k=>[k,0]));
      planComments[r] = Object.fromEntries(dKeys.map(k=>[k,null]));
    });

    const cellMapDone = new Map();
    groups.forEach(g=>{
      const r = g.responsable;
      const k = g.fecha;
      if(!r || !k || !(k in (doneCounts[r]||{}))) return;
      doneCounts[r][k] += 1;
      const ck = `${r}|${k}`;
      if(!cellMapDone.has(ck)) cellMapDone.set(ck, []);
      cellMapDone.get(ck).push({ comunidad: g.comunidad, codigo_mtc: g.codigo_mtc, unirId: g.unirId, cods: g.cods });
    });

    (planRows||[]).forEach(p=>{
      const resp = normResp(p[this.config.planRespField]);
      const key = (p.fecha||'').toString().slice(0,10);
      if(resps.includes(resp) && dKeys.includes(key)){
        planCounts[resp][key] = Number(p.valor)||0;
        planComments[resp][key] = p.coment || null;
      }
    });

    this.planCounts = planCounts;
    this.planComments = planComments;
    this.cellMapDone = cellMapDone;
    this.resps = resps;
    this.dMeta = dMeta;
    this.dateKeys = dKeys;

    const todayKey = dateKey(new Date());
    const planDaily = dMeta.map(({key})=> resps.reduce((acc,r)=> acc + (planCounts[r]?.[key]||0), 0));
    const doneDaily = dMeta.map(({key})=> resps.reduce((acc,r)=> acc + (doneCounts[r]?.[key]||0), 0));

    let todayIdx = dKeys.indexOf(todayKey);
    if(todayIdx === -1){
      todayIdx = -1;
      dKeys.forEach((k,i)=>{ if(k<=todayKey) todayIdx = i; });
    }

    const planToToday = todayIdx >=0 ? planDaily.slice(0, todayIdx+1).reduce((acc,v)=>acc+v,0) : 0;
    const doneToToday = todayIdx >=0 ? doneDaily.slice(0, todayIdx+1).reduce((acc,v)=>acc+v,0) : 0;
    const todayPct = planToToday ? Math.round((doneToToday/planToToday)*100) : 0;

    const cutoffKey = todayIdx >=0 ? dKeys[todayIdx] : (todayKey < start ? start : end);
    let cutoffSuffix = '';
    if(todayIdx === -1 && todayKey < start){ cutoffSuffix = ' (hoy antes del rango)'; }
    else if(dKeys.length && todayIdx === dKeys.length-1 && todayKey > end){ cutoffSuffix = ' (hoy después del rango)'; }

    const lastIdxForLeader = todayIdx >=0 ? todayIdx : (todayKey < start ? -1 : dMeta.length - 1);
    const leaders = resps.map(r=>{
      let planAcc = 0, doneAcc = 0;
      if(lastIdxForLeader >= 0){
        for(let i=0; i<=lastIdxForLeader; i++){
          const key = dMeta[i].key;
          planAcc += planCounts[r][key] || 0;
          doneAcc += doneCounts[r][key] || 0;
        }
      }
      const pct = planAcc ? Math.round((doneAcc/planAcc)*100) : (doneAcc>0 ? 100 : 0);
      return { name: cap(r), plan: planAcc, done: doneAcc, pct };
    }).sort((a,b)=> b.done - a.done);

    const generalPlanTotal = (planRowsGeneral||[]).reduce((acc,p)=>{
      const resp = normResp(p[this.config.planRespField]);
      if(allowed.size && !allowed.has(resp)) return acc;
      return acc + (Number(p.valor)||0);
    }, 0);
    const generalDoneTotal = generalGroups.size;
    const generalPct = generalPlanTotal ? Math.round((generalDoneTotal/generalPlanTotal)*100) : 0;

    this.renderHeaderKpis({
      generalPlan: generalPlanTotal,
      generalDone: generalDoneTotal,
      generalPct,
      generalRange: `${generalStart} → ${generalEnd}`,
      todayPlan: planToToday,
      todayDone: doneToToday,
      todayPct,
      todayRange: `${start} → ${cutoffKey}${cutoffSuffix}`,
      leaders
    });

    this.renderTable({ dMeta, todayKey, todayIdx, doneCounts, planCounts, planComments });

    let nextDetailDay = null;
    if(this.activeDetailDay && dKeys.includes(this.activeDetailDay)){
      nextDetailDay = this.activeDetailDay;
    }else if(dKeys.includes(todayKey)){
      nextDetailDay = todayKey;
    }else if(dKeys.length){
      nextDetailDay = dKeys[dKeys.length - 1];
    }
    this.renderDailyDetail(nextDetailDay);

    this.renderCurve(dMeta, planDaily, doneDaily, todayIdx);
    this.renderTodaySummary(start, end, todayKey, cellMapDone);

    this.setStatus('Listo.');
  }

  renderHeaderKpis({ generalPlan, generalDone, generalPct, generalRange, todayPlan, todayDone, todayPct, todayRange, leaders }){
    const fmt = (n)=> numberFormatter.format(Math.round(n||0));
    this.kpi.header?.classList.add('compact');
    if(this.kpi.generalPlan) this.kpi.generalPlan.textContent = fmt(generalPlan);
    if(this.kpi.generalPlanRange) this.kpi.generalPlanRange.textContent = generalRange;
    if(this.kpi.generalDone) this.kpi.generalDone.textContent = fmt(generalDone);
    if(this.kpi.generalDoneRange) this.kpi.generalDoneRange.textContent = generalRange;
    if(this.kpi.generalPct) this.kpi.generalPct.textContent = `${Math.round(generalPct||0)}%`;
    if(this.kpi.todayPlan) this.kpi.todayPlan.textContent = fmt(todayPlan);
    if(this.kpi.todayDone) this.kpi.todayDone.textContent = fmt(todayDone);
    if(this.kpi.todayPct) this.kpi.todayPct.textContent = `${Math.round(todayPct||0)}%`;
    if(this.kpi.todayRange) this.kpi.todayRange.textContent = todayRange;
    if(this.kpi.leadersList){
      this.kpi.leadersList.classList.add('compact','twocol');
      if(!leaders || leaders.length === 0){
        this.kpi.leadersList.innerHTML = '<div class="muted">Sin responsables en el rango.</div>';
      }else{
        this.kpi.leadersList.innerHTML = leaders.map(l=>{
          const pct = Math.round(l.pct || 0);
          const doneLabel = fmt(l.done);
          const planLabel = l.plan > 0 ? fmt(l.plan) : '—';
          return `
            <div class="leader-row">
              <div class="leader-main">
                <span class="leader-name">${esc(l.name)}</span>
                <span class="badge">${doneLabel} / ${planLabel}</span>
              </div>
              <span class="leader-pct">${pct}%</span>
            </div>
          `;
        }).join('');
      }
    }
  }

  renderTable({ dMeta, todayKey, todayIdx, doneCounts, planCounts, planComments }){
    if(!this.table) return;
    const moduleKey = this.config.key;
    const resps = this.resps;

    let html = '<tr>';
    html += '<th class="sticky l1">RESPONSABLE</th>';
    html += '<th class="sticky l2">TIPO</th>';
    dMeta.forEach(({key,dow})=>{
      const d = parseYmd(key);
      const clsBase = dow===0 ? 'col-sun' : (dow===6 ? 'col-sat' : '');
      const clsToday = key===todayKey ? 'today-col' : '';
      const cls = `${clsBase} ${clsToday}`.trim();
      html += `<th class="${cls}">${String(d.getDate()).padStart(2,'0')}<div class="muted">${['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'][dow]}</div></th>`;
    });
    html += '<th>Total</th></tr>';

    if(resps.length === 0){
      html += `<tr><td colspan="${dMeta.length + 3}" class="muted" style="text-align:center;padding:16px 0">Sin responsables en el rango.</td></tr>`;
      this.table.innerHTML = html;
      this.scrollToToday(-1);
      return;
    }

    resps.forEach(r=>{
      const respLabel = esc(cap(r));
      const commentCols = new Map();

      let rowPlan = 0;
      html += '<tr class="plan-row">';
      html += `<td class="sticky l1" rowspan="2"><div class="resp-cell">${respLabel}</div></td>`;
      html += `<td class="sticky l2 type-cell">${esc(this.config.planLabel)}</td>`;
      dMeta.forEach(({key,dow})=>{
        const val = planCounts[r][key] || 0; rowPlan += val;
        const comment = planComments[r][key] || '';
        const trimmed = comment.trim().toLowerCase();
        const isBajada = trimmed === 'bajada';
        const hasComment = !!comment;
        if(hasComment) commentCols.set(key, { isBajada });
        const classes = [
          dow===0 ? 'col-sun' : (dow===6 ? 'col-sat' : ''),
          key===todayKey ? 'today-col' : '',
          hasComment ? `comment-cell${isBajada ? ' comment-bajada' : ''}` : ''
        ].filter(Boolean).join(' ');
        const showPin = this.editMode;
        const pinClasses = ['comment-pin'];
        if(hasComment) pinClasses.push('has-comment');
        else if(this.editMode) pinClasses.push('empty');
        if(isBajada) pinClasses.push('bajada');
        const ariaLabel = hasComment ? (this.editMode ? 'Editar comentario' : 'Ver comentario') : 'Agregar comentario';
        const pinHtml = showPin ? `<button type="button" class="${pinClasses.join(' ')}" data-module="${moduleKey}" data-resp="${r}" data-date="${key}" aria-label="${esc(ariaLabel)}"></button>` : '';

        if(this.editMode){
          const disabled = (dow===0 || dow===6) ? 'disabled' : '';
          html += `<td class="${classes}"><div class="plan-cell has-pin"><input class="ovr-input" data-module="${moduleKey}" data-resp="${r}" data-date="${key}" type="number" min="0" value="${val}" ${disabled}>${pinHtml}</div></td>`;
        }else{
          html += `<td class="${classes}"><div class="plan-cell readonly"><span class="value" data-open-comment="1" data-module="${moduleKey}" data-resp="${r}" data-date="${key}">${val}</span></div></td>`;
        }
      });
      html += `<td><b>${rowPlan}</b></td>`;
      html += '</tr>';

      let rowDone = 0;
      html += '<tr class="done-row">';
      html += `<td class="sticky l2 type-cell">${esc(this.config.doneLabel)}</td>`;
      dMeta.forEach(({key,dow})=>{
        const n = doneCounts[r][key] || 0; rowDone += n;
        const commentMeta = commentCols.get(key);
        const hasComment = !!commentMeta;
        const isBajada = commentMeta?.isBajada;
        const classes = [
          dow===0 ? 'col-sun' : (dow===6 ? 'col-sat' : ''),
          key===todayKey ? 'today-col' : '',
          hasComment ? `comment-cell comment-linked${isBajada ? ' comment-bajada' : ''}` : ''
        ].filter(Boolean).join(' ');
        if(n>0){
          html += `<td class="${classes} clickable" onclick="openReportCell('${moduleKey}','${r}','${key}')"><b>${n}</b></td>`;
        }else{
          html += `<td class="${classes} muted">0</td>`;
        }
      });
      html += `<td><b>${rowDone}</b></td>`;
      html += '</tr>';
    });

    this.table.innerHTML = html;
    this.attachTableEvents();
    this.currentTodayIdx = typeof todayIdx === 'number' ? todayIdx : -1;
    this.scrollToToday(this.currentTodayIdx);
  }

  attachTableEvents(){
    if(!this.table) return;
    this.table.querySelectorAll('.plan-cell.readonly [data-open-comment="1"]').forEach(el=>{
      el.addEventListener('click', ()=>{
        const resp = el.getAttribute('data-resp');
        const fecha = el.getAttribute('data-date');
        const current = this.planComments?.[resp]?.[fecha] || '';
        openCommentPopover(this, { resp, fecha, anchor: el, comment: current, editable: this.editMode });
      });
    });
    this.table.querySelectorAll('.comment-pin').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        const resp = btn.getAttribute('data-resp');
        const fecha = btn.getAttribute('data-date');
        const current = this.planComments?.[resp]?.[fecha] || '';
        openCommentPopover(this, { resp, fecha, anchor: btn, comment: current, editable: this.editMode });
      });
    });
    this.table.querySelectorAll('.ovr-input:not([disabled])').forEach(inp=>{
      inp.addEventListener('change', async (e)=>{
        const resp = e.target.getAttribute('data-resp');
        const fecha = e.target.getAttribute('data-date');
        const valor = Number(e.target.value)||0;
        try{
          await this.savePlanEntry(resp, fecha, { valor });
          this.setStatus('Planificado guardado ✓');
          await this.run();
        }catch(err){
          console.error(err);
          this.setStatus('Error al guardar planificado');
        }
      });
    });
  }

  scrollToToday(idx, opts = {}){
    if(idx == null || idx < 0) return;
    if(!this.tableWrap || !this.table) return;
    const { behavior = 'smooth', immediate = false } = opts;
    const applyScroll = ()=>{
      const headerRow = this.table.querySelector('tr');
      if(!headerRow) return;
      const target = headerRow.querySelector(`th:nth-child(${idx + 3})`);
      if(!target) return;
      const desired = target.offsetLeft - (this.tableWrap.clientWidth/2) + (target.offsetWidth/2);
      const left = desired < 0 ? 0 : desired;
      if(typeof this.tableWrap.scrollTo === 'function' && behavior !== 'auto'){
        this.tableWrap.scrollTo({ left, behavior });
      }else{
        this.tableWrap.scrollLeft = left;
      }
    };
    if(immediate){
      applyScroll();
    }else{
      requestAnimationFrame(applyScroll);
    }
  }

  syncBeforePrint(){
    if(this.currentTodayIdx == null || this.currentTodayIdx < 0) return;
    this.scrollToToday(this.currentTodayIdx, { behavior: 'auto', immediate: true });
  }

  renderCurve(dMeta, planDaily, doneDaily, todayIdx){
    if(!this.chartWrap || !this.chartCanvas){
      if(this.chart){ this.chart.destroy(); this.chart=null; }
      return;
    }
    if(!dMeta.length){
      this.chartWrap.style.display = 'none';
      if(this.chart){ this.chart.destroy(); this.chart=null; }
      return;
    }
    this.chartWrap.style.display = 'block';
    const ctx = this.chartCanvas.getContext('2d');
    if(this.chart) this.chart.destroy();
    if(!todayPluginRegistered){ Chart.register(TodayLinePlugin); todayPluginRegistered = true; }
    const labels = dMeta.map(({key})=>{
      const d = parseYmd(key);
      return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
    });
    const planCum = [];
    planDaily.reduce((acc,v)=>{ const next=acc+v; planCum.push(next); return next; },0);
    const doneCum = [];
    doneDaily.reduce((acc,v,idx)=>{
      if(todayIdx>=0 && idx>todayIdx){ doneCum.push(null); return acc; }
      const next=acc+v; doneCum.push(next); return next;
    },0);
    this.chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: `${this.config.planLabel} acumulado`, data: planCum, tension: 0.3, borderColor: '#0ea5e9', backgroundColor: 'rgba(14,165,233,.12)', fill: false, pointRadius: 3 },
          { label: `${this.config.doneLabel} acumulado`, data: doneCum, tension: 0.3, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,.12)', fill: false, pointRadius: 3, spanGaps: true }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { position: 'top' }, tooltip: { enabled: true }, todayLine: { index: todayIdx } },
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
      }
    });
  }

  renderDetail(resp, ymd){
    this.renderDailyDetail(ymd, resp);
  }

  renderDailyDetail(ymd, primaryResp = null){
    if(!this.detailEl){
      this.activeDetailDay = ymd || null;
      return;
    }
    if(!ymd){
      this.detailEl.innerHTML = '';
      this.detailEl.style.display = 'none';
      this.activeDetailDay = null;
      return;
    }

    this.activeDetailDay = ymd;
    const resps = Array.isArray(this.resps) ? [...this.resps] : [];
    if(primaryResp && resps.includes(primaryResp)){
      resps.splice(resps.indexOf(primaryResp), 1);
      resps.unshift(primaryResp);
    }

    const parsed = parseYmd(ymd);
    const isValid = !Number.isNaN(parsed?.getTime?.());
    const dateLabel = isValid
      ? `${String(parsed.getDate()).padStart(2,'0')}/${String(parsed.getMonth()+1).padStart(2,'0')}/${parsed.getFullYear()}`
      : ymd;

    const totalDay = resps.reduce((acc, r)=>{
      const list = this.cellMapDone?.get(`${r}|${ymd}`) || [];
      return acc + list.length;
    }, 0);
    const totalLabel = `${totalDay} ${totalDay === 1 ? 'expediente' : 'expedientes'}`;

    let sections = '';
    if(resps.length === 0){
      sections = '<div class="detail-section"><h4>Sin responsables</h4><div class="muted">No hay responsables en el rango seleccionado.</div></div>';
    }else{
      sections = resps.map(r=>{
        const list = this.cellMapDone?.get(`${r}|${ymd}`) || [];
        const commentRaw = this.planComments?.[r]?.[ymd] || '';
        const commentTrimmed = commentRaw.trim();
        const hasComment = commentTrimmed !== '';
        const isBajada = commentTrimmed.toLowerCase() === 'bajada';
        const commentBody = hasComment ? esc(commentRaw).replace(/\n/g,'<br>') : '';
        const commentHtml = hasComment
          ? `<div class="comment-preview${isBajada ? ' bajada' : ''}"><span class="comment-title">${isBajada ? 'Bajada' : 'Comentario'}</span>${commentBody}</div>`
          : '';
        const rows = list.map(g=>{
          const codes = g.cods.map(c=>`<button class="code-link" data-code="${esc(c)}" data-unir="${g.unirId}">${esc(c)}</button>`).join('');
          return `<tr><td>${esc(g.comunidad)}</td><td>${esc(g.codigo_mtc)}</td><td style="text-align:left">${codes}</td></tr>`;
        }).join('');
        const rowBody = rows || '<tr><td colspan="3" class="muted">Sin expedientes</td></tr>';
        const count = list.length;
        const countLabel = `${count} ${count === 1 ? 'expediente' : 'expedientes'}`;
        const classes = ['detail-section'];
        if(primaryResp && r === primaryResp) classes.push('active');
        return `<div class="${classes.join(' ')}">
          <h4>${esc(cap(r))} · ${countLabel}</h4>
          ${commentHtml}
          <div style="overflow:auto"><table class="report">
            <thead><tr><th>Comunidad</th><th>Código MTC</th><th>cod_prel (grupo UNIR)</th></tr></thead>
            <tbody>${rowBody}</tbody>
          </table></div>
        </div>`;
      }).join('');
    }

    this.detailEl.innerHTML = `
      <div class="label">${esc(this.config.detailTitlePrefix || 'Detalle')} — ${dateLabel} · ${totalLabel}</div>
      <div class="detail-sections">${sections}</div>`;
    this.detailEl.style.display = 'block';
  }

  renderTodaySummary(start, end, todayKey, cellMapDone){
    if(!this.todaySummaryEl) return;
    if(start !== end || start !== todayKey){
      this.todaySummaryEl.style.display = 'none';
      this.todaySummaryEl.innerHTML = '';
      return;
    }
    const hasCommentFor = (resp)=>{
      const raw = this.planComments?.[resp]?.[todayKey] || '';
      return raw.trim() !== '';
    };
    const sections = this.resps.map(r=>({
      resp: r,
      list: cellMapDone.get(`${r}|${todayKey}`) || []
    })).filter(item => item.list.length > 0 || hasCommentFor(item.resp));

    if(sections.length === 0){
      this.todaySummaryEl.innerHTML = '<div class="muted">Sin expedientes con avance hoy.</div>';
      this.todaySummaryEl.style.display = 'block';
      return;
    }

    const body = sections.map(item=>{
      const commentRaw = this.planComments?.[item.resp]?.[todayKey] || '';
      const commentTrimmed = commentRaw.trim();
      const hasComment = commentTrimmed !== '';
      const isBajada = commentTrimmed.toLowerCase() === 'bajada';
      const commentBody = hasComment ? esc(commentRaw).replace(/\n/g,'<br>') : '';
      const commentHtml = hasComment
        ? `<div class="comment-preview${isBajada ? ' bajada' : ''}"><span class="comment-title">${isBajada ? 'Bajada' : 'Comentario'}</span>${commentBody}</div>`
        : '';
      const rows = item.list.map(g=>{
        const codes = g.cods.map(c=>`<button class="code-link" data-code="${esc(c)}" data-unir="${g.unirId}">${esc(c)}</button>`).join('');
        return `<tr><td>${esc(g.comunidad)}</td><td>${esc(g.codigo_mtc)}</td><td style="text-align:left">${codes}</td></tr>`;
      }).join('');
      const tableBody = rows || '<tr><td colspan="3" class="muted">Sin expedientes</td></tr>';
      return `<div class="today-section"><h4>${esc(cap(item.resp))}</h4>${commentHtml}<table class="report" style="width:100%"><thead><tr><th>Comunidad</th><th>Código MTC</th><th>cod_prel</th></tr></thead><tbody>${tableBody}</tbody></table></div>`;
    }).join('');

    const suffix = this.config.todaySummaryTitle ? ` ${esc(this.config.todaySummaryTitle)}` : '';
    this.todaySummaryEl.innerHTML = `
      <div class="label">Reporte de avance${suffix} — ${todayKey}</div>
      <div class="today-sections">${body}</div>`;
    this.todaySummaryEl.style.display = 'block';
  }

  toggleEdit(){
    if(!this.toggleBtn) return;
    if(!this.editMode){
      const input = prompt('Ingresa la contraseña para editar el planificado:');
      if(input === null) return;
      if(input !== this.config.editPassword){
        alert('Contraseña incorrecta');
        return;
      }
    }
    this.editMode = !this.editMode;
    this.toggleBtn.textContent = this.editMode ? '✅ Terminar edición' : '✏️ Editar Planificado';
    this.run();
  }
}

function closeCommentPopover(){
  if(!commentPopoverEl) return;
  commentPopoverEl.classList.remove('open');
  commentPopoverEl.innerHTML = '';
  commentPopoverEl.setAttribute('aria-modal','false');
  document.removeEventListener('mousedown', handleCommentOutside);
  document.removeEventListener('keydown', handleCommentEscape);
  commentPopoverState = null;
  activeCommentModule = null;
}

function handleCommentOutside(e){
  if(!commentPopoverEl || !commentPopoverEl.classList.contains('open')) return;
  if(commentPopoverEl.contains(e.target)) return;
  if(commentPopoverState?.anchor && commentPopoverState.anchor.contains(e.target)) return;
  closeCommentPopover();
}

function handleCommentEscape(e){ if(e.key === 'Escape') closeCommentPopover(); }

function openCommentPopover(module, { resp, fecha, anchor, comment, editable }){
  if(!commentPopoverEl || !anchor || !module) return;
  if(activeCommentModule === module && commentPopoverState && commentPopoverState.anchor === anchor && commentPopoverEl.classList.contains('open')){
    closeCommentPopover();
    return;
  }
  closeCommentPopover();

  activeCommentModule = module;
  commentPopoverState = { module, resp, fecha, anchor, editable };
  const title = `Comentario — ${cap(resp)} (${fecha})`;
  let inner = `<h5>${esc(title)}</h5>`;

  if(editable){
    inner += `
      <textarea id="commentInput" placeholder="Escribe un comentario..."></textarea>
      <div class="actions">
        ${comment ? '<button type="button" data-action="delete" class="danger">Eliminar</button>' : ''}
        <button type="button" data-action="cancel">Cancelar</button>
        <button type="button" data-action="save" class="primary">Guardar</button>
      </div>`;
  }else{
    const body = comment ? esc(comment).replace(/\n/g,'<br>') : '<span class="muted">Sin comentario</span>';
    inner += `
      <div class="comment-text">${body}</div>
      <div class="actions"><button type="button" data-action="close" class="primary">Cerrar</button></div>`;
  }

  commentPopoverEl.innerHTML = inner;
  commentPopoverEl.classList.add('open');
  commentPopoverEl.setAttribute('aria-modal', editable ? 'true' : 'false');

  requestAnimationFrame(()=>{
    const rect = anchor.getBoundingClientRect();
    const popWidth = commentPopoverEl.offsetWidth;
    const popHeight = commentPopoverEl.offsetHeight;
    let left = rect.left + window.scrollX + (rect.width/2) - (popWidth/2);
    const minLeft = window.scrollX + 12;
    const maxLeft = window.scrollX + window.innerWidth - popWidth - 12;
    if(left < minLeft) left = minLeft;
    if(left > maxLeft) left = maxLeft;
    let top = rect.bottom + window.scrollY + 8;
    const maxTop = window.scrollY + window.innerHeight - popHeight - 12;
    if(top > maxTop){
      top = rect.top + window.scrollY - popHeight - 8;
      if(top < window.scrollY + 12) top = window.scrollY + 12;
    }
    commentPopoverEl.style.left = `${left}px`;
    commentPopoverEl.style.top = `${top}px`;
  });

  if(editable){
    const textarea = commentPopoverEl.querySelector('#commentInput');
    if(textarea){ textarea.value = comment || ''; textarea.focus(); }
    const saveBtn = commentPopoverEl.querySelector('[data-action="save"]');
    if(saveBtn){
      saveBtn.addEventListener('click', async ()=>{
        if(!textarea) return;
        const raw = textarea.value;
        const trimmed = raw.trim();
        const payload = { coment: trimmed === '' ? null : raw };
        try{
          await module.savePlanEntry(resp, fecha, payload);
          module.setStatus(trimmed === '' ? 'Comentario eliminado ✓' : 'Comentario guardado ✓');
          closeCommentPopover();
          await module.run();
        }catch(err){
          console.error(err);
          module.setStatus('Error al guardar comentario');
        }
      });
    }
    const cancelBtn = commentPopoverEl.querySelector('[data-action="cancel"]');
    if(cancelBtn) cancelBtn.addEventListener('click', closeCommentPopover);
    const deleteBtn = commentPopoverEl.querySelector('[data-action="delete"]');
    if(deleteBtn){
      deleteBtn.addEventListener('click', async ()=>{
        try{
          await module.savePlanEntry(resp, fecha, { coment: null });
          module.setStatus('Comentario eliminado ✓');
          closeCommentPopover();
          await module.run();
        }catch(err){
          console.error(err);
          module.setStatus('Error al eliminar comentario');
        }
      });
    }
  }else{
    const closeBtn = commentPopoverEl.querySelector('[data-action="close"]');
    if(closeBtn) closeBtn.addEventListener('click', closeCommentPopover);
  }

  document.addEventListener('mousedown', handleCommentOutside);
  document.addEventListener('keydown', handleCommentEscape);
}

window.openReportCell = function(moduleKey, resp, ymd){
  const module = REPORT_MODULES[moduleKey];
  module?.renderDetail(resp, ymd);
};

const TodayLinePlugin = {
  id:'todayLine',
  afterDatasetsDraw(chart, args, opts){
    const idx = opts?.index;
    if(idx == null || idx < 0) return;
    const {ctx, chartArea, scales} = chart;
    if(!chartArea || !scales?.x) return;
    const x = scales.x.getPixelForValue(idx);
    ctx.save();
    ctx.strokeStyle = 'rgba(99,102,241,.6)';
    ctx.setLineDash([4,4]);
    ctx.beginPath();
    ctx.moveTo(x, chartArea.top);
    ctx.lineTo(x, chartArea.bottom);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#312e81';
    ctx.font = '12px system-ui, sans-serif';
    ctx.fillText('Hoy', x + 6, chartArea.top + 14);
    ctx.restore();
  }
};
let todayPluginRegistered = false;

function buildGroupsMap(rows, allowed = new Set(), respField = 'responsable', dateField = 'fecha_elab'){
  const map = new Map();
  (rows||[]).forEach(r=>{
    const resp = normResp(r?.[respField]);
    if(!resp) return;
    if(allowed.size && !allowed.has(resp)) return;
    const key = r?.unir;
    if(key == null) return;
    if(!map.has(key)){
      map.set(key, {
        responsable: resp,
        fecha: (r?.[dateField]||'').toString().slice(0,10),
        comunidad: r?.comunidad || '',
        codigo_mtc: r?.codigo_mtc || '',
        unirId: key,
        cods: []
      });
    }
    map.get(key).cods.push(r?.cod_prel || '');
  });
  return map;
}

const reportTech = new ReportModule({
  key: 'tech',
  openBtnId: 'btnReport',
  drawerId: 'reportDrawer',
  closeBtnId: 'rp_close',
  startInputId: 'rp_start',
  endInputId: 'rp_end',
  runBtnId: 'rp_run',
  todayButtonId: 'rp_todayBtn',
  toggleBtnId: 'rp_toggleEdit',
  printBtnId: 'rp_print',
  statusId: 'rp_status',
  chipsContainerId: 'rp_chips',
  tableId: 'rp_table',
  tableWrapId: 'rp_tableWrap',
  chartWrapId: 'chartWrap',
  chartCanvasId: 'rp_chart',
  detailId: 'rp_detail',
  todaySummaryId: 'rp_todaySummary',
  kpi: {
    headerId: 'rp_kpiHeader',
    generalPlanId: 'kpiGeneralPlan',
    generalPlanRangeId: 'kpiGeneralPlanRange',
    generalDoneId: 'kpiGeneralDone',
    generalDoneRangeId: 'kpiGeneralDoneRange',
    generalPctId: 'kpiGeneralPct',
    todayPlanId: 'kpiTodayPlan',
    todayDoneId: 'kpiTodayDone',
    todayPctId: 'kpiTodayPct',
    todayRangeId: 'kpiTodayRange',
    leadersListId: 'kpiLeaderList'
  },
  respField: 'responsable',
  dateField: 'fecha_elab',
  planTable: 'plan_pred',
  planRespField: 'responsable',
  planOnConflict: 'responsable,fecha',
  editPassword: 'assa$2025',
  planLabel: 'Planificado',
  doneLabel: 'Elaborado',
  detailTitlePrefix: 'Detalle',
  todaySummaryTitle: 'técnico',
  printTitle: 'Reporte — Planificado vs Elaborado'
});

const reportLegal = new ReportModule({
  key: 'legal',
  openBtnId: 'btnLegalReport',
  drawerId: 'legalReportDrawer',
  closeBtnId: 'lr_close',
  startInputId: 'lr_start',
  endInputId: 'lr_end',
  runBtnId: 'lr_run',
  toggleBtnId: 'lr_toggleEdit',
  printBtnId: 'lr_print',
  statusId: 'lr_status',
  chipsContainerId: 'lr_chips',
  tableId: 'lr_table',
  tableWrapId: 'lr_tableWrap',
  chartWrapId: 'lr_chartWrap',
  chartCanvasId: 'lr_chart',
  detailId: 'lr_detail',
  todaySummaryId: 'lr_todaySummary',
  kpi: {
    headerId: 'lr_kpiHeader',
    generalPlanId: 'lkpiGeneralPlan',
    generalPlanRangeId: 'lkpiGeneralPlanRange',
    generalDoneId: 'lkpiGeneralDone',
    generalDoneRangeId: 'lkpiGeneralDoneRange',
    generalPctId: 'lkpiGeneralPct',
    todayPlanId: 'lkpiTodayPlan',
    todayDoneId: 'lkpiTodayDone',
    todayPctId: 'lkpiTodayPct',
    todayRangeId: 'lkpiTodayRange',
    leadersListId: 'lkpiLeaderList'
  },
  respField: 'resp_legal',
  dateField: 'avance_legal',
  planTable: 'plan_pred_legal',
  planRespField: 'resp_legal',
  planOnConflict: 'resp_legal,fecha',
  editPassword: 'assa$2025',
  planLabel: 'Planificado',
  doneLabel: 'Avance',
  detailTitlePrefix: 'Detalle legal',
  todaySummaryTitle: 'legal',
  printTitle: 'Reporte — Avance Legal'
});

window.reportTech = reportTech;
window.reportLegal = reportLegal;

const syncReportScrollForPrint = ()=>{
  Object.values(REPORT_MODULES).forEach(mod=>{
    if(mod && typeof mod.syncBeforePrint === 'function'){
      mod.syncBeforePrint();
    }
  });
};

window.addEventListener('beforeprint', syncReportScrollForPrint);

if(window.matchMedia){
  const mq = window.matchMedia('print');
  const mqListener = e=>{ if(e.matches) syncReportScrollForPrint(); };
  if(typeof mq.addEventListener === 'function') mq.addEventListener('change', mqListener);
  else if(typeof mq.addListener === 'function') mq.addListener(mqListener);
}

function esc(s){ return (s??"").toString().replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function cap(r){ return (r||"").replace(/\b\w/g,m=>m.toUpperCase()); }
function normResp(v){ return (v??"").toString().trim().toLowerCase(); }

/** ====== RESIZER ====== **/
(function initGutter(){
  const left = document.getElementById("leftPane");
  const gutter = document.getElementById("gutter");
  let dragging=false, startX=0, startLeft=0;
  gutter.addEventListener("mousedown",(e)=>{
    dragging=true; startX=e.clientX; startLeft=left.getBoundingClientRect().width;
    document.body.style.userSelect="none";
  });
  window.addEventListener("mousemove",(e)=>{
    if(!dragging) return;
    const dx = e.clientX - startX;
    const newW = Math.max(280, Math.min(window.innerWidth-280, startLeft + dx));
    const percent = (newW / window.innerWidth) * 100;
    left.style.flexBasis = percent + "%";
    setTimeout(()=> map.invalidateSize(), 0);
  });
  window.addEventListener("mouseup",()=>{ dragging=false; document.body.style.userSelect=""; });
})();

/** ====== INIT ====== **/
(async function init(){
  await hydrateFilterOptions();
  await fetchResponsables();
  await loadAllPredios();
})();
</script>
</body>
</html>
