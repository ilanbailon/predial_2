<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Geoportal Predial</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --brand:#0f172a; --accent:#0ea5e9; --accent-dark:#0369a1;
      --panel-bg:#f8fafc; --card:#ffffff; --line:#e2e8f0;
      --predio:#0ea5e9; --comunidad:#22c55e; --otros:#a855f7; --highlight:#e11d48;
      --text:#0f172a;

      --sat:#e0f2ff;   /* s√°bado (azul muy claro)   */
      --sun:#fee2e2;   /* domingo (rojito)          */
      --plan0:#ffe4e6; /* planificado = 0 (rojito)  */
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;overflow:hidden;}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:10px 16px;background:var(--brand);color:#fff;position:relative;z-index:5000;
      box-shadow:0 2px 10px rgba(0,0,0,.25);
    }
    header .title{font-weight:700;letter-spacing:.3px}
    #centerControls{flex:1;display:flex;justify-content:center;position:relative}
    #searchWrap{position:relative;width:min(520px,90%)}
    #searchBox{
      width:100%;padding:10px 14px;border-radius:24px;border:none;outline:none;
      font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,.15) inset, 0 1px 0 rgba(255,255,255,.1);
      color:var(--text);
    }
    #suggestions{
      position:absolute;left:0;right:0;top:44px;background:#fff;
      border:1px solid var(--line);border-radius:10px;z-index:6000;
      max-height:240px;overflow:auto;display:none;color:var(--text);
    }
    #suggestions.active{display:block}
    #suggestions div{padding:8px 10px;cursor:pointer;color:var(--text)}
    #suggestions div:hover{background:#f1f5f9}

    #rightControls{display:flex;align-items:center;gap:8px}
    select,button{padding:8px 10px;border-radius:8px;border:1px solid transparent;font-size:14px}
    select{background:#fff;border-color:var(--line);color:var(--text)}
    .btn{background:var(--accent);color:#fff;cursor:pointer}
    .btn:hover{background:var(--accent-dark)}
    .ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.35)}
    .ghost:hover{border-color:#fff}

    #split{display:flex;height:calc(100% - 60px);min-height:300px}
    #leftPane{flex-basis:60%;position:relative;background:#000}
    #rightPane{flex:1;background:var(--panel-bg);border-left:1px solid var(--line);overflow:auto}
    #gutter{width:6px;cursor:col-resize;background:linear-gradient(90deg,transparent,rgba(0,0,0,.08),transparent)}
    #map{position:absolute;inset:0}

    .panel{padding:16px}
    h3{margin:8px 0 12px;color:var(--accent-dark)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .block{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .label{font-weight:700;margin-bottom:4px}
    .textblock{white-space:pre-line;background:#fff;border:1px solid var(--line);border-radius:8px;padding:8px;color:var(--text)}
    .area-card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:10px;margin:10px 0; transition: box-shadow .2s, background .2s}
    .area-card h4{margin:0 0 6px;color:var(--accent)}
    .area-actions{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .pill:hover{border-color:var(--accent)}
    .muted{color:#64748b;font-size:12px}
    .badge{background:#eef2ff;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;color:var(--text)}
    input,textarea{width:100%;padding:6px;border:1px solid var(--line);border-radius:8px;color:var(--text)}
    .btn-small{padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn-small:hover{border-color:var(--accent)}
    td.clickable{cursor:pointer;text-decoration:underline}

    /* ===== Drawer Reporte ===== */
    .drawer{
      position:fixed; top:60px; right:0;
      width:min(1100px,92vw); height:calc(100% - 60px);
      background:#fff; border-left:1px solid #e5e7eb; box-shadow:-12px 0 30px rgba(0,0,0,.15);
      transform:translateX(100%); transition:transform .25s ease; z-index:6000; overflow:auto;
    }
    .drawer.open{ transform:translateX(0); }
    .drawer-head{display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;padding:12px 16px;z-index:1}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px 16px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #e2e8f0;border-radius:999px;background:#fff;cursor:pointer;margin-right:6px;margin-bottom:6px}
    .chip input{transform:scale(1.1)}
    .chip.active{background:#eef7ff;border-color:#bfdbfe}
    .kpi-line{display:flex;gap:10px;flex-wrap:wrap;margin:8px 16px}
    .kpi{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px;min-width:160px}
    .kpi .val{font-weight:800;font-size:20px}
    table.report{border-collapse:collapse;width:calc(100% - 32px);margin:0 16px 12px}
    table.report th, table.report td{border:1px solid #e5e7eb;padding:6px 8px;text-align:center;vertical-align:top;background:#fff}
    th.sticky{position:sticky;z-index:3;background:#f6f6f6}
    td.sticky{position:sticky;z-index:2;background:#fff}
    th.sticky.l1, td.sticky.l1 { left:0; min-width:220px; text-align:left;}
    .ovr-input{width:64px;padding:4px 6px;border:1px solid #cbd5e1;border-radius:8px;text-align:center}

    /* Colores especiales en reporte */
    .col-sat{ background:var(--sat) !important; }
    .col-sun{ background:var(--sun) !important; }
    .plan-zero{ background:var(--plan0) !important; }

    #chartWrap{margin:12px 16px 16px;border:1px solid #eee;border-radius:10px;padding:10px;background:#fff}
    #rp_detail{margin:0 16px 16px;border:1px dashed #e5e7eb;border-radius:10px;padding:10px;background:#fafafa}

    /* Modal √Årea */
    .modal-back{
      position:fixed; inset:60px 0 0 0; display:none;
      align-items:center; justify-content:center; background:rgba(0,0,0,.25); z-index:7000;
    }
    .modal{
      width:min(820px,92vw); background:#fff; border-radius:12px; padding:12px;
      box-shadow:0 20px 40px rgba(0,0,0,.25);
    }

    /* flash highlight for selected area card */
    @keyframes flash {
      0% { box-shadow:0 0 0 rgba(14,165,233,0); background:#fff; }
      20%{ box-shadow:0 0 0 6px rgba(14,165,233,.15); background:#e0f2fe; }
      100%{ box-shadow:0 0 0 rgba(14,165,233,0); background:#fff; }
    }
    .flash { animation: flash 1s ease-out 1; }
  </style>
</head>
<body>
  <header>
    <div class="title">Geoportal Predial</div>

    <div id="centerControls">
      <div id="searchWrap">
        <input id="searchBox" type="text" placeholder="üîç Buscar cod_prel o cod_mtc‚Ä¶" autocomplete="off" />
        <div id="suggestions"></div>
      </div>
    </div>

    <div id="rightControls">
      <button class="ghost" id="btnReport">üìä Reporte</button>
      <select id="filterComunidad"><option value="">Comunidad (todas)</option></select>
      <select id="filterGrupo">
        <option value="">Grupo (todos)</option>
        <option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option>
        <option value="1er_entregable">1er_entregable</option>
      </select>
      <button class="btn" id="btnFiltrar">Filtrar</button>
      <button class="ghost" id="btnReset">Reset</button>
    </div>
  </header>

  <div id="split">
    <section id="leftPane"><div id="map"></div></section>
    <div id="gutter" title="Arrastra para redimensionar"></div>
    <section id="rightPane">
      <div class="panel">
        <h3>Detalle del predio</h3>

        <!-- Datos comunes -->
        <div id="commonBlock" class="block" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <div style="display:flex;align-items:center;gap:8px;">
              <div class="label">Datos:</div>
              <span id="unionCount" class="badge"></span>
            </div>
            <div><button id="btnEditCommon" class="btn-small">‚úèÔ∏è Editar :</button></div>
          </div>

          <!-- Lectura -->
          <div id="commonView">
            <div class="grid-2">
              <div><div class="label">C√≥digo MTC</div><div id="cm_mtc" class="textblock"></div></div>
              <div><div class="label">Comunidad</div><div id="cm_comunidad" class="textblock"></div></div>
              <div style="grid-column:1/-1"><div class="label">Titular</div><div id="cm_titular" class="textblock"></div></div>
              <div style="grid-column:1/-1"><div class="label">DNI / RUC</div><div id="cm_dni" class="textblock"></div></div>
              <div style="grid-column:1/-1"><div class="label">Contacto</div><div id="cm_contacto" class="textblock"></div></div>
              <div><div class="label">Condici√≥n</div><div id="cm_condicion" class="textblock"></div></div>
              <div><div class="label">Tipo</div><div id="cm_tipo" class="textblock"></div></div>
              <div><div class="label">Responsable</div><div id="cm_responsable" class="textblock"></div></div>
              <div><div class="label">Grupo</div><div id="cm_grupo" class="textblock"></div></div>
              <div><div class="label">Fecha elaboraci√≥n</div><div id="cm_fecha" class="textblock"></div></div>
            </div>
          </div>

          <!-- Edici√≥n -->
          <div id="commonEdit" style="display:none">
            <div class="grid-2">
              <div><div class="label">C√≥digo MTC</div><input id="ed_mtc" type="text"></div>
              <div><div class="label">Comunidad</div><input id="ed_comunidad" type="text"></div>
              <div style="grid-column:1/-1"><div class="label">Titular</div><textarea id="ed_titular" rows="3" style="white-space:pre-line"></textarea></div>
              <div style="grid-column:1/-1"><div class="label">DNI / RUC</div><textarea id="ed_dni" rows="2" style="white-space:pre-line"></textarea></div>
              <div style="grid-column:1/-1"><div class="label">Contacto</div><textarea id="ed_contacto" rows="2" style="white-space:pre-line"></textarea></div>
              <div><div class="label">Condici√≥n</div><input id="ed_condicion" type="text"></div>
              <div>
                <div class="label">Tipo</div>
                <select id="ed_tipo">
                  <option value="predios">predios</option>
                  <option value="comunidad">comunidad</option>
                </select>
              </div>
              <div>
                <div class="label">Responsable</div>
                <select id="ed_responsable"></select>
              </div>
              <div>
                <div class="label">Grupo</div>
                <select id="ed_grupo">
                  <option value="">‚Äî</option>
                  <option value="1">1</option><option value="2">2</option>
                  <option value="3">3</option><option value="4">4</option>
                  <option value="1er_entregable">1er_entregable</option>
                </select>
              </div>
              <div><div class="label">Fecha elaboraci√≥n</div><input id="ed_fecha" type="date"></div>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
              <button id="btnCancelCommon" class="btn-small">Cancelar</button>
              <button id="btnSaveCommon" class="btn">Guardar</button>
            </div>
          </div>
        </div>

        <!-- √Åreas afectadas -->
        <div id="areasWrap" class="block" style="display:none">
          <div class="label">√Åreas afectadas</div>
          <div id="areasList"></div>
        </div>

        <div id="emptyHint" class="muted">Selecciona un pol√≠gono o busca por c√≥digo.</div>
      </div>
    </section>
  </div>

  <!-- Modal Detalle de √Årea -->
  <div id="modalAreaBack" class="modal-back" style="display:none">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3>Detalles del √Årea Afectada</h3>
        <button class="btn-small" onclick="closeAreaModal()">‚úï</button>
      </div>
      <div class="grid-2">
        <div><div class="label">cod_prel</div><input id="a_cod_prel" type="text" disabled></div>
        <div><div class="label">√Årea</div><input id="a_area" type="text"></div>
        <div><div class="label">Per√≠metro</div><input id="a_perimetro" type="text"></div>
        <div><div class="label">Prog. Ini</div><input id="a_prog_ini" type="text"></div>
        <div><div class="label">Prog. Fin</div><input id="a_prog_fin" type="text"></div>
        <div><div class="label">Lado</div><input id="a_lado" type="text"></div>
        <div style="grid-column:1/-1"><div class="label">Obra complementaria</div><textarea id="a_obra" rows="3" style="white-space:pre-line"></textarea></div>
        <div style="grid-column:1/-1"><div class="label">Plantaciones</div><textarea id="a_plantaciones" rows="3" style="white-space:pre-line"></textarea></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn-small" onclick="closeAreaModal()">Cancelar</button>
        <button class="btn" onclick="saveArea()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Drawer Reporte -->
  <aside id="reportDrawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <h3 style="margin:0">Reporte ‚Äî Planificado (manual) vs Elaborado (por UNIR)</h3>
      <button class="btn-small" id="rp_close">‚úï</button>
    </div>

    <div class="row">
      <label>Desde: <input id="rp_start" type="date"></label>
      <label>Hasta: <input id="rp_end" type="date"></label>
      <button class="btn" id="rp_run">Generar</button>
      <!-- Un solo bot√≥n para editar todo -->
      <button class="ghost" id="rp_toggleEdit">‚úèÔ∏è Editar Planificado</button>
      <span id="rp_status" class="muted"></span>
    </div>

    <div id="rp_chips" class="row" style="margin-top:-8px"></div>

    <div class="kpi-line">
      <div class="kpi"><div class="label">Total Elaborado (rango, por UNIR)</div><div id="kpi_total" class="val">‚Äî</div></div>
      <div class="kpi"><div class="label">Responsables activos</div><div id="kpi_resps" class="val">‚Äî</div></div>
    </div>

    <div style="overflow:auto;border:1px solid #eee;border-radius:10px;margin:0 16px 12px">
      <table id="rp_table" class="report"></table>
    </div>

    <div id="chartWrap" style="display:none">
      <canvas id="rp_chart" height="280"></canvas>
    </div>

    <div id="rp_detail" style="display:none"></div>
  </aside>

<script>
/** ====== CONFIG ====== **/
const SUPABASE_URL = "https://wbzxbfqowlfmmkwqeyam.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndienhiZnFvd2xmbW1rd3FleWFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODUwMDQsImV4cCI6MjA3MjU2MTAwNH0.mJJ7yID73tUerWE_aiNw3ZE4o-Q9YrT39YN-iS2CksA";
const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/** ====== Helpers de fecha (evitar desfase -05:00) ====== **/
function parseYmd(ymd){ const [y,m,d] = ymd.split("-").map(Number); return new Date(y, (m||1)-1, d||1); } // Local
function ymdFromDateLocal(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
function dateKey(d){ return ymdFromDateLocal(d); }
function buildDays(from, to){
  const a=[]; const cur=new Date(from.getFullYear(), from.getMonth(), from.getDate());
  const end=new Date(to.getFullYear(), to.getMonth(), to.getDate());
  while(cur<=end){ a.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
  return a;
}

/** ====== MAP (sin logo Leaflet) ====== **/
const map = L.map('map', { zoomControl:true, attributionControl:false }).setView([-15.5, -70.1], 17);
L.control.attribution({ prefix:false }).addTo(map);
L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom:21, attribution:'¬© Google' }).addTo(map);

const normalStyle   = { color:"var(--predio)",    weight:2, fillOpacity:0.2 };
const commStyle     = { color:"var(--comunidad)", weight:2, fillOpacity:0.2 };
const otherStyle    = { color:"var(--otros)",     weight:2, fillOpacity:0.2 };
const highlightStyle= { color:"var(--highlight)", weight:3, fillOpacity:0.4 };

let selectedCodPrel = null;
let currentUnirId = null;

const capaPredio    = L.geoJSON(null, { style: normalStyle }).addTo(map);
const capaComunidad = L.geoJSON(null, { style: commStyle   }).addTo(map);
const capaOtros     = L.geoJSON(null, { style: otherStyle  }).addTo(map);

L.control.layers(null, { "Predios":capaPredio, "Comunidades":capaComunidad, "Otros":capaOtros }).addTo(map);

function isPredios(v){ return (v||"").toLowerCase() === "predios" || (v||"").toLowerCase() === "predio"; }
function isComunidad(v){ return (v||"").toLowerCase() === "comunidad"; }
function styleByTipo(t){ return isComunidad(t) ? commStyle : isPredios(t) ? normalStyle : otherStyle; }

/** ====== DATA LOAD ====== **/
async function loadAllPredios(){
  const { data, error } = await client
    .from("cod_pred")
    .select("cod_prel,unir,comunidad,condicion,grupo,codigo_mtc,titular,tipo,geom");
  if(error){ console.error(error); return; }

  capaPredio.clearLayers(); capaComunidad.clearLayers(); capaOtros.clearLayers();

  (data||[]).forEach(p=>{
    if(!p.geom) return;
    const f = { type:"Feature", geometry:p.geom, properties:p };
    const layer = L.geoJSON(f, { style: styleByTipo(p.tipo) });
    layer.on("click", () => { selectedCodPrel = p.cod_prel; showGroup(p.unir); });
    if(isComunidad(p.tipo)) layer.addTo(capaComunidad);
    else if(isPredios(p.tipo)) layer.addTo(capaPredio);
    else layer.addTo(capaOtros);
  });

  const bounds = capaPredio.getLayers().length ? capaPredio.getBounds()
               : capaComunidad.getLayers().length ? capaComunidad.getBounds()
               : capaOtros.getLayers().length ? capaOtros.getBounds() : null;
  if(bounds) map.fitBounds(bounds);
}

/** ====== DESTACAR GRUPO ====== **/
function highlightGroup(unirId, zoomTo=true){
  let groupBounds = null;
  const restyle = (grp)=>{
    grp.eachLayer(l=>{
      const props = l.feature?.properties;
      const setLayer = (ly, pr)=>{
        const match = pr.unir === unirId;
        ly.setStyle(match ? highlightStyle : styleByTipo(pr.tipo));
        if(match){ ly.bringToFront(); if(ly.getBounds){ groupBounds = groupBounds ? groupBounds.extend(ly.getBounds()) : ly.getBounds(); } }
      };
      if(props) setLayer(l, props);
      l.eachLayer?.((sub)=>{ if(sub.feature?.properties) setLayer(sub, sub.feature.properties); });
    });
  };
  [capaPredio, capaComunidad, capaOtros].forEach(restyle);
  if(groupBounds && zoomTo) map.fitBounds(groupBounds, { padding:[40,40], maxZoom:20 });
}

/** ====== UI PANEL ====== **/
const blockCommon  = document.getElementById("commonBlock");
const wrapAreas    = document.getElementById("areasWrap");
const listAreas    = document.getElementById("areasList");
const emptyHint    = document.getElementById("emptyHint");
const unionCount   = document.getElementById("unionCount");

const commonView   = document.getElementById("commonView");
const commonEdit   = document.getElementById("commonEdit");
const btnEditCommon= document.getElementById("btnEditCommon");
const btnSaveCommon= document.getElementById("btnSaveCommon");
const btnCancelCommon= document.getElementById("btnCancelCommon");

let currentCommon = null;

async function showGroup(unirId){
  const { data, error } = await client.from("cod_pred").select("*").eq("unir", unirId);
  if(error || !data?.length){ return; }

  currentUnirId = unirId;
  highlightGroup(unirId, true);
  unionCount.textContent = `Se unen: ${data.length} ${data.length===1?'c√≥digo':'c√≥digos'}`;

  const c = data[0];
  currentCommon = {
    codigo_mtc: c.codigo_mtc || "",
    titular:    c.titular    || "",
    dni_ruc:    c.dni_ruc    || "",
    contacto:   c.contacto   || "",
    comunidad:  c.comunidad  || "",
    condicion:  c.condicion  || "",
    tipo:       normTipo(c.tipo),
    responsable:c.responsable || "",
    grupo:      c.grupo       || "",
    fecha:      c.fecha_elab  || ""
  };

  blockCommon.style.display = "";
  wrapAreas.style.display = "";
  emptyHint.style.display = "none";

  setText("cm_mtc", currentCommon.codigo_mtc);
  setText("cm_titular", currentCommon.titular);
  setText("cm_dni", currentCommon.dni_ruc);
  setText("cm_contacto", currentCommon.contacto);
  setText("cm_comunidad", currentCommon.comunidad);
  setText("cm_condicion", currentCommon.condicion);
  setText("cm_tipo", currentCommon.tipo || "predios");
  setText("cm_responsable", cap(currentCommon.responsable));
  setText("cm_grupo", currentCommon.grupo);
  setText("cm_fecha", currentCommon.fecha ? String(currentCommon.fecha).slice(0,10) : "");

  setVal("ed_mtc", currentCommon.codigo_mtc);
  setVal("ed_titular", currentCommon.titular);
  setVal("ed_dni", currentCommon.dni_ruc);
  setVal("ed_contacto", currentCommon.contacto);
  setVal("ed_comunidad", currentCommon.comunidad);
  setVal("ed_condicion", currentCommon.condicion);
  setVal("ed_tipo", currentCommon.tipo || "predios");
  populateResponsableSelect(currentCommon.responsable);
  setVal("ed_grupo", currentCommon.grupo);
  document.getElementById("ed_fecha").value = currentCommon.fecha ? String(currentCommon.fecha).slice(0,10) : "";

  listAreas.innerHTML = "";
  (data||[]).forEach(p=>{
    const card = document.createElement("div");
    card.className = "area-card";
    card.setAttribute("data-cod", p.cod_prel);
    card.innerHTML = `
      <h4>${p.cod_prel}</h4>
      <div><b>√Årea:</b> ${p.area ?? ""}</div>
      <div><b>Prog:</b> ${p.prog_ini ?? ""} - ${p.prog_fin ?? ""} &nbsp; <b>Lado:</b> ${p.lado ?? ""}</div>
      <div class="area-actions">
        <button class="pill" data-cod="${p.cod_prel}" data-action="focus">Enfocar</button>
        <button class="pill" data-cod="${p.cod_prel}" data-action="detalles">Ver detalles</button>
      </div>
    `;
    listAreas.appendChild(card);
  });
  listAreas.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      const cod = e.currentTarget.dataset.cod;
      const action = e.currentTarget.dataset.action;
      if(action==="focus"){ selectedCodPrel = cod; focusByCodPrel(cod); highlightGroup(currentUnirId, false); }
      if(action==="detalles"){ selectedCodPrel = cod; focusByCodPrel(cod); highlightGroup(currentUnirId, false); openAreaModal(cod); }
    });
  });

  setCommonMode(false);
}
function setText(id, val){ document.getElementById(id).textContent = val ?? ""; }
function setVal(id, val){ document.getElementById(id).value = val ?? ""; }
function normTipo(v){ const s=(v||"").toLowerCase(); if(s==="comunidad") return "comunidad"; return "predios"; }
function setCommonMode(edit){
  commonView.style.display = edit ? "none" : "";
  commonEdit.style.display = edit ? "" : "none";
  btnEditCommon.style.display = edit ? "none" : "";
}
btnEditCommon.addEventListener("click", ()=> { populateResponsableSelect(currentCommon?.responsable||""); setCommonMode(true); });
btnCancelCommon.addEventListener("click", ()=> {
  if(currentCommon){
    setVal("ed_mtc", currentCommon.codigo_mtc);
    setVal("ed_titular", currentCommon.titular);
    setVal("ed_dni", currentCommon.dni_ruc);
    setVal("ed_contacto", currentCommon.contacto);
    setVal("ed_comunidad", currentCommon.comunidad);
    setVal("ed_condicion", currentCommon.condicion);
    setVal("ed_tipo", currentCommon.tipo || "predios");
    populateResponsableSelect(currentCommon.responsable);
    setVal("ed_grupo", currentCommon.grupo);
    document.getElementById("ed_fecha").value = currentCommon.fecha ? String(currentCommon.fecha).slice(0,10) : "";
  }
  setCommonMode(false);
});
btnSaveCommon.addEventListener("click", async ()=>{
  const payload = {
    codigo_mtc:  valOrNull("ed_mtc"),
    titular:     valOrNull("ed_titular"),
    dni_ruc:     valOrNull("ed_dni"),
    contacto:    valOrNull("ed_contacto"),
    comunidad:   valOrNull("ed_comunidad"),
    condicion:   valOrNull("ed_condicion"),
    tipo:        normTipo(document.getElementById("ed_tipo").value),
    responsable: valOrNull("ed_responsable"),
    grupo:       valOrNull("ed_grupo"),
    fecha_elab:  (document.getElementById("ed_fecha").value || null)
  };
  const { error } = await client.from("cod_pred").update(payload).eq("unir", currentUnirId);
  if(error){ alert("‚ùå Error al guardar comunes: "+error.message); return; }
  alert("‚úÖ Datos comunes actualizados");
  await loadAllPredios();
  await showGroup(currentUnirId);
});
function valOrNull(id){ const v = document.getElementById(id).value; return v==="" ? null : v; }

function focusByCodPrel(cod){
  let found = null;
  [capaPredio, capaComunidad, capaOtros].forEach(group=>{
    group.eachLayer(l=>{
      if(l.feature?.properties?.cod_prel === cod) found = l;
      l.eachLayer?.((sub)=>{ if(sub.feature?.properties?.cod_prel === cod) found = sub; });
    });
  });
  if(found){
    const b = found.getBounds?.();
    if(b) map.fitBounds(b, { maxZoom: 20, padding:[40,40] });
  }
}

/** ====== SEARCH ====== **/
const searchBox = document.getElementById("searchBox");
const suggestions = document.getElementById("suggestions");
let debounceTimer = null;
searchBox.addEventListener("input", (e)=>{
  const q = e.target.value.trim();
  clearTimeout(debounceTimer);
  if(q.length < 2){ suggestions.classList.remove("active"); suggestions.innerHTML=""; return; }
  debounceTimer = setTimeout(()=> runSuggest(q), 250);
});
searchBox.addEventListener("blur", ()=> setTimeout(()=>{ suggestions.classList.remove("active"); }, 150));
async function runSuggest(q){
  const { data, error } = await client.from("cod_pred")
    .select("cod_prel,codigo_mtc,unir")
    .or(`cod_prel.ilike.%${q}%,codigo_mtc.ilike.%${q}%`).limit(12);
  if(error){ console.error(error); return; }
  suggestions.innerHTML = "";
  (data||[]).forEach(r=>{
    const row = document.createElement("div");
    row.textContent = `${r.cod_prel} (${r.codigo_mtc ?? "‚Äî"})`;
    row.onclick = ()=>{ suggestions.classList.remove("active"); showGroup(r.unir); };
    suggestions.appendChild(row);
  });
  suggestions.classList.add("active");
}

/** ====== FILTROS (Comunidad + Grupo) ====== **/
const selCom = document.getElementById("filterComunidad");
const selGrupo = document.getElementById("filterGrupo");
document.getElementById("btnFiltrar").addEventListener("click", applyFilters);
document.getElementById("btnReset").addEventListener("click", async ()=>{
  selCom.value=""; selGrupo.value=""; searchBox.value="";
  await loadAllPredios();
  blockCommon.style.display="none"; wrapAreas.style.display="none"; emptyHint.style.display="";
});
async function hydrateFilterOptions(){
  const { data, error } = await client.from("cod_pred").select("comunidad").not("geom","is",null);
  if(error) return;
  const comunidades = [...new Set((data||[]).map(d=>d.comunidad).filter(Boolean))].sort();
  comunidades.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; selCom.appendChild(o); });
}
async function applyFilters(){
  let q = client.from("cod_pred").select("cod_prel,unir,tipo,geom,comunidad,grupo,condicion");
  if(selCom.value) q = q.eq("comunidad", selCom.value);
  if(selGrupo.value) q = q.eq("grupo", selGrupo.value);

  const { data, error } = await q;
  if(error){ console.error(error); return; }

  capaPredio.clearLayers(); capaComunidad.clearLayers(); capaOtros.clearLayers();
  (data||[]).forEach(p=>{
    if(!p.geom) return;
    const f = { type:"Feature", geometry:p.geom, properties:p };
    const layer = L.geoJSON(f, { style: styleByTipo(p.tipo) });
    layer.on("click", () => { selectedCodPrel = p.cod_prel; showGroup(p.unir); });
    if(isComunidad(p.tipo)) layer.addTo(capaComunidad);
    else if(isPredios(p.tipo)) layer.addTo(capaPredio);
    else layer.addTo(capaOtros);
  });

  const bounds = capaPredio.getLayers().length ? capaPredio.getBounds()
               : capaComunidad.getLayers().length ? capaComunidad.getBounds()
               : capaOtros.getLayers().length ? capaOtros.getBounds() : null;
  if(bounds) map.fitBounds(bounds);
}

/** ====== LISTA GLOBAL DE RESPONSABLES ====== **/
let RESPONSABLES = [];
async function fetchResponsables(){
  const { data, error } = await client.from("cod_pred").select("responsable").not("responsable","is",null);
  if(error) { console.warn(error.message); RESPONSABLES=[]; return; }
  const set = new Set((data||[]).map(r => (r.responsable||"").toString().trim().toLowerCase()).filter(Boolean));
  RESPONSABLES = [...set].sort();
}
function populateResponsableSelect(selected){
  const sel = document.getElementById("ed_responsable");
  sel.innerHTML = '<option value="">‚Äî</option>' + RESPONSABLES.map(n=>`<option value="${n}">${cap(n)}</option>`).join("");
  sel.value = (selected||"").toString().trim().toLowerCase();
}

/** ====== MODAL √ÅREA ====== **/
const modalAreaBack = document.getElementById("modalAreaBack");
function openAreaModal(cod){
  modalAreaBack.style.display = "flex";
  client.from("cod_pred").select("*").eq("cod_prel",cod).single().then(({data})=>{
    if(!data) return;
    setVal("a_cod_prel", data.cod_prel ?? "");
    setVal("a_area", data.area ?? "");
    setVal("a_perimetro", data.perimetro_suma ?? "");
    setVal("a_prog_ini", data.prog_ini ?? "");
    setVal("a_prog_fin", data.prog_fin ?? "");
    setVal("a_lado", data.lado ?? "");
    document.getElementById("a_obra").value = data.obra_complementaria ?? "";
    document.getElementById("a_plantaciones").value = data.plantaciones ?? "";
  });
}
function closeAreaModal(){ modalAreaBack.style.display = "none"; }
async function saveArea(){
  const cod = document.getElementById("a_cod_prel").value;
  const update = {
    area: valOrNull("a_area"),
    perimetro_suma: valOrNull("a_perimetro"),
    prog_ini: valOrNull("a_prog_ini"),
    prog_fin: valOrNull("a_prog_fin"),
    lado: valOrNull("a_lado"),
    obra_complementaria: (document.getElementById("a_obra").value || null),
    plantaciones: (document.getElementById("a_plantaciones").value || null)
  };
  const { error } = await client.from("cod_pred").update(update).eq("cod_prel", cod);
  if(error){ alert("‚ùå Error al guardar: "+error.message); return; }
  alert("‚úÖ √Årea actualizada");
  closeAreaModal();
  await loadAllPredios();
  if(currentUnirId) highlightGroup(currentUnirId, false);
}

/** ====== DRAWER REPORTE (por UNIR) ====== **/
const drawer   = document.getElementById("reportDrawer");
const btnOpen  = document.getElementById("btnReport");
const btnClose = document.getElementById("rp_close");
const rpStart  = document.getElementById("rp_start");
const rpEnd    = document.getElementById("rp_end");
const rpRun    = document.getElementById("rp_run");
const rpStatus = document.getElementById("rp_status");
const rpChips  = document.getElementById("rp_chips");
const rpTable  = document.getElementById("rp_table");
const rpDetail = document.getElementById("rp_detail");
const rpToggle = document.getElementById("rp_toggleEdit");
let rpChart = null;
let rpEditMode = false;

btnOpen.addEventListener("click", openReport);
btnClose.addEventListener("click", closeReport);

function openReport(){
  defaultReportDates();
  hydrateRespChips().then(()=> runReport());
  drawer.classList.add("open");
  drawer.setAttribute("aria-hidden","false");
}
function closeReport(){
  drawer.classList.remove("open");
  drawer.setAttribute("aria-hidden","true");
}
rpRun.addEventListener("click", runReport);
rpToggle.addEventListener("click", ()=>{ rpEditMode = !rpEditMode; rpToggle.textContent = rpEditMode ? "‚úÖ Terminar edici√≥n" : "‚úèÔ∏è Editar Planificado"; runReport(); });

/* Por pedido: del 02 al 31 de octubre (a√±o actual) */
function defaultReportDates(){
  const Y = new Date().getFullYear();
  rpStart.value = `${Y}-10-02`;
  rpEnd.value   = `${Y}-10-31`;
}

async function hydrateRespChips(){
  await fetchResponsables();
  rpChips.innerHTML = "";
  if(RESPONSABLES.length===0){ rpChips.innerHTML = `<span class="muted">No hay responsables registrados.</span>`; return; }
  RESPONSABLES.forEach(name=>{
    const id = "rp_chk_"+name.replace(/\s+/g,'_');
    const capName = cap(name);
    const lbl = document.createElement("label");
    lbl.className = "chip active";
    lbl.innerHTML = `<input id="${id}" type="checkbox" class="rp-resp" value="${name}" checked> ${capName}`;
    lbl.querySelector("input").addEventListener("change",(e)=> lbl.classList.toggle("active", e.target.checked));
    rpChips.appendChild(lbl);
  });
}
function selectedResp(){
  const set = new Set();
  document.querySelectorAll(".rp-resp:checked").forEach(cb=> set.add(cb.value));
  return set;
}

// Tabla 'plan_pred' (responsable, fecha, valor)
async function fetchPlan(start, end){
  const { data, error } = await client.from("plan_pred")
    .select("responsable,fecha,valor")
    .gte("fecha", start).lte("fecha", end);
  if(error){ console.warn("plan_pred:", error.message); return []; }
  return data||[];
}
async function savePlan(resp, fecha, valor){
  // Guardar solo L-V
  const dow = parseYmd(fecha).getDay(); // 0=Dom,6=Sab
  if(dow===0 || dow===6) return; // ignorar finde
  const payload = { responsable: resp, fecha, valor: Number(valor)||0 };
  const { error } = await client.from("plan_pred")
    .upsert(payload, { onConflict: "responsable,fecha" });
  if(error) throw error;
}

async function runReport(){
  const start = rpStart.value, end = rpEnd.value;
  if(!start || !end){ alert("Selecciona fechas"); return; }
  const allowed = selectedResp(); // vac√≠o => todos

  rpStatus.textContent = "Cargando‚Ä¶";
  rpDetail.style.display = "none"; rpDetail.innerHTML = "";

  // filas del rango (usamos responsables/fecha_elab comunes)
  let { data, error } = await client
    .from("cod_pred")
    .select("unir,cod_prel,codigo_mtc,comunidad,responsable,fecha_elab")
    .not("fecha_elab","is",null)
    .gte("fecha_elab", start)
    .lte("fecha_elab", end);
  if(error){ rpStatus.textContent = "Error: "+error.message; return; }

  // Deduplicar por UNIR y armar lista de c√≥digos por grupo
  const groups = new Map(); // unir -> {responsable, fecha, comunidad, codigo_mtc, unirId, cods:[]}
  (data||[]).forEach(r=>{
    const resp = (r.responsable||"").toString().trim().toLowerCase();
    if(allowed.size && !allowed.has(resp)) return;
    const key = r.unir;
    if(key == null) return;
    if(!groups.has(key)){
      groups.set(key, {
        responsable: resp,
        fecha: (r.fecha_elab||"").toString().slice(0,10),
        comunidad: r.comunidad||"",
        codigo_mtc: r.codigo_mtc||"",
        unirId: key,
        cods: []
      });
    }
    groups.get(key).cods.push(r.cod_prel||"");
  });

  // D√≠as del rango
  const dFrom = parseYmd(start), dTo = parseYmd(end);
  const days = buildDays(dFrom, dTo);
  const dKeys = days.map(dateKey);
  const dMeta = days.map(d => ({ key: ymdFromDateLocal(d), dow: d.getDay() })); // dow 0..6

  // Responsables activos
  const resps = [...new Set([...groups.values()].map(g=>g.responsable))].filter(Boolean).sort();

  // Contadores: elaborado por d√≠a (por UNIR), plan desde plan_pred
  const doneCounts = {}; const planCounts = {};
  resps.forEach(r=>{ doneCounts[r] = Object.fromEntries(dKeys.map(k=>[k,0])); planCounts[r] = Object.fromEntries(dKeys.map(k=>[k,0])); });

  // Mapa de celdas para detalle
  const cellMapDone = new Map(); // `${resp}|${day}` -> array de grupos {comunidad,codigo_mtc,unirId,cods[]}

  // Llenar 'done' (uno por UNIR)
  groups.forEach(g=>{
    const r = g.responsable; const k = g.fecha;
    if(!r || !k || !(k in (doneCounts[r]||{}))) return;
    doneCounts[r][k] += 1;
    const ck = `${r}|${k}`; if(!cellMapDone.has(ck)) cellMapDone.set(ck, []);
    cellMapDone.get(ck).push({ comunidad: g.comunidad, codigo_mtc: g.codigo_mtc, unirId: g.unirId, cods: g.cods });
  });

  // Traer planificado y volcar al mapa
  const planRows = await fetchPlan(start, end);
  (planRows||[]).forEach(p=>{
    const r = (p.responsable||"").toString().trim().toLowerCase();
    const k = (p.fecha||"").toString().slice(0,10);
    if(resps.includes(r) && dKeys.includes(k)) planCounts[r][k] = Number(p.valor)||0;
  });

  // KPIs
  const totalDone = [...groups.values()].length;
  document.getElementById("kpi_total").textContent = totalDone;
  document.getElementById("kpi_resps").textContent = resps.length;

  // Render tabla
  let html = "<tr>";
  html += `<th class="sticky l1">RESPONSABLE</th>`;
  dMeta.forEach(({key,dow})=>{
    const d = parseYmd(key);
    const cls = dow===0 ? "col-sun" : (dow===6 ? "col-sat" : "");
    html += `<th class="${cls}">${String(d.getDate()).padStart(2,'0')}<div class="muted">${["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"][dow]}</div></th>`;
  });
  html += `<th>Total</th></tr>`;

  resps.forEach(r=>{
    // Fila plan (editable solo L-V)
    html += `<tr>`;
    html += `<td class="sticky l1"><b>${cap(r)}</b> ‚Äî <span class="muted">Planificado</span></td>`;
    let rowPlan = 0;
    dMeta.forEach(({key,dow})=>{
      const val = planCounts[r][key] || 0; rowPlan += val;
      const baseCls = (dow===0 ? "col-sun" : (dow===6 ? "col-sat" : ""));
      const zeroCls = (val===0 && dow!==0 && dow!==6) ? "plan-zero" : "";
      if(rpEditMode){
        if(dow===0 || dow===6){
          html += `<td class="${baseCls}"><input class="ovr-input" type="number" min="0" value="${val}" disabled></td>`;
        }else{
          html += `<td class="${baseCls} ${zeroCls}"><input class="ovr-input" data-resp="${r}" data-date="${key}" type="number" min="0" value="${val}"></td>`;
        }
      }else{
        html += `<td class="${baseCls} ${zeroCls}">${val}</td>`;
      }
    });
    html += `<td><b>${rowPlan}</b></td>`;
    html += `</tr>`;

    // Fila elaborado
    html += `<tr>`;
    html += `<td class="sticky l1"><b>${cap(r)}</b> ‚Äî <span class="muted">Elaborado</span></td>`;
    let rowDone = 0;
    dMeta.forEach(({key,dow})=>{
      const n = doneCounts[r][key] || 0; rowDone += n;
      const baseCls = (dow===0 ? "col-sun" : (dow===6 ? "col-sat" : ""));
      if(n>0){
        html += `<td class="${baseCls} clickable" onclick="openRpCell('${r}','${key}')"><b>${n}</b></td>`;
      }else{
        html += `<td class="${baseCls} muted">0</td>`;
      }
    });
    html += `<td><b>${rowDone}</b></td>`;
    html += `</tr>`;
  });

  rpTable.innerHTML = html;

  // Guardado inline (y pinta rojo cuando es 0)
  rpTable.querySelectorAll(".ovr-input:not([disabled])").forEach(inp=>{
    inp.addEventListener("change", async (e)=>{
      const resp = e.target.getAttribute("data-resp");
      const fecha = e.target.getAttribute("data-date");
      const valor = Number(e.target.value)||0;
      try{
        await savePlan(resp, fecha, valor);
        // coloreo cero/no-cero
        const td = e.target.closest("td");
        if(td){ td.classList.toggle("plan-zero", valor===0); }
        rpStatus.textContent = "Planificado guardado ‚úì";
      }catch(err){
        console.error(err);
        rpStatus.textContent = "Error al guardar planificado";
      }
    });
  });

  // Gr√°fico de totales diarios (sin desfase)
  const labels = dMeta.map(({key})=>{
    const d = parseYmd(key); return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
  });
  const totals = dMeta.map(({key}) => resps.reduce((acc,r)=> acc + (doneCounts[r][key]||0), 0));
  renderReportChart(labels, totals);

  // Exponer mapa para detalle
  window._rp_cellMapDone = cellMapDone;

  rpStatus.textContent = "Listo.";
}

// Detalle de una celda (lista de grupos UNIR con sus c√≥digos clicables)
window.openRpCell = function(resp, ymd){
  const list = (window._rp_cellMapDone?.get(`${resp}|${ymd}`)) || [];
  const rows = list.map(g=>{
    const codes = g.cods.map(c=>`<button class="code-link" data-code="${esc(c)}" data-unir="${g.unirId}">${esc(c)}</button>`).join("");
    return `
      <tr>
        <td>${esc(g.comunidad)}</td>
        <td>${esc(g.codigo_mtc)}</td>
        <td style="text-align:left">${codes}</td>
      </tr>`;
  }).join("");
  rpDetail.innerHTML = `
    <div class="label">Detalle ‚Äî ${cap(resp)} ‚Äî ${ymd}</div>
    <div style="overflow:auto"><table class="report" style="width:100%">
      <thead><tr><th>Comunidad</th><th>C√≥digo MTC</th><th>cod_prel (grupo UNIR)</th></tr></thead>
      <tbody>${rows || `<tr><td colspan="3" class="muted">Sin grupos</td></tr>`}</tbody>
    </table></div>`;
  rpDetail.style.display = "block";
};

// Click en c√≥digo de detalle => seleccionar en mapa + panel
rpDetail.addEventListener("click", async (e)=>{
  const btn = e.target.closest(".code-link");
  if(!btn) return;
  const cod = btn.dataset.code;
  const unir = btn.dataset.unir;
  await selectFromReport(unir, cod);
});

async function selectFromReport(unir, cod){
  await showGroup(Number(unir));
  selectedCodPrel = cod;
  focusByCodPrel(cod);
  highlightGroup(Number(unir), false);
  // Resaltar tarjeta del √°rea
  const card = Array.from(listAreas.querySelectorAll(".area-card")).find(el => el.getAttribute("data-cod") === cod);
  if(card){
    card.classList.add("flash");
    card.scrollIntoView({ behavior:"smooth", block:"center" });
    setTimeout(()=> card.classList.remove("flash"), 1200);
  }
}

function renderReportChart(labels, totals){
  document.getElementById("chartWrap").style.display = "block";
  const ctx = document.getElementById("rp_chart").getContext("2d");
  if(rpChart) rpChart.destroy();
  rpChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{ label: 'Elaborados por d√≠a (UNIR)', data: totals }]
    },
    options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
  });
}

function esc(s){ return (s??"").toString().replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function cap(r){ return (r||"").replace(/\b\w/g,m=>m.toUpperCase()); }

/** ====== RESIZER ====== **/
(function initGutter(){
  const left = document.getElementById("leftPane");
  const gutter = document.getElementById("gutter");
  let dragging=false, startX=0, startLeft=0;
  gutter.addEventListener("mousedown",(e)=>{
    dragging=true; startX=e.clientX; startLeft=left.getBoundingClientRect().width;
    document.body.style.userSelect="none";
  });
  window.addEventListener("mousemove",(e)=>{
    if(!dragging) return;
    const dx = e.clientX - startX;
    const newW = Math.max(280, Math.min(window.innerWidth-280, startLeft + dx));
    const percent = (newW / window.innerWidth) * 100;
    left.style.flexBasis = percent + "%";
    setTimeout(()=> map.invalidateSize(), 0);
  });
  window.addEventListener("mouseup",()=>{ dragging=false; document.body.style.userSelect=""; });
})();

/** ====== INIT ====== **/
(async function init(){
  await hydrateFilterOptions();
  await fetchResponsables();
  await loadAllPredios();
})();
</script>
</body>
</html>
