<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Geoportal Predial</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --brand:#0f172a; --accent:#0ea5e9; --accent-dark:#0369a1;
      --panel-bg:#f8fafc; --card:#ffffff; --line:#e2e8f0;
      --predio:#0ea5e9; --comunidad:#22c55e; --otros:#a855f7; --highlight:#e11d48;
      --text:#0f172a;

      --sat:#e0f2ff;   /* s√°bado (azul muy claro)   */
      --sun:#fee2e2;   /* domingo (rojito)          */
      --comment-bg:#fef9c3; /* comentario */
      --comment-ring:#facc15;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;overflow:hidden;}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:10px 16px;background:var(--brand);color:#fff;position:relative;z-index:5000;
      box-shadow:0 2px 10px rgba(0,0,0,.25);
    }
    header .title{font-weight:700;letter-spacing:.3px}
    #centerControls{flex:1;display:flex;justify-content:center;position:relative}
    #searchWrap{position:relative;width:min(520px,90%)}
    #searchBox{
      width:100%;padding:10px 14px;border-radius:24px;border:none;outline:none;
      font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,.15) inset, 0 1px 0 rgba(255,255,255,.1);
      color:var(--text);
    }
    #suggestions{
      position:absolute;left:0;right:0;top:44px;background:#fff;
      border:1px solid var(--line);border-radius:10px;z-index:6000;
      max-height:240px;overflow:auto;display:none;color:var(--text);
    }
    #suggestions.active{display:block}
    #suggestions div{padding:8px 10px;cursor:pointer;color:var(--text)}
    #suggestions div:hover{background:#f1f5f9}

    #rightControls{display:flex;align-items:center;gap:8px}
    select,button{padding:8px 10px;border-radius:8px;border:1px solid transparent;font-size:14px}
    select{background:#fff;border-color:var(--line);color:var(--text)}
    .btn{background:var(--accent);color:#fff;cursor:pointer}
    .btn:hover{background:var(--accent-dark)}
    .ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.35)}
    .ghost:hover{border-color:#fff}

    #split{display:flex;height:calc(100% - 60px);min-height:300px}
    #leftPane{flex-basis:60%;position:relative;background:#000}
    #rightPane{flex:1;background:var(--panel-bg);border-left:1px solid var(--line);overflow:auto}
    #gutter{width:6px;cursor:col-resize;background:linear-gradient(90deg,transparent,rgba(0,0,0,.08),transparent)}
    #map{position:absolute;inset:0}

    .panel{padding:16px}
    h3{margin:8px 0 12px;color:var(--accent-dark)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .block{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .label{font-weight:700;margin-bottom:4px}
    .textblock{white-space:pre-line;background:#fff;border:1px solid var(--line);border-radius:8px;padding:8px;color:var(--text)}
    .area-card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:10px;margin:10px 0; transition: box-shadow .2s, background .2s}
    .area-card h4{margin:0 0 6px;color:var(--accent)}
    .area-actions{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .pill:hover{border-color:var(--accent)}
    .muted{color:#64748b;font-size:12px}
    .badge{background:#eef2ff;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;color:var(--text)}
    input,textarea{width:100%;padding:6px;border:1px solid var(--line);border-radius:8px;color:var(--text)}
    .btn-small{padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn-small:hover{border-color:var(--accent)}
    td.clickable{cursor:pointer;text-decoration:underline}

    /* ===== Drawer Reporte ===== */
    .drawer{
      position:fixed; top:60px; right:0;
      width:min(1100px,92vw); height:calc(100% - 60px);
      background:#fff; border-left:1px solid #e5e7eb; box-shadow:-12px 0 30px rgba(0,0,0,.15);
      transform:translateX(100%); transition:transform .25s ease; z-index:6000; overflow:auto;
    }
    .drawer.open{ transform:translateX(0); }
    .drawer-head{display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;padding:12px 16px;z-index:1}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px 16px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #e2e8f0;border-radius:999px;background:#fff;cursor:pointer;margin-right:6px;margin-bottom:6px}
    .chip input{transform:scale(1.1)}
    .chip.active{background:#eef7ff;border-color:#bfdbfe}
    #rp_kpiHeader{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin:8px 16px 16px}
    .kpi-card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:12px}
    .kpi-card h4{margin:0;font-size:14px;color:#1e293b;font-weight:700}
    .kpi-metrics{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .kpi-metric{background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:4px}
    .kpi-metric .m-label{font-size:12px;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
    .kpi-metric .m-val{font-size:24px;font-weight:800;color:#0f172a}
    .kpi-metric small{color:#64748b;font-size:11px}
    .kpi-leader-list{display:flex;flex-direction:column;gap:10px}
    .leader-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px solid #e2e8f0;border-radius:10px;background:#f8fafc}
    .leader-name{font-weight:600;color:#0f172a}
    .leader-meta{display:flex;align-items:center;gap:8px;font-size:13px;color:#475569}
    .leader-meta .badge{background:#e0f2fe;border:1px solid #bae6fd;border-radius:999px;padding:2px 10px;font-size:12px;color:#0c4a6e}
    table.report{border-collapse:collapse;width:auto;min-width:100%;margin:0}
    table.report th, table.report td{border:1px solid #e5e7eb;padding:6px 8px;text-align:center;vertical-align:top;background:#fff;position:relative}
    th.sticky{position:sticky;z-index:3;background:#f6f6f6}
    td.sticky{position:sticky;z-index:2;background:#fff}
    th.sticky.l1, td.sticky.l1 { left:0; min-width:220px; text-align:left; background:#fff; z-index:4;}
    th.sticky.l2, td.sticky.l2 { left:220px; min-width:130px; text-align:left; background:#fff; z-index:3;}
    .type-cell{font-weight:600;color:#475569}
    .resp-cell{font-weight:700;font-size:15px;text-transform:capitalize;padding-right:12px}
    .ovr-input{width:62px;padding:4px 6px;border:1px solid #cbd5e1;border-radius:8px;text-align:center}
    #rp_tableWrap{overflow:auto;border:1px solid #eee;border-radius:10px;margin:0 16px 12px;background:#fff;position:relative}

    /* Colores especiales en reporte */
    .col-sat{ background:var(--sat) !important; }
    .col-sun{ background:var(--sun) !important; }
    .plan-zero{ background:transparent !important; }

    .comment-cell{background:var(--comment-bg) !important; box-shadow:inset 0 0 0 1px rgba(250,204,21,.5);}
    .comment-cell.comment-linked{box-shadow:inset 0 0 0 1px rgba(250,204,21,.35);}
    .comment-bajada{background:#e5e7eb !important; box-shadow:inset 0 0 0 1px rgba(148,163,184,.6);}
    .comment-btn{border:1px solid #cbd5e1;background:#fff;color:#475569;border-radius:999px;padding:2px 6px;font-size:12px;cursor:pointer;transition:all .15s;line-height:1;display:inline-flex;align-items:center;gap:4px}
    .comment-btn:hover{background:#eef2ff;border-color:#94a3b8;color:#1e293b}
    .comment-btn.has-comment{background:rgba(250,204,21,.18);border-color:rgba(250,204,21,.8);color:#92400e}
    .comment-icon{font-size:13px;line-height:1}
    .plan-cell{display:flex;align-items:center;justify-content:center;gap:6px}
    .plan-cell.readonly{justify-content:flex-start}
    .plan-cell.readonly span{font-weight:600}
    .plan-cell.readonly .value{min-width:24px;text-align:center}

    /* Hoy */
    :root{
      --today-bg:#f5f3ff;
      --today-ring:rgba(99,102,241,.45);
      --today-wash:rgba(99,102,241,.18);
    }
    .today-col{
      position:relative;
      background:var(--today-bg) !important;
      box-shadow:inset 0 0 0 9999px var(--today-wash);
    }
    .today-col::after{
      content:"";
      position:absolute;
      inset:-2px;
      border:2px solid var(--today-ring);
      border-radius:8px;
      pointer-events:none;
    }

    /* Comentarios en planificado */
    .comment-preview{display:none}
    .comment-popover{position:absolute;min-width:240px;max-width:280px;background:#fff;border:1px solid #cbd5e1;border-radius:12px;box-shadow:0 18px 40px rgba(15,23,42,.2);padding:12px;z-index:9000;display:none}
    .comment-popover.open{display:block}
    .comment-popover h5{margin:0 0 6px;font-size:13px;color:#334155;font-weight:700}
    .comment-popover textarea{width:100%;min-height:96px;border:1px solid #cbd5e1;border-radius:8px;padding:6px;font-family:inherit;resize:vertical;color:#0f172a}
    .comment-popover textarea:focus{outline:2px solid rgba(14,165,233,.35)}
    .comment-popover .comment-text{font-size:13px;color:#1f2937;white-space:pre-wrap;max-height:160px;overflow:auto}
    .comment-popover .actions{margin-top:10px;display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}
    .comment-popover .actions button{padding:6px 10px;border-radius:8px;border:1px solid #cbd5e1;background:#f8fafc;color:#1f2937;font-size:12px;cursor:pointer}
    .comment-popover .actions button.primary{background:#0ea5e9;border-color:#0284c7;color:#fff}
    .comment-popover .actions button.danger{background:#fee2e2;border-color:#fca5a5;color:#b91c1c}

    #chartWrap{margin:12px 16px 16px;border:1px solid #eee;border-radius:10px;padding:10px;background:#fff}
    #rp_detail{margin:0 16px 16px;border:1px dashed #e5e7eb;border-radius:10px;padding:10px;background:#fafafa}

    /* Modal √Årea */
    .modal-back{
      position:fixed; inset:60px 0 0 0; display:none;
      align-items:center; justify-content:center; background:rgba(0,0,0,.25); z-index:7000;
    }
    .modal{
      width:min(820px,92vw); background:#fff; border-radius:12px; padding:12px;
      box-shadow:0 20px 40px rgba(0,0,0,.25);
    }

    /* flash highlight for selected area card */
    @keyframes flash {
      0% { box-shadow:0 0 0 rgba(14,165,233,0); background:#fff; }
      20%{ box-shadow:0 0 0 6px rgba(14,165,233,.15); background:#e0f2fe; }
      100%{ box-shadow:0 0 0 rgba(14,165,233,0); background:#fff; }
    }
    .flash { animation: flash 1s ease-out 1; }
  </style>
</head>
<body>
  <header>
    <div class="title">Geoportal Predial</div>

    <div id="centerControls">
      <div id="searchWrap">
        <input id="searchBox" type="text" placeholder="üîç Buscar cod_prel o cod_mtc‚Ä¶" autocomplete="off" />
        <div id="suggestions"></div>
      </div>
    </div>

    <div id="rightControls">
      <button class="ghost" id="btnReport">üìä Reporte</button>
      <select id="filterComunidad"><option value="">Comunidad (todas)</option></select>
      <select id="filterGrupo">
        <option value="">Grupo (todos)</option>
        <option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option>
        <option value="1er_entregable">1er_entregable</option>
      </select>
      <button class="btn" id="btnFiltrar">Filtrar</button>
      <button class="ghost" id="btnReset">Reset</button>
    </div>
  </header>

  <div id="split">
    <section id="leftPane"><div id="map"></div></section>
    <div id="gutter" title="Arrastra para redimensionar"></div>
    <section id="rightPane">
      <div class="panel">
        <h3>Detalle del predio</h3>

        <!-- Datos comunes -->
        <div id="commonBlock" class="block" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <div style="display:flex;align-items:center;gap:8px;">
              <div class="label">Datos:</div>
              <span id="unionCount" class="badge"></span>
            </div>
            <div><button id="btnEditCommon" class="btn-small">‚úèÔ∏è Editar :</button></div>
          </div>

          <!-- Lectura -->
          <div id="commonView">
            <div class="grid-2">
              <div><div class="label">C√≥digo MTC</div><div id="cm_mtc" class="textblock"></div></div>
              <div><div class="label">Comunidad</div><div id="cm_comunidad" class="textblock"></div></div>
              <div style="grid-column:1/-1"><div class="label">Titular</div><div id="cm_titular" class="textblock"></div></div>
              <div style="grid-column:1/-1"><div class="label">DNI / RUC</div><div id="cm_dni" class="textblock"></div></div>
              <div style="grid-column:1/-1"><div class="label">Contacto</div><div id="cm_contacto" class="textblock"></div></div>
              <div><div class="label">Condici√≥n</div><div id="cm_condicion" class="textblock"></div></div>
              <div><div class="label">Tipo</div><div id="cm_tipo" class="textblock"></div></div>
              <div><div class="label">Responsable</div><div id="cm_responsable" class="textblock"></div></div>
              <div><div class="label">Grupo</div><div id="cm_grupo" class="textblock"></div></div>
              <div><div class="label">Fecha elaboraci√≥n</div><div id="cm_fecha" class="textblock"></div></div>
            </div>
          </div>

          <!-- Edici√≥n -->
          <div id="commonEdit" style="display:none">
            <div class="grid-2">
              <div><div class="label">C√≥digo MTC</div><input id="ed_mtc" type="text"></div>
              <div><div class="label">Comunidad</div><input id="ed_comunidad" type="text"></div>
              <div style="grid-column:1/-1"><div class="label">Titular</div><textarea id="ed_titular" rows="3" style="white-space:pre-line"></textarea></div>
              <div style="grid-column:1/-1"><div class="label">DNI / RUC</div><textarea id="ed_dni" rows="2" style="white-space:pre-line"></textarea></div>
              <div style="grid-column:1/-1"><div class="label">Contacto</div><textarea id="ed_contacto" rows="2" style="white-space:pre-line"></textarea></div>
              <div><div class="label">Condici√≥n</div><input id="ed_condicion" type="text"></div>
              <div>
                <div class="label">Tipo</div>
                <select id="ed_tipo">
                  <option value="predios">predios</option>
                  <option value="comunidad">comunidad</option>
                </select>
              </div>
              <div>
                <div class="label">Responsable</div>
                <select id="ed_responsable"></select>
              </div>
              <div>
                <div class="label">Grupo</div>
                <select id="ed_grupo">
                  <option value="">‚Äî</option>
                  <option value="1">1</option><option value="2">2</option>
                  <option value="3">3</option><option value="4">4</option>
                  <option value="1er_entregable">1er_entregable</option>
                </select>
              </div>
              <div><div class="label">Fecha elaboraci√≥n</div><input id="ed_fecha" type="date"></div>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
              <button id="btnCancelCommon" class="btn-small">Cancelar</button>
              <button id="btnSaveCommon" class="btn">Guardar</button>
            </div>
          </div>
        </div>

        <!-- √Åreas afectadas -->
        <div id="areasWrap" class="block" style="display:none">
          <div class="label">√Åreas afectadas</div>
          <div id="areasList"></div>
        </div>

        <div id="emptyHint" class="muted">Selecciona un pol√≠gono o busca por c√≥digo.</div>
      </div>
    </section>
  </div>

  <!-- Modal Detalle de √Årea -->
  <div id="modalAreaBack" class="modal-back" style="display:none">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3>Detalles del √Årea Afectada</h3>
        <button class="btn-small" onclick="closeAreaModal()">‚úï</button>
      </div>
      <div class="grid-2">
        <div><div class="label">cod_prel</div><input id="a_cod_prel" type="text" disabled></div>
        <div><div class="label">√Årea</div><input id="a_area" type="text"></div>
        <div><div class="label">Per√≠metro</div><input id="a_perimetro" type="text"></div>
        <div><div class="label">Prog. Ini</div><input id="a_prog_ini" type="text"></div>
        <div><div class="label">Prog. Fin</div><input id="a_prog_fin" type="text"></div>
        <div><div class="label">Lado</div><input id="a_lado" type="text"></div>
        <div style="grid-column:1/-1"><div class="label">Obra complementaria</div><textarea id="a_obra" rows="3" style="white-space:pre-line"></textarea></div>
        <div style="grid-column:1/-1"><div class="label">Plantaciones</div><textarea id="a_plantaciones" rows="3" style="white-space:pre-line"></textarea></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn-small" onclick="closeAreaModal()">Cancelar</button>
        <button class="btn" onclick="saveArea()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Drawer Reporte -->
  <aside id="reportDrawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <h3 style="margin:0">Reporte ‚Äî Planificado (manual) vs Elaborado (por UNIR)</h3>
      <button class="btn-small" id="rp_close">‚úï</button>
    </div>

    <div class="row">
      <label>Desde: <input id="rp_start" type="date"></label>
      <label>Hasta: <input id="rp_end" type="date"></label>
      <button class="btn" id="rp_run">Generar</button>
      <!-- Un solo bot√≥n para editar todo -->
      <button class="ghost" id="rp_toggleEdit">‚úèÔ∏è Editar Planificado</button>
      <span id="rp_status" class="muted"></span>
    </div>

    <div id="rp_chips" class="row" style="margin-top:-8px"></div>

    <div id="rp_kpiHeader">
      <div class="kpi-card">
        <h4>Resumen general</h4>
        <div class="kpi-metrics">
          <div class="kpi-metric">
            <div class="m-label">Planificado</div>
            <div class="m-val" id="kpiGeneralPlan">‚Äî</div>
            <small id="kpiGeneralPlanRange">‚Äî</small>
          </div>
          <div class="kpi-metric">
            <div class="m-label">Elaborado</div>
            <div class="m-val" id="kpiGeneralDone">‚Äî</div>
            <small id="kpiGeneralDoneRange">‚Äî</small>
          </div>
          <div class="kpi-metric">
            <div class="m-label">Avance</div>
            <div class="m-val" id="kpiGeneralPct">‚Äî</div>
            <small>Elaborado / Planificado</small>
          </div>
        </div>
      </div>
      <div class="kpi-card">
        <h4>Resumen acumulado hasta hoy</h4>
        <div class="kpi-metrics">
          <div class="kpi-metric">
            <div class="m-label">Planificado acum.</div>
            <div class="m-val" id="kpiTodayPlan">‚Äî</div>
            <small id="kpiTodayRange">‚Äî</small>
          </div>
          <div class="kpi-metric">
            <div class="m-label">Elaborado acum.</div>
            <div class="m-val" id="kpiTodayDone">‚Äî</div>
            <small>Hasta hoy</small>
          </div>
          <div class="kpi-metric">
            <div class="m-label">Avance</div>
            <div class="m-val" id="kpiTodayPct">‚Äî</div>
            <small>Elaborado / Planificado</small>
          </div>
        </div>
      </div>
      <div class="kpi-card">
        <h4>Avance por responsable (hasta hoy)</h4>
        <div class="kpi-leader-list" id="kpiLeaderList"></div>
      </div>
    </div>

    <div id="rp_tableWrap">
      <table id="rp_table" class="report"></table>
    </div>

    <div id="chartWrap" style="display:none">
      <canvas id="rp_chart" height="336"></canvas>
    </div>

    <div id="rp_detail" style="display:none"></div>
  </aside>

  <div id="commentPopover" class="comment-popover" role="dialog" aria-modal="false"></div>

<script>
/** ====== CONFIG ====== **/
const SUPABASE_URL = "https://wbzxbfqowlfmmkwqeyam.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndienhiZnFvd2xmbW1rd3FleWFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODUwMDQsImV4cCI6MjA3MjU2MTAwNH0.mJJ7yID73tUerWE_aiNw3ZE4o-Q9YrT39YN-iS2CksA";
const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const numberFormatter = new Intl.NumberFormat('es-PE');

/** ====== Helpers de fecha (evitar desfase -05:00) ====== **/
function parseYmd(ymd){ const [y,m,d] = ymd.split("-").map(Number); return new Date(y, (m||1)-1, d||1); } // Local
function ymdFromDateLocal(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
function dateKey(d){ return ymdFromDateLocal(d); }
function buildDays(from, to){
  const a=[]; const cur=new Date(from.getFullYear(), from.getMonth(), from.getDate());
  const end=new Date(to.getFullYear(), to.getMonth(), to.getDate());
  while(cur<=end){ a.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
  return a;
}

/** ====== MAP (sin logo Leaflet) ====== **/
const map = L.map('map', { zoomControl:true, attributionControl:false }).setView([-15.5, -70.1], 17);
L.control.attribution({ prefix:false }).addTo(map);
L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom:21, attribution:'¬© Google' }).addTo(map);

const normalStyle   = { color:"var(--predio)",    weight:2, fillOpacity:0.2 };
const commStyle     = { color:"var(--comunidad)", weight:2, fillOpacity:0.2 };
const otherStyle    = { color:"var(--otros)",     weight:2, fillOpacity:0.2 };
const highlightStyle= { color:"var(--highlight)", weight:3, fillOpacity:0.4 };

let selectedCodPrel = null;
let currentUnirId = null;

const capaPredio    = L.geoJSON(null, { style: normalStyle }).addTo(map);
const capaComunidad = L.geoJSON(null, { style: commStyle   }).addTo(map);
const capaOtros     = L.geoJSON(null, { style: otherStyle  }).addTo(map);

L.control.layers(null, { "Predios":capaPredio, "Comunidades":capaComunidad, "Otros":capaOtros }).addTo(map);

function isPredios(v){ return (v||"").toLowerCase() === "predios" || (v||"").toLowerCase() === "predio"; }
function isComunidad(v){ return (v||"").toLowerCase() === "comunidad"; }
function styleByTipo(t){ return isComunidad(t) ? commStyle : isPredios(t) ? normalStyle : otherStyle; }

/** ====== DATA LOAD ====== **/
async function loadAllPredios(){
  const { data, error } = await client
    .from("cod_pred")
    .select("cod_prel,unir,comunidad,condicion,grupo,codigo_mtc,titular,tipo,geom");
  if(error){ console.error(error); return; }

  capaPredio.clearLayers(); capaComunidad.clearLayers(); capaOtros.clearLayers();

  (data||[]).forEach(p=>{
    if(!p.geom) return;
    const f = { type:"Feature", geometry:p.geom, properties:p };
    const layer = L.geoJSON(f, { style: styleByTipo(p.tipo) });
    layer.on("click", () => { selectedCodPrel = p.cod_prel; showGroup(p.unir); });
    if(isComunidad(p.tipo)) layer.addTo(capaComunidad);
    else if(isPredios(p.tipo)) layer.addTo(capaPredio);
    else layer.addTo(capaOtros);
  });

  const bounds = capaPredio.getLayers().length ? capaPredio.getBounds()
               : capaComunidad.getLayers().length ? capaComunidad.getBounds()
               : capaOtros.getLayers().length ? capaOtros.getBounds() : null;
  if(bounds) map.fitBounds(bounds);
}

/** ====== DESTACAR GRUPO ====== **/
function highlightGroup(unirId, zoomTo=true){
  let groupBounds = null;
  const restyle = (grp)=>{
    grp.eachLayer(l=>{
      const props = l.feature?.properties;
      const setLayer = (ly, pr)=>{
        const match = pr.unir === unirId;
        ly.setStyle(match ? highlightStyle : styleByTipo(pr.tipo));
        if(match){ ly.bringToFront(); if(ly.getBounds){ groupBounds = groupBounds ? groupBounds.extend(ly.getBounds()) : ly.getBounds(); } }
      };
      if(props) setLayer(l, props);
      l.eachLayer?.((sub)=>{ if(sub.feature?.properties) setLayer(sub, sub.feature.properties); });
    });
  };
  [capaPredio, capaComunidad, capaOtros].forEach(restyle);
  if(groupBounds && zoomTo) map.fitBounds(groupBounds, { padding:[40,40], maxZoom:20 });
}

/** ====== UI PANEL ====== **/
const blockCommon  = document.getElementById("commonBlock");
const wrapAreas    = document.getElementById("areasWrap");
const listAreas    = document.getElementById("areasList");
const emptyHint    = document.getElementById("emptyHint");
const unionCount   = document.getElementById("unionCount");

const commonView   = document.getElementById("commonView");
const commonEdit   = document.getElementById("commonEdit");
const btnEditCommon= document.getElementById("btnEditCommon");
const btnSaveCommon= document.getElementById("btnSaveCommon");
const btnCancelCommon= document.getElementById("btnCancelCommon");

let currentCommon = null;

async function showGroup(unirId){
  const { data, error } = await client.from("cod_pred").select("*").eq("unir", unirId);
  if(error || !data?.length){ return; }

  currentUnirId = unirId;
  highlightGroup(unirId, true);
  unionCount.textContent = `Se unen: ${data.length} ${data.length===1?'c√≥digo':'c√≥digos'}`;

  const c = data[0];
  currentCommon = {
    codigo_mtc: c.codigo_mtc || "",
    titular:    c.titular    || "",
    dni_ruc:    c.dni_ruc    || "",
    contacto:   c.contacto   || "",
    comunidad:  c.comunidad  || "",
    condicion:  c.condicion  || "",
    tipo:       normTipo(c.tipo),
    responsable:c.responsable || "",
    grupo:      c.grupo       || "",
    fecha:      c.fecha_elab  || ""
  };

  blockCommon.style.display = "";
  wrapAreas.style.display = "";
  emptyHint.style.display = "none";

  setText("cm_mtc", currentCommon.codigo_mtc);
  setText("cm_titular", currentCommon.titular);
  setText("cm_dni", currentCommon.dni_ruc);
  setText("cm_contacto", currentCommon.contacto);
  setText("cm_comunidad", currentCommon.comunidad);
  setText("cm_condicion", currentCommon.condicion);
  setText("cm_tipo", currentCommon.tipo || "predios");
  setText("cm_responsable", cap(currentCommon.responsable));
  setText("cm_grupo", currentCommon.grupo);
  setText("cm_fecha", currentCommon.fecha ? String(currentCommon.fecha).slice(0,10) : "");

  setVal("ed_mtc", currentCommon.codigo_mtc);
  setVal("ed_titular", currentCommon.titular);
  setVal("ed_dni", currentCommon.dni_ruc);
  setVal("ed_contacto", currentCommon.contacto);
  setVal("ed_comunidad", currentCommon.comunidad);
  setVal("ed_condicion", currentCommon.condicion);
  setVal("ed_tipo", currentCommon.tipo || "predios");
  populateResponsableSelect(currentCommon.responsable);
  setVal("ed_grupo", currentCommon.grupo);
  document.getElementById("ed_fecha").value = currentCommon.fecha ? String(currentCommon.fecha).slice(0,10) : "";

  listAreas.innerHTML = "";
  (data||[]).forEach(p=>{
    const card = document.createElement("div");
    card.className = "area-card";
    card.setAttribute("data-cod", p.cod_prel);
    card.innerHTML = `
      <h4>${p.cod_prel}</h4>
      <div><b>√Årea:</b> ${p.area ?? ""}</div>
      <div><b>Prog:</b> ${p.prog_ini ?? ""} - ${p.prog_fin ?? ""} &nbsp; <b>Lado:</b> ${p.lado ?? ""}</div>
      <div class="area-actions">
        <button class="pill" data-cod="${p.cod_prel}" data-action="focus">Enfocar</button>
        <button class="pill" data-cod="${p.cod_prel}" data-action="detalles">Ver detalles</button>
      </div>
    `;
    listAreas.appendChild(card);
  });
  listAreas.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      const cod = e.currentTarget.dataset.cod;
      const action = e.currentTarget.dataset.action;
      if(action==="focus"){ selectedCodPrel = cod; focusByCodPrel(cod); highlightGroup(currentUnirId, false); }
      if(action==="detalles"){ selectedCodPrel = cod; focusByCodPrel(cod); highlightGroup(currentUnirId, false); openAreaModal(cod); }
    });
  });

  setCommonMode(false);
}
function setText(id, val){ document.getElementById(id).textContent = val ?? ""; }
function setVal(id, val){ document.getElementById(id).value = val ?? ""; }
function normTipo(v){ const s=(v||"").toLowerCase(); if(s==="comunidad") return "comunidad"; return "predios"; }
function setCommonMode(edit){
  commonView.style.display = edit ? "none" : "";
  commonEdit.style.display = edit ? "" : "none";
  btnEditCommon.style.display = edit ? "none" : "";
}
btnEditCommon.addEventListener("click", ()=> { populateResponsableSelect(currentCommon?.responsable||""); setCommonMode(true); });
btnCancelCommon.addEventListener("click", ()=> {
  if(currentCommon){
    setVal("ed_mtc", currentCommon.codigo_mtc);
    setVal("ed_titular", currentCommon.titular);
    setVal("ed_dni", currentCommon.dni_ruc);
    setVal("ed_contacto", currentCommon.contacto);
    setVal("ed_comunidad", currentCommon.comunidad);
    setVal("ed_condicion", currentCommon.condicion);
    setVal("ed_tipo", currentCommon.tipo || "predios");
    populateResponsableSelect(currentCommon.responsable);
    setVal("ed_grupo", currentCommon.grupo);
    document.getElementById("ed_fecha").value = currentCommon.fecha ? String(currentCommon.fecha).slice(0,10) : "";
  }
  setCommonMode(false);
});
btnSaveCommon.addEventListener("click", async ()=>{
  const payload = {
    codigo_mtc:  valOrNull("ed_mtc"),
    titular:     valOrNull("ed_titular"),
    dni_ruc:     valOrNull("ed_dni"),
    contacto:    valOrNull("ed_contacto"),
    comunidad:   valOrNull("ed_comunidad"),
    condicion:   valOrNull("ed_condicion"),
    tipo:        normTipo(document.getElementById("ed_tipo").value),
    responsable: valOrNull("ed_responsable"),
    grupo:       valOrNull("ed_grupo"),
    fecha_elab:  (document.getElementById("ed_fecha").value || null)
  };
  const { error } = await client.from("cod_pred").update(payload).eq("unir", currentUnirId);
  if(error){ alert("‚ùå Error al guardar comunes: "+error.message); return; }
  alert("‚úÖ Datos comunes actualizados");
  await loadAllPredios();
  await showGroup(currentUnirId);
});
function valOrNull(id){ const v = document.getElementById(id).value; return v==="" ? null : v; }

function focusByCodPrel(cod){
  let found = null;
  [capaPredio, capaComunidad, capaOtros].forEach(group=>{
    group.eachLayer(l=>{
      if(l.feature?.properties?.cod_prel === cod) found = l;
      l.eachLayer?.((sub)=>{ if(sub.feature?.properties?.cod_prel === cod) found = sub; });
    });
  });
  if(found){
    const b = found.getBounds?.();
    if(b) map.fitBounds(b, { maxZoom: 20, padding:[40,40] });
  }
}

/** ====== SEARCH ====== **/
const searchBox = document.getElementById("searchBox");
const suggestions = document.getElementById("suggestions");
let debounceTimer = null;
searchBox.addEventListener("input", (e)=>{
  const q = e.target.value.trim();
  clearTimeout(debounceTimer);
  if(q.length < 2){ suggestions.classList.remove("active"); suggestions.innerHTML=""; return; }
  debounceTimer = setTimeout(()=> runSuggest(q), 250);
});
searchBox.addEventListener("blur", ()=> setTimeout(()=>{ suggestions.classList.remove("active"); }, 150));
async function runSuggest(q){
  const { data, error } = await client.from("cod_pred")
    .select("cod_prel,codigo_mtc,unir")
    .or(`cod_prel.ilike.%${q}%,codigo_mtc.ilike.%${q}%`).limit(12);
  if(error){ console.error(error); return; }
  suggestions.innerHTML = "";
  (data||[]).forEach(r=>{
    const row = document.createElement("div");
    row.textContent = `${r.cod_prel} (${r.codigo_mtc ?? "‚Äî"})`;
    row.onclick = ()=>{ suggestions.classList.remove("active"); showGroup(r.unir); };
    suggestions.appendChild(row);
  });
  suggestions.classList.add("active");
}

/** ====== FILTROS (Comunidad + Grupo) ====== **/
const selCom = document.getElementById("filterComunidad");
const selGrupo = document.getElementById("filterGrupo");
document.getElementById("btnFiltrar").addEventListener("click", applyFilters);
document.getElementById("btnReset").addEventListener("click", async ()=>{
  selCom.value=""; selGrupo.value=""; searchBox.value="";
  await loadAllPredios();
  blockCommon.style.display="none"; wrapAreas.style.display="none"; emptyHint.style.display="";
});
async function hydrateFilterOptions(){
  const { data, error } = await client.from("cod_pred").select("comunidad").not("geom","is",null);
  if(error) return;
  const comunidades = [...new Set((data||[]).map(d=>d.comunidad).filter(Boolean))].sort();
  comunidades.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; selCom.appendChild(o); });
}
async function applyFilters(){
  let q = client.from("cod_pred").select("cod_prel,unir,tipo,geom,comunidad,grupo,condicion");
  if(selCom.value) q = q.eq("comunidad", selCom.value);
  if(selGrupo.value) q = q.eq("grupo", selGrupo.value);

  const { data, error } = await q;
  if(error){ console.error(error); return; }

  capaPredio.clearLayers(); capaComunidad.clearLayers(); capaOtros.clearLayers();
  (data||[]).forEach(p=>{
    if(!p.geom) return;
    const f = { type:"Feature", geometry:p.geom, properties:p };
    const layer = L.geoJSON(f, { style: styleByTipo(p.tipo) });
    layer.on("click", () => { selectedCodPrel = p.cod_prel; showGroup(p.unir); });
    if(isComunidad(p.tipo)) layer.addTo(capaComunidad);
    else if(isPredios(p.tipo)) layer.addTo(capaPredio);
    else layer.addTo(capaOtros);
  });

  const bounds = capaPredio.getLayers().length ? capaPredio.getBounds()
               : capaComunidad.getLayers().length ? capaComunidad.getBounds()
               : capaOtros.getLayers().length ? capaOtros.getBounds() : null;
  if(bounds) map.fitBounds(bounds);
}

/** ====== LISTA GLOBAL DE RESPONSABLES ====== **/
let RESPONSABLES = [];
async function fetchResponsables(){
  const { data, error } = await client.from("cod_pred").select("responsable").not("responsable","is",null);
  if(error) { console.warn(error.message); RESPONSABLES=[]; return; }
  const set = new Set((data||[]).map(r => (r.responsable||"").toString().trim().toLowerCase()).filter(Boolean));
  RESPONSABLES = [...set].sort();
}
function populateResponsableSelect(selected){
  const sel = document.getElementById("ed_responsable");
  sel.innerHTML = '<option value="">‚Äî</option>' + RESPONSABLES.map(n=>`<option value="${n}">${cap(n)}</option>`).join("");
  sel.value = (selected||"").toString().trim().toLowerCase();
}

/** ====== MODAL √ÅREA ====== **/
const modalAreaBack = document.getElementById("modalAreaBack");
function openAreaModal(cod){
  modalAreaBack.style.display = "flex";
  client.from("cod_pred").select("*").eq("cod_prel",cod).single().then(({data})=>{
    if(!data) return;
    setVal("a_cod_prel", data.cod_prel ?? "");
    setVal("a_area", data.area ?? "");
    setVal("a_perimetro", data.perimetro_suma ?? "");
    setVal("a_prog_ini", data.prog_ini ?? "");
    setVal("a_prog_fin", data.prog_fin ?? "");
    setVal("a_lado", data.lado ?? "");
    document.getElementById("a_obra").value = data.obra_complementaria ?? "";
    document.getElementById("a_plantaciones").value = data.plantaciones ?? "";
  });
}
function closeAreaModal(){ modalAreaBack.style.display = "none"; }
async function saveArea(){
  const cod = document.getElementById("a_cod_prel").value;
  const update = {
    area: valOrNull("a_area"),
    perimetro_suma: valOrNull("a_perimetro"),
    prog_ini: valOrNull("a_prog_ini"),
    prog_fin: valOrNull("a_prog_fin"),
    lado: valOrNull("a_lado"),
    obra_complementaria: (document.getElementById("a_obra").value || null),
    plantaciones: (document.getElementById("a_plantaciones").value || null)
  };
  const { error } = await client.from("cod_pred").update(update).eq("cod_prel", cod);
  if(error){ alert("‚ùå Error al guardar: "+error.message); return; }
  alert("‚úÖ √Årea actualizada");
  closeAreaModal();
  await loadAllPredios();
  if(currentUnirId) highlightGroup(currentUnirId, false);
}

/** ====== DRAWER REPORTE (por UNIR) ====== **/
const drawer   = document.getElementById("reportDrawer");
const btnOpen  = document.getElementById("btnReport");
const btnClose = document.getElementById("rp_close");
const rpStart  = document.getElementById("rp_start");
const rpEnd    = document.getElementById("rp_end");
const rpRun    = document.getElementById("rp_run");
const rpStatus = document.getElementById("rp_status");
const rpChips  = document.getElementById("rp_chips");
const rpTable  = document.getElementById("rp_table");
const rpTableWrap = document.getElementById("rp_tableWrap");
const rpDetail = document.getElementById("rp_detail");
const rpToggle = document.getElementById("rp_toggleEdit");
let rpChart = null;
let rpEditMode = false;
const commentPopoverEl = document.getElementById("commentPopover");
let commentPopoverState = null;

btnOpen.addEventListener("click", openReport);
btnClose.addEventListener("click", closeReport);

function openReport(){
  defaultReportDates();
  hydrateRespChips().then(()=> runReport());
  drawer.classList.add("open");
  drawer.setAttribute("aria-hidden","false");
}
function closeReport(){
  drawer.classList.remove("open");
  drawer.setAttribute("aria-hidden","true");
  closeCommentPopover();
}
rpRun.addEventListener("click", runReport);
rpToggle.addEventListener("click", ()=>{ rpEditMode = !rpEditMode; rpToggle.textContent = rpEditMode ? "‚úÖ Terminar edici√≥n" : "‚úèÔ∏è Editar Planificado"; runReport(); });

/* Por pedido: del 02 al 31 de octubre (a√±o actual) */
function defaultReportDates(){
  const Y = new Date().getFullYear();
  rpStart.value = `${Y}-09-02`;
  rpEnd.value   = `${Y}-10-31`;
}

async function hydrateRespChips(){
  await fetchResponsables();
  rpChips.innerHTML = "";
  if(RESPONSABLES.length===0){ rpChips.innerHTML = `<span class="muted">No hay responsables registrados.</span>`; return; }
  RESPONSABLES.forEach(name=>{
    const id = "rp_chk_"+name.replace(/\s+/g,'_');
    const capName = cap(name);
    const lbl = document.createElement("label");
    lbl.className = "chip active";
    lbl.innerHTML = `<input id="${id}" type="checkbox" class="rp-resp" value="${name}" checked> ${capName}`;
    lbl.querySelector("input").addEventListener("change",(e)=> lbl.classList.toggle("active", e.target.checked));
    rpChips.appendChild(lbl);
  });
}
function selectedResp(){
  const set = new Set();
  document.querySelectorAll(".rp-resp:checked").forEach(cb=> set.add(cb.value));
  return set;
}

function handleCommentOutside(e){
  if(!commentPopoverEl || !commentPopoverEl.classList.contains('open')) return;
  if(commentPopoverEl.contains(e.target)) return;
  if(commentPopoverState?.anchor && commentPopoverState.anchor.contains(e.target)) return;
  closeCommentPopover();
}

function handleCommentEscape(e){
  if(e.key === 'Escape') closeCommentPopover();
}

function closeCommentPopover(){
  if(!commentPopoverEl) return;
  commentPopoverEl.classList.remove('open');
  commentPopoverEl.innerHTML = '';
  commentPopoverEl.setAttribute('aria-modal','false');
  document.removeEventListener('mousedown', handleCommentOutside);
  document.removeEventListener('keydown', handleCommentEscape);
  commentPopoverState = null;
}

function openCommentPopover({ resp, fecha, anchor, comment, editable }){
  if(!commentPopoverEl || !anchor) return;
  if(commentPopoverState && commentPopoverState.anchor === anchor && commentPopoverEl.classList.contains('open')){
    closeCommentPopover();
    return;
  }
  closeCommentPopover();

  commentPopoverState = { resp, fecha, anchor, editable };
  const title = `Comentario ‚Äî ${cap(resp)} (${fecha})`;
  let inner = `<h5>${esc(title)}</h5>`;

  if(editable){
    inner += `
      <textarea id="commentInput" placeholder="Escribe un comentario..."></textarea>
      <div class="actions">
        ${comment ? '<button type="button" data-action="delete" class="danger">Eliminar</button>' : ''}
        <button type="button" data-action="cancel">Cancelar</button>
        <button type="button" data-action="save" class="primary">Guardar</button>
      </div>`;
  }else{
    const body = comment ? esc(comment).replace(/\n/g,'<br>') : '<span class="muted">Sin comentario</span>';
    inner += `
      <div class="comment-text">${body}</div>
      <div class="actions"><button type="button" data-action="close" class="primary">Cerrar</button></div>`;
  }

  commentPopoverEl.innerHTML = inner;
  commentPopoverEl.classList.add('open');
  commentPopoverEl.setAttribute('aria-modal', editable ? 'true' : 'false');

  requestAnimationFrame(()=>{
    const rect = anchor.getBoundingClientRect();
    const popWidth = commentPopoverEl.offsetWidth;
    const popHeight = commentPopoverEl.offsetHeight;
    let left = rect.left + window.scrollX + (rect.width/2) - (popWidth/2);
    const minLeft = window.scrollX + 12;
    const maxLeft = window.scrollX + window.innerWidth - popWidth - 12;
    if(left < minLeft) left = minLeft;
    if(left > maxLeft) left = maxLeft;
    let top = rect.bottom + window.scrollY + 8;
    const maxTop = window.scrollY + window.innerHeight - popHeight - 12;
    if(top > maxTop){
      top = rect.top + window.scrollY - popHeight - 8;
      if(top < window.scrollY + 12) top = window.scrollY + 12;
    }
    commentPopoverEl.style.left = `${left}px`;
    commentPopoverEl.style.top = `${top}px`;
  });

  if(editable){
    const textarea = commentPopoverEl.querySelector('#commentInput');
    if(textarea){
      textarea.value = comment || '';
      textarea.focus();
    }
    const saveBtn = commentPopoverEl.querySelector('[data-action="save"]');
    if(saveBtn){
      saveBtn.addEventListener('click', async ()=>{
        if(!textarea) return;
        const raw = textarea.value;
        const trimmed = raw.trim();
        const payload = { coment: trimmed === '' ? null : raw };
        try{
          await savePlanEntry(resp, fecha, payload);
          rpStatus.textContent = trimmed === '' ? 'Comentario eliminado ‚úì' : 'Comentario guardado ‚úì';
          closeCommentPopover();
          await runReport();
        }catch(err){
          console.error(err);
          rpStatus.textContent = 'Error al guardar comentario';
        }
      });
    }
    const cancelBtn = commentPopoverEl.querySelector('[data-action="cancel"]');
    if(cancelBtn) cancelBtn.addEventListener('click', closeCommentPopover);
    const deleteBtn = commentPopoverEl.querySelector('[data-action="delete"]');
    if(deleteBtn){
      deleteBtn.addEventListener('click', async ()=>{
        try{
          await savePlanEntry(resp, fecha, { coment: null });
          rpStatus.textContent = 'Comentario eliminado ‚úì';
          closeCommentPopover();
          await runReport();
        }catch(err){
          console.error(err);
          rpStatus.textContent = 'Error al eliminar comentario';
        }
      });
    }
  }else{
    const closeBtn = commentPopoverEl.querySelector('[data-action="close"]');
    if(closeBtn) closeBtn.addEventListener('click', closeCommentPopover);
  }

  document.addEventListener('mousedown', handleCommentOutside);
  document.addEventListener('keydown', handleCommentEscape);
}

function scrollReportToToday(idx){
  if(idx == null || idx < 0) return;
  if(!rpTableWrap) return;
  requestAnimationFrame(()=>{
    const headerRow = rpTable.querySelector('tr');
    if(!headerRow) return;
    const target = headerRow.querySelector(`th:nth-child(${idx + 3})`);
    if(!target) return;
    const desired = target.offsetLeft - (rpTableWrap.clientWidth/2) + (target.offsetWidth/2);
    const left = desired < 0 ? 0 : desired;
    rpTableWrap.scrollTo({ left, behavior: 'smooth' });
  });
}

// Tabla 'plan_pred' (responsable, fecha, valor)
async function fetchPlan(start, end){
  const { data, error } = await client.from("plan_pred")
    .select("responsable,fecha,valor,coment")
    .gte("fecha", start).lte("fecha", end);
  if(error){ console.warn("plan_pred:", error.message); return []; }
  return data||[];
}
async function savePlanEntry(resp, fecha, patch = {}){
  const dow = parseYmd(fecha).getDay(); // 0=Dom,6=Sab
  const hasValor = Object.prototype.hasOwnProperty.call(patch, "valor");
  if(hasValor && (dow===0 || dow===6)) return; // valores solo L-V

  const payload = { responsable: resp, fecha, ...patch };
  if(!hasValor){
    const current = window._rp_planCounts?.[resp]?.[fecha];
    if(typeof current === "number") payload.valor = current;
  }else{
    payload.valor = Number(payload.valor)||0;
  }

  const { error } = await client.from("plan_pred")
    .upsert(payload, { onConflict: "responsable,fecha" });
  if(error) throw error;
}

async function runReport(){
  const start = rpStart.value, end = rpEnd.value;
  if(!start || !end){ alert("Selecciona fechas"); return; }
  const allowed = selectedResp(); // vac√≠o => todos

  rpStatus.textContent = "Cargando‚Ä¶";
  closeCommentPopover();
  rpDetail.style.display = "none"; rpDetail.innerHTML = "";

  const year = parseYmd(start).getFullYear();
  const generalStart = `${year}-09-01`;
  const generalEnd = `${year}-10-31`;

  const [rangeResp, generalResp, planRows, planRowsGeneral] = await Promise.all([
    client
      .from("cod_pred")
      .select("unir,cod_prel,codigo_mtc,comunidad,responsable,fecha_elab")
      .not("fecha_elab","is",null)
      .gte("fecha_elab", start)
      .lte("fecha_elab", end),
    client
      .from("cod_pred")
      .select("unir,cod_prel,codigo_mtc,comunidad,responsable,fecha_elab")
      .not("fecha_elab","is",null)
      .gte("fecha_elab", generalStart)
      .lte("fecha_elab", generalEnd),
    fetchPlan(start, end),
    fetchPlan(generalStart, generalEnd)
  ]);

  if(rangeResp.error){ rpStatus.textContent = "Error: "+rangeResp.error.message; return; }
  if(generalResp.error){ console.warn("cod_pred (general):", generalResp.error.message); }

  const groups = buildGroupsMap(rangeResp.data||[], allowed);
  const generalGroups = buildGroupsMap(generalResp.data||[], allowed);

  // D√≠as del rango
  const dFrom = parseYmd(start), dTo = parseYmd(end);
  const days = buildDays(dFrom, dTo);
  const dKeys = days.map(dateKey);
  const dMeta = days.map(d => ({ key: ymdFromDateLocal(d), dow: d.getDay() })); // dow 0..6

  // Responsables activos
  const resps = [...new Set([...groups.values()].map(g=>g.responsable))].filter(Boolean).sort();

  // Contadores: elaborado por d√≠a (por UNIR), plan desde plan_pred
  const doneCounts = {}; const planCounts = {}; const planComments = {};
  resps.forEach(r=>{
    doneCounts[r] = Object.fromEntries(dKeys.map(k=>[k,0]));
    planCounts[r] = Object.fromEntries(dKeys.map(k=>[k,0]));
    planComments[r] = Object.fromEntries(dKeys.map(k=>[k,null]));
  });

  // Mapa de celdas para detalle
  const cellMapDone = new Map(); // `${resp}|${day}` -> array de grupos {comunidad,codigo_mtc,unirId,cods[]}

  // Llenar 'done' (uno por UNIR)
  groups.forEach(g=>{
    const r = g.responsable; const k = g.fecha;
    if(!r || !k || !(k in (doneCounts[r]||{}))) return;
    doneCounts[r][k] += 1;
    const ck = `${r}|${k}`; if(!cellMapDone.has(ck)) cellMapDone.set(ck, []);
    cellMapDone.get(ck).push({ comunidad: g.comunidad, codigo_mtc: g.codigo_mtc, unirId: g.unirId, cods: g.cods });
  });

  // Traer planificado y volcar al mapa
  (planRows||[]).forEach(p=>{
    const r = normResp(p.responsable);
    const k = (p.fecha||"").toString().slice(0,10);
    if(resps.includes(r) && dKeys.includes(k)){
      planCounts[r][k] = Number(p.valor)||0;
      planComments[r][k] = p.coment || null;
    }
  });

  window._rp_planCounts = planCounts;
  window._rp_planComments = planComments;

  const todayKey = dateKey(new Date());

  const planDaily = dMeta.map(({key}) => resps.reduce((acc,r)=> acc + (planCounts[r]?.[key]||0), 0));
  const doneDaily = dMeta.map(({key}) => resps.reduce((acc,r)=> acc + (doneCounts[r]?.[key]||0), 0));

  const todayIdxRaw = dKeys.indexOf(todayKey);
  let todayIdx = todayIdxRaw;
  if(todayIdx === -1){
    todayIdx = -1;
    dKeys.forEach((k,i)=>{ if(k<=todayKey) todayIdx = i; });
  }

  const planToToday = todayIdx >=0 ? planDaily.slice(0, todayIdx+1).reduce((acc,v)=>acc+v,0) : 0;
  const doneToToday = todayIdx >=0 ? doneDaily.slice(0, todayIdx+1).reduce((acc,v)=>acc+v,0) : 0;
  const todayPct = planToToday ? Math.round((doneToToday/planToToday)*100) : 0;

  const cutoffKey = todayIdx >=0 ? dKeys[todayIdx] : (todayKey < start ? start : end);
  let cutoffSuffix = '';
  if(todayIdx === -1 && todayKey < start){ cutoffSuffix = ' (hoy antes del rango)'; }
  else if(dKeys.length && todayIdx === dKeys.length-1 && todayKey > end){ cutoffSuffix = ' (hoy despu√©s del rango)'; }

  const lastIdxForLeader = todayIdx >=0 ? todayIdx : (todayKey < start ? -1 : dMeta.length - 1);
  const leaders = resps.map(r=>{
    let planAcc = 0, doneAcc = 0;
    if(lastIdxForLeader >= 0){
      for(let i=0; i<=lastIdxForLeader; i++){
        const key = dMeta[i].key;
        planAcc += planCounts[r][key] || 0;
        doneAcc += doneCounts[r][key] || 0;
      }
    }
    const pct = planAcc ? Math.round((doneAcc/planAcc)*100) : (doneAcc>0 ? 100 : 0);
    return { name: cap(r), plan: planAcc, done: doneAcc, pct };
  }).sort((a,b)=> b.done - a.done);

  const generalPlanTotal = (planRowsGeneral||[]).reduce((acc,p)=>{
    const resp = normResp(p.responsable);
    if(allowed.size && !allowed.has(resp)) return acc;
    return acc + (Number(p.valor)||0);
  }, 0);
  const generalDoneTotal = generalGroups.size;
  const generalPct = generalPlanTotal ? Math.round((generalDoneTotal/generalPlanTotal)*100) : 0;

  renderHeaderKpis({
    generalPlan: generalPlanTotal,
    generalDone: generalDoneTotal,
    generalPct,
    generalRange: `${generalStart} ‚Üí ${generalEnd}`,
    todayPlan: planToToday,
    todayDone: doneToToday,
    todayPct,
    todayRange: `${start} ‚Üí ${cutoffKey}${cutoffSuffix}`,
    leaders
  });

  // Render tabla
  let html = "<tr>";
  html += `<th class="sticky l1">RESPONSABLE</th>`;
  html += `<th class="sticky l2">TIPO</th>`;
  dMeta.forEach(({key,dow})=>{
    const d = parseYmd(key);
    const clsBase = dow===0 ? "col-sun" : (dow===6 ? "col-sat" : "");
    const clsToday = key===todayKey ? "today-col" : "";
    const cls = `${clsBase} ${clsToday}`.trim();
    html += `<th class="${cls}">${String(d.getDate()).padStart(2,'0')}<div class="muted">${["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"][dow]}</div></th>`;
  });
  html += `<th>Total</th></tr>`;

  resps.forEach(r=>{
    const respLabel = esc(cap(r));
    const commentCols = new Map();

    // Fila planificado
    let rowPlan = 0;
    html += `<tr class="plan-row">`;
    html += `<td class="sticky l1" rowspan="2"><div class="resp-cell">${respLabel}</div></td>`;
    html += `<td class="sticky l2 type-cell">Planificado</td>`;
    dMeta.forEach(({key,dow})=>{
      const val = planCounts[r][key] || 0; rowPlan += val;
      const comment = planComments[r][key] || "";
      const trimmed = comment.trim().toLowerCase();
      const isBajada = trimmed === "bajada";
      const hasComment = !!comment;
      if(hasComment) commentCols.set(key, { isBajada });
      const classes = [
        dow===0 ? "col-sun" : (dow===6 ? "col-sat" : ""),
        key===todayKey ? "today-col" : "",
        hasComment ? `comment-cell${isBajada ? " comment-bajada" : ""}` : ""
      ].filter(Boolean).join(" ");
      if(rpEditMode){
        const disabled = (dow===0 || dow===6) ? "disabled" : "";
        const btnCls = `comment-btn${hasComment ? " has-comment" : ""}`;
        html += `<td class="${classes}">
          <div class="plan-cell">
            <input class="ovr-input" data-resp="${r}" data-date="${key}" type="number" min="0" value="${val}" ${disabled}>
            <button type="button" class="${btnCls}" data-resp="${r}" data-date="${key}" aria-label="${esc(hasComment ? 'Editar comentario' : 'Agregar comentario')}"><span class="comment-icon">üí¨</span></button>
          </div>
        </td>`;
      }else{
        const btnHtml = hasComment ? `<button type="button" class="comment-btn has-comment" data-resp="${r}" data-date="${key}" aria-label="Ver comentario"><span class="comment-icon">üí¨</span></button>` : "";
        html += `<td class="${classes}">
          <div class="plan-cell readonly"><span class="value">${val}</span>${btnHtml}</div>
        </td>`;
      }
    });
    html += `<td><b>${rowPlan}</b></td>`;
    html += `</tr>`;

    // Fila elaborado
    let rowDone = 0;
    html += `<tr class="done-row">`;
    html += `<td class="sticky l2 type-cell">Elaborado</td>`;
    dMeta.forEach(({key,dow})=>{
      const n = doneCounts[r][key] || 0; rowDone += n;
      const commentMeta = commentCols.get(key);
      const hasComment = !!commentMeta;
      const isBajada = commentMeta?.isBajada;
      const classes = [
        dow===0 ? "col-sun" : (dow===6 ? "col-sat" : ""),
        key===todayKey ? "today-col" : "",
        hasComment ? `comment-cell comment-linked${isBajada ? " comment-bajada" : ""}` : ""
      ].filter(Boolean).join(" ");
      if(n>0){
        html += `<td class="${classes} clickable" onclick="openRpCell('${r}','${key}')"><b>${n}</b></td>`;
      }else{
        html += `<td class="${classes} muted">0</td>`;
      }
    });
    html += `<td><b>${rowDone}</b></td>`;
    html += `</tr>`;
  });

  rpTable.innerHTML = html;

  // Mantener fija la columna de responsables: no centrar autom√°ticamente en la columna de hoy
  // scrollReportToToday(todayIdx);

  // Guardado inline
  rpTable.querySelectorAll(".ovr-input:not([disabled])").forEach(inp=>{
    inp.addEventListener("change", async (e)=>{
      const resp = e.target.getAttribute("data-resp");
      const fecha = e.target.getAttribute("data-date");
      const valor = Number(e.target.value)||0;
      try{
        await savePlanEntry(resp, fecha, { valor });
        rpStatus.textContent = "Planificado guardado ‚úì";
        await runReport();
      }catch(err){
        console.error(err);
        rpStatus.textContent = "Error al guardar planificado";
      }
    });
  });

  // Comentarios
  rpTable.querySelectorAll(".comment-btn").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      e.stopPropagation();
      const resp = btn.getAttribute("data-resp");
      const fecha = btn.getAttribute("data-date");
      const current = window._rp_planComments?.[resp]?.[fecha] || "";
      openCommentPopover({ resp, fecha, anchor: btn, comment: current, editable: rpEditMode });
    });
  });

  // Gr√°fico curva S (acumulados)
  const labels = dMeta.map(({key})=>{
    const d = parseYmd(key); return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
  });
  const planCum = [];
  planDaily.reduce((acc,v)=>{ const next=acc+v; planCum.push(next); return next; },0);

  const doneCum = [];
  doneDaily.reduce((acc,v,idx)=>{
    if(todayIdx>=0 && idx>todayIdx){ doneCum.push(null); return acc; }
    const next = acc+v; doneCum.push(next); return next;
  },0);

  renderReportCurve(labels, planCum, doneCum, todayIdx);

  // Exponer mapa para detalle
  window._rp_cellMapDone = cellMapDone;

  rpStatus.textContent = "Listo.";
}

function buildGroupsMap(rows, allowed = new Set()){
  const map = new Map();
  (rows||[]).forEach(r=>{
    const resp = normResp(r?.responsable);
    if(!resp) return;
    if(allowed.size && !allowed.has(resp)) return;
    const key = r?.unir;
    if(key == null) return;
    if(!map.has(key)){
      map.set(key, {
        responsable: resp,
        fecha: (r.fecha_elab||"").toString().slice(0,10),
        comunidad: r.comunidad || "",
        codigo_mtc: r.codigo_mtc || "",
        unirId: key,
        cods: []
      });
    }
    map.get(key).cods.push(r.cod_prel || "");
  });
  return map;
}

function renderHeaderKpis({ generalPlan, generalDone, generalPct, generalRange, todayPlan, todayDone, todayPct, todayRange, leaders }){
  const fmt = (n) => numberFormatter.format(Math.round(n || 0));
  const setText = (id, val) => {
    const el = document.getElementById(id);
    if(el) el.textContent = val;
  };

  setText('kpiGeneralPlan', fmt(generalPlan));
  setText('kpiGeneralDone', fmt(generalDone));
  setText('kpiGeneralPct', `${Math.round(generalPct||0)}%`);
  setText('kpiGeneralPlanRange', generalRange);
  setText('kpiGeneralDoneRange', generalRange);

  setText('kpiTodayPlan', fmt(todayPlan));
  setText('kpiTodayDone', fmt(todayDone));
  setText('kpiTodayPct', `${Math.round(todayPct||0)}%`);
  setText('kpiTodayRange', todayRange);

  const listEl = document.getElementById('kpiLeaderList');
  if(!listEl) return;
  if(!leaders || leaders.length === 0){
    listEl.innerHTML = '<div class="muted">Sin responsables en el rango.</div>';
    return;
  }

  listEl.innerHTML = leaders.map(l => `
    <div class="leader-item">
      <span class="leader-name">${esc(l.name)}</span>
      <span class="leader-meta">
        <span class="badge">${fmt(l.done)}${l.plan>0 ? ' / ' + fmt(l.plan) : ''}</span>
        <span>${Math.round(l.pct||0)}%</span>
      </span>
    </div>
  `).join('');
}

// Detalle de una celda (lista de grupos UNIR con sus c√≥digos clicables)
window.openRpCell = function(resp, ymd){
  const list = (window._rp_cellMapDone?.get(`${resp}|${ymd}`)) || [];
  const rows = list.map(g=>{
    const codes = g.cods.map(c=>`<button class="code-link" data-code="${esc(c)}" data-unir="${g.unirId}">${esc(c)}</button>`).join("");
    return `
      <tr>
        <td>${esc(g.comunidad)}</td>
        <td>${esc(g.codigo_mtc)}</td>
        <td style="text-align:left">${codes}</td>
      </tr>`;
  }).join("");
  rpDetail.innerHTML = `
    <div class="label">Detalle ‚Äî ${cap(resp)} ‚Äî ${ymd}</div>
    <div style="overflow:auto"><table class="report" style="width:100%">
      <thead><tr><th>Comunidad</th><th>C√≥digo MTC</th><th>cod_prel (grupo UNIR)</th></tr></thead>
      <tbody>${rows || `<tr><td colspan="3" class="muted">Sin grupos</td></tr>`}</tbody>
    </table></div>`;
  rpDetail.style.display = "block";
};

// Click en c√≥digo de detalle => seleccionar en mapa + panel
rpDetail.addEventListener("click", async (e)=>{
  const btn = e.target.closest(".code-link");
  if(!btn) return;
  const cod = btn.dataset.code;
  const unir = btn.dataset.unir;
  await selectFromReport(unir, cod);
});

async function selectFromReport(unir, cod){
  await showGroup(Number(unir));
  selectedCodPrel = cod;
  focusByCodPrel(cod);
  highlightGroup(Number(unir), false);
  // Resaltar tarjeta del √°rea
  const card = Array.from(listAreas.querySelectorAll(".area-card")).find(el => el.getAttribute("data-cod") === cod);
  if(card){
    card.classList.add("flash");
    card.scrollIntoView({ behavior:"smooth", block:"center" });
    setTimeout(()=> card.classList.remove("flash"), 1200);
  }
}

const TodayLinePlugin = {
  id:'todayLine',
  afterDatasetsDraw(chart, args, opts){
    const idx = opts?.index;
    if(idx == null || idx < 0) return;
    const {ctx, chartArea, scales} = chart;
    if(!chartArea || !scales?.x) return;
    const x = scales.x.getPixelForValue(idx);
    ctx.save();
    ctx.strokeStyle = 'rgba(99,102,241,.6)';
    ctx.setLineDash([4,4]);
    ctx.beginPath();
    ctx.moveTo(x, chartArea.top);
    ctx.lineTo(x, chartArea.bottom);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#312e81';
    ctx.font = '12px system-ui, sans-serif';
    ctx.fillText('Hoy', x + 6, chartArea.top + 14);
    ctx.restore();
  }
};
let todayPluginRegistered = false;

function renderReportCurve(labels, planCum, doneCum, todayIdx){
  document.getElementById("chartWrap").style.display = "block";
  const ctx = document.getElementById("rp_chart").getContext("2d");
  if(rpChart) rpChart.destroy();
  if(!todayPluginRegistered){ Chart.register(TodayLinePlugin); todayPluginRegistered = true; }
  rpChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Planificado acumulado',
          data: planCum,
          tension: 0.3,
          borderColor: '#0ea5e9',
          backgroundColor: 'rgba(14,165,233,.12)',
          fill: false,
          pointRadius: 3
        },
        {
          label: 'Elaborado acumulado',
          data: doneCum,
          tension: 0.3,
          borderColor: '#22c55e',
          backgroundColor: 'rgba(34,197,94,.12)',
          fill: false,
          pointRadius: 3,
          spanGaps: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        tooltip: { enabled: true },
        todayLine: { index: todayIdx }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      }
    }
  });
}

function esc(s){ return (s??"").toString().replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function cap(r){ return (r||"").replace(/\b\w/g,m=>m.toUpperCase()); }
function normResp(v){ return (v??"").toString().trim().toLowerCase(); }

/** ====== RESIZER ====== **/
(function initGutter(){
  const left = document.getElementById("leftPane");
  const gutter = document.getElementById("gutter");
  let dragging=false, startX=0, startLeft=0;
  gutter.addEventListener("mousedown",(e)=>{
    dragging=true; startX=e.clientX; startLeft=left.getBoundingClientRect().width;
    document.body.style.userSelect="none";
  });
  window.addEventListener("mousemove",(e)=>{
    if(!dragging) return;
    const dx = e.clientX - startX;
    const newW = Math.max(280, Math.min(window.innerWidth-280, startLeft + dx));
    const percent = (newW / window.innerWidth) * 100;
    left.style.flexBasis = percent + "%";
    setTimeout(()=> map.invalidateSize(), 0);
  });
  window.addEventListener("mouseup",()=>{ dragging=false; document.body.style.userSelect=""; });
})();

/** ====== INIT ====== **/
(async function init(){
  await hydrateFilterOptions();
  await fetchResponsables();
  await loadAllPredios();
})();
</script>
</body>
</html>
